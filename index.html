<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marshall WBCI — Crash Risk Composite</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --panel:#111c27; --ink:#e6eefc; --muted:#9fb0c8; --edge:#1b2a3d;
    --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --brand:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0e1623,#0b1320);color:var(--ink);font:500 15px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:22px 16px}
  h1{margin:0 0 12px;font-size:clamp(22px,3.6vw,34px)}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
  .panel{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:14px;box-shadow:0 4px 24px rgba(0,0,0,.25)}
  input,select,button{font:inherit}
  input[type=text],select{background:#0b1520;border:1px solid #1f2a3a;color:var(--ink);padding:10px 12px;border-radius:12px}
  input[type=text]{min-width:320px}
  button{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:11px 16px;font-weight:800;cursor:pointer}
  button.secondary{background:#1f2b3a;color:#cfe3ff;border:1px solid #284058}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){.grid{grid-template-columns:1.1fr 2fr}}
  .ring{width:150px;height:150px;border-radius:50%;display:grid;place-items:center;background:
    conic-gradient(var(--ringClr) var(--ringDeg), #1a2636 0);position:relative}
  .ring::before{content:"";position:absolute;inset:10px;border-radius:50%;background:#0a141e;border:1px solid #20304a}
  .ring .num{position:relative;font-weight:800;font-size:34px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#172535;border:1px solid #253a51;border-radius:999px;color:#cfe0f3;padding:6px 10px;font-weight:700;font-size:13px}
  .small{color:var(--muted);font-size:13px}
  .cards{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){.cards{grid-template-columns:1fr 1fr}}
  .card{background:#0b1621;border:1px solid #1b2a3c;border-radius:14px;padding:12px}
  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .badge{background:#0c1928;border:1px solid #23364d;color:#d0e1f5;padding:4px 10px;border-radius:999px;font-weight:800}
  .meta{display:grid;grid-template-columns:1fr;gap:12px}
  .kv{display:flex;gap:8px;flex-wrap:wrap}
  .err{color:#ffb4c2}
  .foot{margin-top:14px;color:#a7b9d2;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>Marshall WBCI — Crash Risk Composite</h1>

  <div class="bar panel">
    <span class="small">FRED key is hard‑coded.</span>
    <select id="mode">
      <option value="advanced" selected>Advanced (predictive tilt)</option>
      <option value="equal">Equal weighting</option>
    </select>
    <button id="run">Run / Refresh</button>
    <button id="clear" class="secondary">Reset Cache</button>
    <span id="status" class="small" style="margin-left:auto">Ready</span>
  </div>

  <div class="grid">
    <div class="panel">
      <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
        <div class="ring" id="ring" style="--ringClr:#22c55e;--ringDeg:0deg"><div class="num" id="wbciNum">--</div></div>
        <div class="meta">
          <div class="chips">
            <span class="chip" id="bandChip">Band: —</span>
            <span class="chip" id="breadthChip">Breadth: —</span>
            <span class="chip" id="syncChip">Synchronicity: —</span>
            <span class="chip" id="shockChip">Shock: —</span>
          </div>
          <div id="expl" class="small">Composite = weighted average of category risk percentiles vs each series’ own last decade (we invert “good‑high” series so higher always means riskier).</div>
          <div id="stamp" class="small">—</div>
          <div id="error" class="err"></div>
        </div>
      </div>
    </div>

    <div class="panel" id="summaryPanel">
      <h2 style="margin:0 0 6px">Executive Summary</h2>
      <div id="summary" style="line-height:1.6">Press “Run / Refresh”. We’ll fetch the latest data and explain it clearly.</div>
    </div>
  </div>

  <div class="panel">
    <h2 style="margin:0 0 6px">Categories</h2>
    <div id="cards" class="cards"></div>
  </div>

  <div class="foot">Marshall WBCI • Live FRED data • Deterministic daily cache</div>
</div>

<script>
/* ---------- Hard-code your FRED API key here ---------- */
const FRED_API_KEY = "YOUR_FRED_KEY_HERE"; // ← replace with your real key once, save file

/* ---------- Category & series setup ---------- */
const CATS = [
  { key:'rates', name:'Rates / Curve', weight:1.3, why:'Tight/inverted curves + high long rates raise crash risk via refinancing and valuation pressure.',
    series:[
      {id:'DGS10',     label:'10Y Treasury yield (%, daily)',     invert:false, fmt:v=>v.toFixed(2)+'%'},
      {id:'T10Y2Y',    label:'10Y–2Y spread (pp, daily)',         invert:true,  fmt:v=>v.toFixed(2)},
      {id:'T10Y3M',    label:'10Y–3M spread (pp, daily)',         invert:true,  fmt:v=>v.toFixed(2)}
    ]},
  { key:'credit', name:'Credit / Stress', weight:1.3, why:'Credit spreads & systemic stress often lead equity drawdowns.',
    series:[
      {id:'BAMLH0A0HYM2', label:'HY OAS (%, daily)',              invert:false, fmt:v=>v.toFixed(2)+'%'},
      {id:'STLFSI4',      label:'St. Louis FSI v4 (weekly)',      invert:false, fmt:v=>v.toFixed(2)}
    ]},
  { key:'liquidity', name:'Liquidity', weight:1.0, why:'When depth/liquidity fade, sell‑offs accelerate.',
    series:[
      {id:'RRPONTSYD', label:'Fed ON RRP ($bn, daily)',           invert:false, fmt:v=>v.toFixed(0)+'B'},
      {id:'WALCL',     label:'Fed balance sheet ($bn, weekly)',   invert:true,  fmt:v=>v.toFixed(0)+'B', scale:1e-3}
    ]},
  { key:'usd', name:'USD / External', weight:1.1, why:'A stronger USD tightens global conditions and can trigger funding squeezes.',
    series:[ {id:'DTWEXBGS', label:'Trade‑weighted USD (weekly)', invert:false, fmt:v=>v.toFixed(1)} ]},
  { key:'energy', name:'Energy Shock', weight:1.0, why:'Energy‑burden spikes often precede recessions and earnings downgrades.',
    series:[ {id:'DCOILWTICO', label:'WTI crude (YoY %, daily)',  invert:false, fmt:v=>v.toFixed(1)+'%', derived:'yoy'} ]},
  { key:'labor', name:'Labor / Household', weight:1.1, why:'Rising claims/unemployment erode the household buffer.',
    series:[
      {id:'UNRATE', label:'Unemployment rate (%, monthly)',       invert:false, fmt:v=>v.toFixed(1)+'%'},
      {id:'ICSA',   label:'Initial claims (k, weekly)',           invert:false, fmt:v=>v.toFixed(0), scale:1e-3}
    ]},
  { key:'infl', name:'Inflation', weight:1.1, why:'Higher inflation keeps policy restrictive and squeezes real incomes.',
    series:[
      {id:'CPIAUCSL',  label:'CPI (YoY %, monthly)',              invert:false, fmt:v=>v.toFixed(1)+'%', derived:'yoy'},
      {id:'CPILFESL',  label:'Core CPI (YoY %, monthly)',         invert:false, fmt:v=>v.toFixed(1)+'%', derived:'yoy'}
    ]},
  { key:'activity', name:'Activity / Sentiment', weight:1.0, why:'Softening activity & confidence raise vulnerability to shocks.',
    series:[
      {id:'INDPRO',    label:'Industrial production (YoY %, m/m)',invert:false, fmt:v=>v.toFixed(1)+'%', derived:'yoy'},
      {id:'RSAFS',     label:'Retail sales (YoY %, monthly)',     invert:false, fmt:v=>v.toFixed(1)+'%', derived:'yoy'},
      {id:'UMCSENT',   label:'UMich sentiment (index, monthly)',  invert:true,  fmt:v=>v.toFixed(1)}
    ]}
];

/* ---------- UI helpers ---------- */
const $ = s => document.querySelector(s);
const clamp = (x,a=0,b=100)=>Math.max(a,Math.min(b,x));
const bandOf = s => s==null?{n:'—',c:'#64748b'} : s<40?{n:'Green',c:getComputedStyle(document.documentElement).getPropertyValue('--green').trim()} : s<70?{n:'Amber',c:getComputedStyle(document.documentElement).getPropertyValue('--amber').trim()} : {n:'Red',c:getComputedStyle(document.documentElement).getPropertyValue('--red').trim()};
const dayKey = ()=> new Date().toISOString().slice(0,10);

/* ---------- Cache ---------- */
const CACHE = {
  get(k){ try{const v=JSON.parse(localStorage.getItem(k)||'null'); if(!v) return null; if(Date.now()-v.t>6*60*60*1000) return null; return v.d;}catch{return null} },
  set(k,d){ try{localStorage.setItem(k,JSON.stringify({t:Date.now(),d}))}catch{} },
  clear(){ Object.keys(localStorage).forEach(k=>{ if(k.startsWith('WBCI_')) localStorage.removeItem(k); }); }
};

/* ---------- FRED fetch & transform ---------- */
async function fetchFRED(series_id){
  if(!FRED_API_KEY) throw new Error('Missing hard‑coded FRED key. Edit index.html.');
  const start = new Date(); start.setFullYear(start.getFullYear()-10); start.setDate(1);
  const qs = `series_id=${series_id}&api_key=${FRED_API_KEY}&file_type=json&observation_start=${start.toISOString().slice(0,10)}`;
  const url = `https://api.stlouisfed.org/fred/series/observations?${qs}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`${series_id} HTTP ${res.status}`);
  const json = await res.json();
  if(!json || !json.observations) throw new Error(`${series_id} bad payload`);
  return json.observations
    .map(o=>({t:o.date, v: (o.value==='.'? null: +o.value)}))
    .filter(p=>p.v!=null);
}

function toMonthlyLast(points){
  // keep last value per month (handles mixed frequency)
  const map = new Map();
  for(const p of points){
    const d = new Date(p.t);
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    map.set(k, p.v);
  }
  return [...map.entries()].sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>({t:`${k}-01`, v}));
}

function yoy(points){
  // YoY % using monthly data
  const m = toMonthlyLast(points);
  const out=[];
  for(let i=12;i<m.length;i++){
    const prev = m[i-12].v, cur = m[i].v;
    if(prev==null || prev===0 || cur==null){ out.push({t:m[i].t, v:null}); continue; }
    out.push({t:m[i].t, v: 100*(cur-prev)/prev});
  }
  return out.filter(p=>p.v!=null);
}

function seriesPercentiles(points, invert){
  const vals = points.map(p=>p.v).filter(Number.isFinite);
  if(!vals.length) return {latest:null, series:[]};
  const sorted = [...vals].sort((a,b)=>a-b);
  const pr = v => {
    let lo=0, hi=sorted.length-1, idx=-1;
    while(lo<=hi){ const mid=(lo+hi)>>1; if(sorted[mid]<=v){ idx=mid; lo=mid+1 } else hi=mid-1; }
    const pct = Math.round(100*(idx+1)/sorted.length);
    return invert ? 100-pct : pct;
  };
  const ser = points.map(p=>({t:p.t, s: clamp(pr(p.v))}));
  const latest = ser.at(-1)?.s ?? null;
  return {latest, series: ser};
}

/* ---------- Chart rendering ---------- */
function sparkline(canvas, series, bandColor){
  // series: [{t, s}] 0..100
  const labels = series.map(p=>p.t.slice(0,10));
  const data   = series.map(p=>p.s);
  const c = new Chart(canvas.getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{
      label:'Risk percentile (0‑100)',
      data, borderColor: bandColor, backgroundColor: bandColor+'33', fill:true, tension:.25, pointRadius:0, borderWidth:2
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index', intersect:false},
      plugins:{ legend:{display:false}, tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}`}} },
      scales:{
        x:{ ticks:{color:'#c8d5ea', maxTicksLimit:6}, grid:{color:'rgba(255,255,255,0.06)'} },
        y:{ ticks:{color:'#c8d5ea'}, grid:{color:'rgba(255,255,255,0.06)'}, suggestedMin:0, suggestedMax:100 }
      }
    }
  });
  return c;
}

/* ---------- Category loader ---------- */
async function loadCategory(cfg){
  const catCacheKey = `WBCI_${cfg.key}_${dayKey()}`;
  const hit = CACHE.get(catCacheKey);
  if(hit) return hit;

  const series = [];
  for(const s of cfg.series){
    const raw = await fetchFRED(s.id);
    let pts = raw;
    if(s.scale) pts = pts.map(p=>({t:p.t, v:p.v * s.scale}));
    if(s.derived==='yoy') pts = yoy(pts);
    else if(['weekly','daily'].includes(s.freq)) { /* already dense; keep as is */ }
    else pts = toMonthlyLast(pts);
    const pct = seriesPercentiles(pts, s.invert===true);
    const latestRaw = pts.at(-1)?.v ?? null;
    const latestTs  = pts.at(-1)?.t ?? null;
    series.push({id:s.id, label:s.label, invert:!!s.invert, fmt:s.fmt, latest:latestRaw, latestTs, pctSeries:pct.series, score:pct.latest});
  }

  // combine series into category sparkline (avg per month)
  const months = [...new Set(series.flatMap(s=>s.pctSeries.map(p=>p.t)))].sort();
  const catSeries = months.map(t=>{
    const vals = series.map(s=> s.pctSeries.find(p=>p.t===t)?.s).filter(v=>v!=null);
    return {t, s: vals.length? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : null}
  }).filter(p=>p.s!=null);

  // category score (weighted mean across members, equal inside category)
  const memberScores = series.map(s=>s.score).filter(v=>v!=null);
  const catScore = memberScores.length? Math.round(memberScores.reduce((a,b)=>a+b,0)/memberScores.length) : null;

  const out = { key:cfg.key, name:cfg.name, why:cfg.why, weight:cfg.weight, series, catSeries, score:catScore };
  CACHE.set(catCacheKey, out);
  return out;
}

/* ---------- Composite metrics ---------- */
function computeMeta(cats){
  const valid = cats.filter(c=>c.score!=null);
  const mode = document.getElementById('mode').value;
  const weights = {};
  (mode==='advanced'?CATS:CATS.map(c=>({...c,weight:1}))).forEach(c=>weights[c.key]=c.weight);

  const wbci = valid.length? Math.round(valid.reduce((acc,c)=> acc + c.score*(weights[c.key]||1),0) /
                                      valid.reduce((acc,c)=> acc + (weights[c.key]||1),0)) : null;

  const breadth = Math.round(100 * valid.filter(c=>c.score>=60).length / (cats.length||1));

  // synchronicity: average positive pairwise correlation across last 12 points (0..100)
  const aligned = valid.map(c=> c.catSeries.slice(-12).map(p=>p.s));
  const cors=[];
  for(let i=0;i<aligned.length;i++){
    for(let j=i+1;j<aligned.length;j++){
      const a=aligned[i], b=aligned[j], m=Math.min(a.length,b.length);
      if(m<3) continue;
      const am=a.slice(-m), bm=b.slice(-m);
      const ma=am.reduce((x,y)=>x+y,0)/m, mb=bm.reduce((x,y)=>x+y,0)/m;
      let num=0,da=0,db=0;
      for(let k=0;k<m;k++){ const x=am[k]-ma, y=bm[k]-mb; num+=x*y; da+=x*x; db+=y*y; }
      const r = (da&&db)? num/Math.sqrt(da*db) : 0;
      cors.push(Math.max(0,r));
    }
  }
  const synch = cors.length? Math.round(100 * (cors.reduce((a,b)=>a+b,0)/cors.length)) : 0;

  // shock: mean absolute last step across categories
  const shock = Math.round(valid.map(c=>{
    const s=c.catSeries; if(s.length<2) return 0; return Math.abs(s.at(-1).s - s.at(-2).s);
  }).reduce((a,b)=>a+b,0) / (valid.length||1));

  return {wbci, breadth, synch, shock};
}

/* ---------- Summary (public‑friendly CIO style) ---------- */
function buildSummary(meta, cats){
  const b = bandOf(meta.wbci).n;
  const sorted = [...cats].sort((a,b)=> (b.score??-1)-(a.score??-1));
  const pressures = sorted.slice(0,3).map(c=>`${c.name} ${c.score}`);
  const cushions  = [...sorted].reverse().slice(0,2).map(c=>`${c.name} ${c.score}`);

  const read = (()=>{
    const parts=[];
    parts.push(meta.breadth<35 ? "Risk is concentrated in a few areas" : "Risk is spread across several areas");
    parts.push(meta.synch<35 ? "and signals are not moving together" : "and signals are moving together");
    parts.push(meta.shock<20 ? "with slow changes" : "with fast changes");
    return parts.join(", ") + ".";
  })();

  let stance='';
  if(meta.wbci<40) stance='Remain invested but be selective; prefer stronger balance sheets; hold light hedges.';
  else if(meta.wbci<70) stance='Neutral to cautious; keep dry powder; trim weaker cyclicals; maintain hedges.';
  else stance='Defensive; prioritize liquidity and capital preservation; consider tail‑risk protection.';

  const watch = [];
  const M = Object.fromEntries(cats.map(c=>[c.key,c.score||0]));
  if(M.rates>=60)   watch.push('long‑rate rises with the front end steady (curve steepening)');
  if(M.credit>=55)  watch.push('high‑yield spreads and stress indices widening');
  if(M.labor>=50)   watch.push('weekly jobless claims trending up');
  if(M.usd>=60)     watch.push('another leg higher in the USD');
  if(M.energy>=60)  watch.push('oil‑price spike (burden rising)');

  return [
    `<p><b>Crash Risk Composite (WBCI): ${meta.wbci} — ${b}.</b></p>`,
    `<p><b>What’s driving risk:</b> ${pressures.join(' · ') || '—'}.</p>`,
    `<p><b>What’s cushioning it:</b> ${cushions.join(' · ') || '—'}.</p>`,
    `<p><b>How to read it:</b> ${read}</p>`,
    `<p><b>Practical stance:</b> ${stance}</p>`,
    `<p><b>Watch next:</b> ${watch.length?watch.join('; '):'breadth and synchronicity — a broadening turn would lift risk.'}</p>`
  ].join('');
}

/* ---------- UI wiring ---------- */
function setGauge(score){
  const ring = document.getElementById('ring');
  const num  = document.getElementById('wbciNum');
  const b = bandOf(score);
  const deg = `${Math.max(0,Math.min(100,score))/100*360}deg`;
  ring.style.setProperty('--ringClr', b.c);
  ring.style.setProperty('--ringDeg', deg);
  num.textContent = Number.isFinite(score) ? score : '--';
  document.getElementById('bandChip').textContent = `Band: ${b.n}`;
}

function valueLine(s){ // build concise “latest values” line for a category
  const parts = s.series.map(x=>{
    if(x.latest==null) return `${x.label}: —`;
    return `${x.label.split(' (')[0]}: ${x.fmt?x.fmt(x.latest):x.latest}`;
  });
  return parts.join(' • ');
}

function cardHTML(c){
  return `
    <div class="card">
      <div class="head">
        <div style="font-weight:800">${c.name}</div>
        <div class="badge">${c.score??'—'}</div>
      </div>
      <div style="height:140px"><canvas id="cv_${c.key}"></canvas></div>
      <div class="small" style="margin-top:6px"><b>Latest:</b> ${valueLine(c)}</div>
      <div class="small"><b>Why it matters:</b> ${c.why}</div>
      <div class="small">Band: ${bandOf(c.score).n}</div>
    </div>
  `;
}

/* ---------- Main run ---------- */
async function run(){
  const status = document.getElementById('status');
  const errBox = document.getElementById('error');
  errBox.textContent='';
  status.textContent='Loading…';

  try{
    if(!FRED_API_KEY){ throw new Error('No hard‑coded FRED key. Open the file and set FRED_API_KEY.'); }

    const cacheKey = `WBCI_ALL_${dayKey()}_${document.getElementById('mode').value}`;
    const hit = CACHE.get(cacheKey);
    let cats;
    if(hit){ cats = hit; status.textContent='From cache'; }
    else{
      cats = [];
      for(const cfg of CATS){
        const c = await loadCategory(cfg);
        cats.push(c);
      }
      CACHE.set(cacheKey, cats);
      status.textContent='Live';
    }

    // render cards
    const cards = document.getElementById('cards');
    cards.innerHTML='';
    cats.forEach(c=> cards.insertAdjacentHTML('beforeend', cardHTML(c)));
    // charts
    cats.forEach(c=>{
      const ctx = document.getElementById(`cv_${c.key}`).getContext('2d');
      sparkline(ctx.canvas, c.catSeries.slice(-36), bandOf(c.score).c);
    });

    // compute meta and summary
    const meta = computeMeta(cats);
    setGauge(meta.wbci);
    document.getElementById('breadthChip').textContent = `Breadth: ${meta.breadth}%`;
    document.getElementById('syncChip').textContent    = `Synchronicity: ${meta.synch}%`;
    document.getElementById('shockChip').textContent   = `Shock: ${meta.shock}`;
    document.getElementById('stamp').textContent       = `Last run: ${new Date().toLocaleString()} • Mode: ${document.getElementById('mode').value}`;
    document.getElementById('summary').innerHTML       = buildSummary(meta, cats);
  }catch(e){
    console.error(e);
    errBox.textContent = `Error: ${e.message}`;
    status.textContent = 'Error';
  }
}

document.getElementById('run').addEventListener('click', run);
document.getElementById('clear').addEventListener('click', ()=>{ CACHE.clear(); document.getElementById('status').textContent='Cache cleared'; });

// Auto-run if key is set
if(FRED_API_KEY) { /* optional: run(); */ }
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The Marshall Stock Market Crash Composite Indicator</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/inter/variable.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
<style>
:root{--bg:#0e1621;--panel:#111c2b;--ink:#e6edf6;--muted:#9fb4d6;--blue:#3b82f6;--amber:#f5a524;--green:#19c37d;--red:#ef4444;--card:#0f1a29;--chip:#2a3b56;--grid:#1c2a3a;--ring:#263343}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"InterVariable","Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:16px}
h1{font-size:clamp(24px,4.8vw,38px);line-height:1.12;margin:20px 0 10px}
.row,.bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input,select,button{border-radius:12px;border:1px solid #203149;background:#0b1420;color:var(--ink);padding:12px 14px;font-size:16px}
.input{flex:1}
button.primary{background:linear-gradient(180deg,#4e8cff,#3975f5);border:none;font-weight:700}
.panel{background:var(--panel);border:1px solid #1b2a42;border-radius:16px;padding:16px;margin:14px 0}
.badge{display:inline-block;background:rgba(0,0,0,.25);border:1px solid #ffffff22;color:#ffe9b3;padding:8px 12px;border-radius:12px;font-weight:800;letter-spacing:.3px}
.sub{color:var(--muted);font-size:14px}
.grid{display:grid;gap:12px}
@media(min-width:700px){.grid.cols-2{grid-template-columns:1fr 1fr}}
@media(min-width:960px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr}}
.card{background:var(--card);border:1px solid #182841;border-radius:16px;padding:14px}
.card .hdr{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.chip{background:var(--chip);color:#cfe1ff;border-radius:999px;padding:4px 8px;font-size:12px}
.val{font-size:32px;font-weight:800;margin:2px 0}
.score{color:var(--muted);font-size:13px}
.gauge-wrap{display:flex;gap:16px;align-items:center}
svg text{font-variant-numeric:tabular-nums}
.help{font-size:13px;color:var(--muted);margin-top:6px}
.chart-wrap{background:var(--panel);border:1px solid #1b2a42;border-radius:16px;padding:12px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#1d2a3b;color:#fff;border:1px solid #334b6f;padding:10px 14px;border-radius:10px;font-size:14px;z-index:1000;display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>The Marshall Stock Market Crash Composite Indicator</h1>

  <div class="panel">
    <div class="bar">
      <input id="key" class="input" placeholder="Your FRED API key"/>
      <select id="weightMode">
        <option value="simple">Simple (equal)</option>
        <option value="basic">Basic (macro tilt)</option>
        <option value="advanced" selected>Advanced (predictive tilt)</option>
        <option value="custom">Custom</option>
      </select>
      <button id="run" class="primary">Run / Refresh</button>
    </div>
    <div id="customBlock" class="help" style="display:none">
      Custom weights (0–3): Yields <input id="wY" type="number" value="1.2" step="0.1" style="width:64px">
      • Credit <input id="wC" type="number" value="1.3" step="0.1" style="width:64px">
      • Activity <input id="wA" type="number" value="1.0" step="0.1" style="width:64px">
      • Prices <input id="wP" type="number" value="0.9" step="0.1" style="width:64px">
      • Sentiment/FX <input id="wS" type="number" value="0.8" step="0.1" style="width:64px">
    </div>
  </div>

  <div id="top" class="panel">
    <div class="gauge-wrap">
      <svg id="gauge" width="132" height="132" viewBox="0 0 100 100" aria-label="CRC gauge">
        <circle cx="50" cy="50" r="42" stroke="#263343" stroke-width="12" fill="none"/>
        <circle id="gArc" cx="50" cy="50" r="42" stroke="#f5a524" stroke-linecap="round"
                stroke-width="12" fill="none" stroke-dasharray="0 999"
                transform="rotate(-90 50 50)"/>
        <text id="gNum" x="50" y="56" text-anchor="middle" font-size="28" font-weight="700" fill="#e6edf6">--</text>
      </svg>
      <div>
        <div id="crcBadge" class="badge">CRC: --</div>
        <div id="runMeta" class="sub" style="margin-top:6px"></div>
        <div class="help">Composite = average of indicator percentiles vs last 10y (with sensible inverts).</div>
      </div>
    </div>
  </div>

  <div id="summary" class="panel">
    <h2 style="margin:0 0 8px">Executive Summary</h2>
    <div id="sumText" class="sub">Run the dashboard to generate an up‑to‑date analyst note.</div>
  </div>

  <div class="panel chart-wrap">
    <div class="bar" style="justify-content:space-between">
      <div style="font-weight:700">Interactive Chart</div>
      <select id="chartSel"></select>
    </div>
    <canvas id="chart" height="240"></canvas>
    <div class="help">Pinch to zoom • Drag (hold one finger + pan with second) • Double‑tap to reset.</div>
  </div>

  <div class="panel">
    <div style="font-weight:800;font-size:20px;margin-bottom:8px">Indicators</div>
    <div id="cards" class="grid cols-1"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* -------- Polyfill: Promise.any for older Safari -------- */
if(typeof Promise.any!=='function'){
  Promise.any = function(promises){
    return new Promise((resolve,reject)=>{
      let rejections=0, lastErr;
      promises.forEach(p=>Promise.resolve(p).then(resolve,e=>{rejections++;lastErr=e;if(rejections===promises.length) reject(lastErr)}));
    });
  }
}

/* --------------------------- Utilities & Cache --------------------------- */
const $=s=>document.querySelector(s);
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2600); }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } }
const mem=new Map(); const cacheGet=k=>mem.get(k); const cacheSet=(k,v)=>mem.set(k,v);
const RAG=v=>v<40?'GREEN':v>70?'RED':'AMBER';
const RAG_COLOR=b=>b==='GREEN'?'#19c37d':b==='RED'?'#ef4444':'#f5a524';
const fmt=n=> (Math.abs(n)>=1000 ? n.toLocaleString() : String(n));

/* ------------------------------ Catalog --------------------------------- */
const INDICATORS=[
  {cat:'Yields', id:'DGS10',  name:'10Y Treasury yield', fmt:v=>v.toFixed(2)+'%', invert:false,  desc:'Benchmark long rate; higher real financing costs.'},
  {cat:'Yields', id:'T10Y2Y', name:'10Y–2Y spread',      fmt:v=>v.toFixed(2)+'%', invert:true,   desc:'Curve slope; inversion/tightness → late‑cycle risk.'},
  {cat:'Yields', id:'T10Y3M', name:'10Y–3M spread',      fmt:v=>v.toFixed(2)+'%', invert:true,   desc:'Front‑end tightness; deep negatives precede recessions.'},
  {cat:'Credit', id:'BAMLH0A0HYM2', name:'ICE BofA HY OAS', fmt:v=>v.toFixed(2)+'%', invert:false, desc:'High‑yield spread; widening = credit stress.'},
  {cat:'Credit', id:'STLFSI4', name:'St. Louis Financial Stress (v4)', fmt:v=>v.toFixed(4), invert:false, desc:'Systemic stress; >0 tightens risk.'},
  {cat:'Credit', id:'NFCI',   name:'Chicago Fed Financial Conditions', fmt:v=>v.toFixed(5), invert:false, desc:'Funding & risk appetite; higher = tighter.'},
  {cat:'Market', id:'SP500',  name:'S&P 500 index', fmt:v=>fmt(v), displayOnly:true, desc:'Level context (display only, not scored).'},
  {cat:'Market', id:'VIXCLS', name:'VIX index', fmt:v=>v.toFixed(2)+'%', invert:false, desc:'Equity volatility; high = pricier crash insurance.'},
  {cat:'Labor',  id:'UNRATE', name:'Unemployment rate', fmt:v=>v.toFixed(2)+'%', invert:false, desc:'Labor slack; rising unemployment lifts drawdown odds.'},
  {cat:'Labor',  id:'ICSA',   name:'Initial jobless claims (wkly)', fmt:v=>fmt(v), invert:false, desc:'Early labor signal; rising claims precede slowdowns.'},
  {cat:'Prices', id:'CPIAUCSL', name:'CPI (headline)', fmt:v=>v.toFixed(3), invert:false, desc:'Inflation backdrop; higher keeps policy tighter.'},
  {cat:'Prices', id:'CPILFESL', name:'Core CPI', fmt:v=>v.toFixed(3), invert:false, desc:'Underlying inflation persistence.'},
  {cat:'Prices', id:'PCEPI',    name:'PCE prices', fmt:v=>v.toFixed(3), invert:false, desc:'Fed‑preferred inflation gauge.'},
  {cat:'Activity', id:'INDPRO', name:'Industrial production', fmt:v=>v.toFixed(3), invert:true, desc:'Real‑economy breadth; softness raises risk.'},
  {cat:'Activity', id:'TCU',    name:'Capacity utilization', fmt:v=>v.toFixed(3), invert:true, desc:'Slack vs overheating; low utilization = weak demand.'},
  {cat:'Activity', id:'RSAFS',  name:'Retail sales (advance)', fmt:v=>fmt(v), invert:true, desc:'Household demand; slowing trend = fragility.'},
  {cat:'Activity', id:'HOUST',  name:'Housing starts', fmt:v=>fmt(v), invert:true, desc:'Cyclical bellwether; weakness often leads downturns.'},
  {cat:'Activity', id:'PERMIT', name:'Building permits', fmt:v=>fmt(v), invert:true, desc:'Leading housing gauge; softness flags future activity.'},
  {cat:'Sentiment', id:'UMCSENT', name:'UMich consumer sentiment', fmt:v=>v.toFixed(1), invert:true, desc:'Household mood; weakness → slower spending.'},
  {cat:'FX', id:'DTWEXBGS', name:'Trade‑weighted USD (broad)', fmt:v=>v.toFixed(4), invert:false, desc:'Stronger USD tightens global financial conditions.'},
  {cat:'Valuation', id:'BUFFETT', name:'Buffett Ratio (Wilshire/GDP)', fmt:v=>v.toFixed(1)+'%', invert:false, synthetic:true, desc:'Market value vs GDP; higher = greater vulnerability.'}
];
const CHART_IDS=INDICATORS.map(d=>d.id);

/* ----------------------------- Fetch layer ------------------------------ */
async function fetchRace(url){
  const direct = fetch(url).then(r=>{ if(!r.ok) throw new Error('direct failed'); return r; });
  const codetabs = fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`);
  const allorigins = fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
  try{
    const r=await Promise.any([direct,codetabs,allorigins]);
    return await r.text();
  }catch(e){
    // final try sequentially to surface a real error body if any
    try{ const r=await direct; return await r.text(); }catch{}
    try{ const r=await codetabs; return await r.text(); }catch{}
    const r=await allorigins; return await r.text();
  }
}
async function fredSeries(id, key, limit=100000){
  const k=`FRED_${id}`; const c=cacheGet(k); if(c) return c;
  const url=`https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${key}&file_type=json&observation_start=1960-01-01&limit=${limit}`;
  const txt = await fetchRace(url);
  let json; try{ json=JSON.parse(txt); }catch(e){ throw new Error(`Bad JSON for ${id}`); }
  cacheSet(k,json); return json;
}
/* Buffett ratio (Wilshire/GDP), robust Wilshire fallback + monthly downsample */
async function tryWilshire(key){
  const C=['WILL5000IND','WILL5000PR','WILL5000INDFC','WILLLRGCAP'];
  for(const id of C){ try{ const j=await fredSeries(id,key); if(j?.observations?.length>100) return j; }catch{} }
  throw new Error('Wilshire series unavailable.');
}
async function buffettSeries(key){
  const cached=cacheGet('BUFF_V2'); if(cached) return cached;
  const w=await tryWilshire(key);
  const g=await fredSeries('GDP',key);
  const gQ=g.observations.map(o=>({date:o.date,value:+o.value})).filter(x=>Number.isFinite(x.value)).sort((a,b)=>a.date.localeCompare(b.date));
  let gi=0, cur=gQ[0]?.value;
  const daily=w.observations.map(o=>{
    const v=+o.value; if(!Number.isFinite(v)) return null;
    while(gi+1<gQ.length && gQ[gi+1].date<=o.date){gi++;cur=gQ[gi].value;}
    return cur?{date:o.date,value:(v/cur)*100}:null;
  }).filter(Boolean);
  const byM=new Map(); for(const x of daily){ byM.set(x.date.slice(0,7),x); }
  const series=[...byM.values()].sort((a,b)=>a.date.localeCompare(b.date));
  cacheSet('BUFF_V2', series); return series;
}

/* ------------------------------ Scoring --------------------------------- */
function pctileFromSeries(series, latestVal){
  const cut=new Date(); cut.setFullYear(cut.getFullYear()-10);
  const vals=series.filter(o=>new Date(o.date)>=cut && Number.isFinite(+o.value)).map(o=>+o.value).sort((a,b)=>a-b);
  if(!vals.length) return null;
  const rank = vals.filter(v=>v<=latestVal).length/vals.length;
  return Math.round(rank*100);
}
function bandScore(p, invert){ return invert ? (100-p) : p; }
function weightsForMode(mode, custom){
  const W={Yields:1,Credit:1,Activity:1,Prices:1,Sentiment:1,FX:1,Market:1,Valuation:1,Labor:1};
  if(mode==='basic'){ W.Yields=1.2; W.Credit=1.2; }
  if(mode==='advanced'){ W.Yields=1.3; W.Credit=1.35; W.Prices=1.15; W.Activity=1.1; W.Valuation=1.1; }
  if(mode==='custom'&&custom){ W.Yields=custom.Y||1; W.Credit=custom.C||1; W.Activity=custom.A||1; W.Prices=custom.P||1; W.Sentiment=custom.S||1; W.FX=custom.S||1; W.Labor=1.1; }
  return W;
}

/* ------------------------------ Gauge/UI -------------------------------- */
function setGauge(crc){
  const v=Math.max(0,Math.min(100,crc));
  const rag=RAG(v), color=RAG_COLOR(rag), R=42, C=2*Math.PI*R;
  const arc=Math.max(2, v/100*C), gap=Math.max(0,C-arc);
  $('#gArc').setAttribute('stroke',color);
  $('#gArc').setAttribute('stroke-dasharray',`${arc} ${gap}`);
  $('#gNum').textContent = Number.isFinite(v)? Math.round(v) : '--';
  const b=$('#crcBadge'); b.textContent = `CRC: ${Number.isFinite(v)?Math.round(v):'--'} — ${Number.isFinite(v)?rag:'—'}`;
  b.style.border=`1px solid ${color}55`; b.style.boxShadow=`inset 0 0 0 9999px ${color}14`;
}
function cardHTML(row){
  const color = Number.isFinite(row.score)? RAG_COLOR(RAG(row.score)) : '#394a64';
  return `<div class="card">
    <div class="hdr"><div style="font-weight:700">${row.name}</div><div class="chip">${row.id}</div></div>
    <div class="val">${row.display ? '—' : row.displayValue}</div>
    <div class="score">score ${row.display ? '—' : row.score} • ${row.date || '—'}</div>
    <div class="help" style="border-left:3px solid ${color};padding-left:8px;margin-top:8px">${row.desc}</div>
  </div>`;
}
function renderCards(rows){
  const cont=$("#cards");
  cont.classList.remove('cols-1','cols-2','cols-3');
  cont.classList.add( window.innerWidth>=960?'cols-3':(window.innerWidth>=700?'cols-2':'cols-1') );
  cont.innerHTML = rows.map(cardHTML).join('');
}
window.addEventListener('resize',()=>renderCards(lastRows||[]));

/* ------------------------------- Chart ---------------------------------- */
let chart=null;
async function seriesForChart(id,key){
  if(id==='BUFFETT') return await buffettSeries(key);
  const j=await fredSeries(id,key);
  return j.observations.map(o=>({date:o.date,value:+o.value})).filter(p=>Number.isFinite(p.value));
}
async function renderChartFromSelect(){
  const id=$("#chartSel").value, key=$("#key").value.trim(); if(!key) return;
  const s=await seriesForChart(id,key);
  const ctx=$("#chart").getContext('2d');
  const labels=s.map(x=>x.date), data=s.map(x=>x.value);
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'line',
    data:{labels,datasets:[{label:id,borderColor:'#53a1ff',data,pointRadius:0,tension:.15}]},
    options:{animation:false,responsive:true,parsing:false,
      scales:{x:{grid:{color:getComputedStyle(document.documentElement).getPropertyValue('--grid')},ticks:{color:'#cfe1ff',maxRotation:0,autoSkip:true,maxTicksLimit:7}},
              y:{grid:{color:getComputedStyle(document.documentElement).getPropertyValue('--grid')},ticks:{color:'#cfe1ff'}}},
      plugins:{legend:{labels:{color:'#cfe1ff'}},tooltip:{intersect:false,mode:'index'},
               zoom:{pan:{enabled:true,mode:'xy'},zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'xy'}}}
    }});
}

/* ------------------------- Executive Summary ---------------------------- */
let prevScores = load('prevScores', null);
function buildSummary(crc, rows){
  const rag=RAG(crc);
  const parts=[];
  parts.push(`CRC ${Math.round(crc)} — ${rag}. A higher CRC signals broader crash vulnerability vs each indicator’s own last‑decade history. Mode: ${($('#weightMode').value)}.`);
  const groups = (cats)=>rows.filter(r=>cats.includes(r.cat)&&!r.display&&Number.isFinite(r.score)).map(r=>r.score);
  const avg = a=>a.length? Math.round(a.reduce((x,y)=>x+y,0)/a.length):null;
  const yields=avg(groups(['Yields'])), credit=avg(groups(['Credit'])), activity=avg(groups(['Activity'])),
        prices=avg(groups(['Prices'])), labor=avg(groups(['Labor'])),
        vol=rows.find(r=>r.id==='VIXCLS')?.score ?? null,
        usd=avg(groups(['FX'])), val=avg(groups(['Valuation']));
  parts.push(`Heatmap — Yields ${yields??'—'}, Credit ${credit??'—'}, Activity ${activity??'—'}, Prices ${prices??'—'}, Labor ${labor??'—'}, Vol ${vol??'—'}, USD ${usd??'—'}, Valuation ${val??'—'}. Higher scores = higher risk after sensible inverts.`);
  function topN(cats){ return rows.filter(r=>cats.includes(r.cat)&&!r.display&&Number.isFinite(r.score)).sort((a,b)=>b.score-a.score).slice(0,2).map(x=>`${x.name} (${x.score})`).join(', ')||'—'; }
  parts.push(`Key drivers now: Yields → ${topN(['Yields'])}; Credit → ${topN(['Credit'])}; Prices → ${topN(['Prices'])}.`);
  if(prevScores){
    const chg=[];
    for(const r of rows){
      if(!Number.isFinite(r.score)) continue;
      const d=r.score-(prevScores[r.id]??r.score);
      if(Math.abs(d)>=4) chg.push(`${r.name} ${d>0?'↑':'↓'} ${Math.abs(d)}pts`);
    }
    if(chg.length) parts.push(`Since last run: ${chg.slice(0,6).join(' · ')}.`);
  }
  parts.push(`What to watch: front‑anchored steepening (10Y–3M), a decisive rise in HY OAS or systemic stress (STLFSI/NFCI), and a turn higher in claims confirming softer labor. A synchronized move would push CRC into upper Amber/Red; easing OAS with curve normalization and steady claims would pull CRC toward Green.`);
  return parts.join(' ');
}

/* ------------------------------ Runner ---------------------------------- */
let lastRows=null;
async function run(){
  const key=$("#key").value.trim(); if(!key){ toast('Enter your FRED API key'); return; }
  save('fred_key',key);
  const mode=$("#weightMode").value;
  const custom = mode==='custom' ? {Y:+$("#wY").value,C:+$("#wC").value,A:+$("#wA").value,P:+$("#wP").value,S:+$("#wS").value}:null;
  save('weight_mode',mode); save('weight_custom',custom);

  $("#run").disabled=true; $("#run").textContent='Running…';

  try{
    const tasks = INDICATORS.map(async d=>{
      try{
        if(d.id==='BUFFETT'){
          const ser=await buffettSeries(key);
          const latest=ser.at(-1);
          const pct=pctileFromSeries(ser, latest.value);
          return {...d,date:latest.date,value:latest.value,displayValue:d.fmt(latest.value),score:bandScore(pct,false)};
        }else{
          const j=await fredSeries(d.id,key);
          // pick most recent finite value
          const latest=[...j.observations].reverse().find(o=>Number.isFinite(+o.value));
          if(!latest){ return {...d,date:'—',value:NaN,displayValue:'—',score:null,display:d.displayOnly||false}; }
          const v=+latest.value;
          if(d.displayOnly){
            return {...d,date:latest.date,value:v,displayValue:d.fmt(v),score:null,display:true};
          }else{
            const pct=pctileFromSeries(j.observations,v);
            return {...d,date:latest.date,value:v,displayValue:d.fmt(v),score:bandScore(pct,!!d.invert)};
          }
        }
      }catch(e){
        return {...d,date:'—',value:NaN,displayValue:'—',score:null,err:true};
      }
    });

    const rows = await Promise.all(tasks);

    // weighting
    const W=weightsForMode(mode,custom);
    const weightOf=r=> (r.cat==='Yields'?W.Yields: r.cat==='Credit'?W.Credit: r.cat==='Activity'?W.Activity:
                        r.cat==='Prices'?W.Prices: r.cat==='Sentiment'?W.Sentiment: r.cat==='FX'?W.FX:
                        r.cat==='Labor'?W.Labor: r.cat==='Valuation'?W.Valuation:1);
    const usable=rows.filter(r=>Number.isFinite(r.score));
    const wsum=usable.reduce((s,r)=>s+weightOf(r),0);
    const crc= usable.reduce((s,r)=>s+r.score*weightOf(r),0)/(wsum||1);

    setGauge(crc);
    $("#runMeta").textContent=`Last run: ${new Date().toLocaleString()} • Data cadence varies (daily/weekly/monthly).`;
    renderCards(rows);

    // chart selector
    $("#chartSel").innerHTML = CHART_IDS.map(id=>{
      const d=INDICATORS.find(x=>x.id===id); return `<option value="${id}">${d?.name||id} (${id})</option>`;
    }).join('');
    await renderChartFromSelect();

    $("#sumText").textContent = buildSummary(crc, rows);

    // persist scores for delta text
    const pack={}; for(const r of rows){ if(Number.isFinite(r.score)) pack[r.id]=r.score; }
    save('prevScores',pack); prevScores=pack;

    lastRows=rows;
  }catch(e){
    toast('Load error (network or proxy). Try again.');
    console.error(e);
  }finally{
    $("#run").disabled=false; $("#run").textContent='Run / Refresh';
  }
}

/* ---------------------------- Init bindings ----------------------------- */
(function init(){
  $("#key").value = load('fred_key','');
  const m=load('weight_mode','advanced'); $("#weightMode").value=m;
  const c=load('weight_custom',{Y:1.2,C:1.3,A:1.0,P:0.9,S:0.8});
  $("#wY").value=c.Y; $("#wC").value=c.C; $("#wA").value=c.A; $("#wP").value=c.P; $("#wS").value=c.S;
  $("#customBlock").style.display = $("#weightMode").value==='custom' ? '' : 'none';
  $("#weightMode").addEventListener('change',()=>{
    $("#customBlock").style.display = $("#weightMode").value==='custom' ? '' : 'none';
    save('weight_mode',$("#weightMode").value);
  });
  $("#run").addEventListener('click', run);
  $("#chartSel").addEventListener('change', renderChartFromSelect);
})();
</script>
</body>
</html>

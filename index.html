<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Marshall WBCI — World’s Best Crash Indicator (v1.0)</title>
<style>
:root{
  --bg:#0d1722; --panel:#0f1b27; --card:#102133; --edge:#1b2c3d;
  --text:#eaf0f6; --muted:#a8b6c6; --blue:#3a83ff;
  --green:#2ecc71; --amber:#f4b740; --red:#ff5565;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
h1{font:800 clamp(22px,5vw,36px)/1.15 system-ui;margin:20px 0}
h2{font:700 20px/1.25 system-ui;margin:0 0 10px}
.container{max-width:1000px;margin:0 auto;padding:16px}
.panel{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{padding:12px 14px;border:1px solid var(--edge);border-radius:12px;background:#0b1620;color:var(--text)}
input{flex:1 1 280px}
select{flex:0 0 260px}
button{padding:12px 18px;border:0;border-radius:12px;background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;padding:8px 12px;border-radius:12px;background:#1b2636;border:1px solid var(--edge);font-weight:800}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:999px;background:#152234;border:1px solid #243449;color:#b8c8d8;font-weight:700}

.gauge{width:min(150px,32vw);min-width:120px;aspect-ratio:1/1;border-radius:50%;
  background:conic-gradient(var(--amber) 0 0,#223041 0 360deg);position:relative;flex:0 0 auto}
.gauge>.hole{position:absolute;inset:12px;aspect-ratio:1/1;border-radius:50%;
  background:var(--bg);border:1px solid var(--edge);display:flex;align-items:center;justify-content:center;
  font:800 clamp(22px,6vw,36px)/1 system-ui}

.grid{display:grid;gap:14px}
@media(min-width:680px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
@media(min-width:980px){ .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;position:relative;overflow:hidden}
.kv{display:flex;justify-content:space-between;gap:8px;align-items:center}
.series{font:700 18px/1.2 system-ui}
.sub{display:flex;gap:10px;align-items:center;color:var(--muted)}
.vline{position:absolute;left:0;top:0;bottom:0;width:4px}
.v-green{background:linear-gradient(90deg,#1f8f5f,#2ecc71)}
.v-amber{background:linear-gradient(90deg,#9b7a17,#f4b740)}
.v-red{background:linear-gradient(90deg,#a11c2a,#ff5565)}
.bandbar{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red));opacity:.9}
.explain{margin-top:8px;color:var(--muted)}
ul.clean{margin:0 0 0 18px;padding:0;display:grid;gap:6px}
.err{background:#3b1b23;border:1px solid #5a2a37;color:#ffd7de;padding:10px 12px;border-radius:12px;margin-top:10px}

.spark{width:100%;height:86px;margin:8px 0 2px;border:1px solid var(--edge);border-radius:10px;background:#0b1620}
.axis{stroke:#223041;stroke-width:1}
.path{fill:none;stroke-width:2.2}
.tick{font-size:10px;fill:#7f91a6}

footer{margin:18px 0 12px;text-align:center;color:#7f91a6;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h1>Marshall WBCI — World’s Best Crash Indicator</h1>

  <div class="panel">
    <div class="row">
      <input id="apiKey" type="text" placeholder="FRED API key (saved locally)"/>
      <select id="mode">
        <option value="advanced">Advanced (predictive tilt + synchronicity)</option>
        <option value="simple">Simple (equal weights)</option>
      </select>
      <button id="runBtn">Run / Refresh</button>
    </div>
    <div id="topErr" class="err" style="display:none"></div>
  </div>

  <div class="panel">
    <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap">
      <div class="gauge"><div id="wcbiNum" class="hole">--</div></div>
      <div>
        <div class="chips">
          <div id="bandChip" class="chip">Band: —</div>
          <div id="breadthChip" class="chip">Breadth: —</div>
          <div id="syncChip" class="chip">Synchronicity: —</div>
          <div id="shockChip" class="chip">Shock: —</div>
        </div>
        <div id="runMeta" class="muted" style="margin-top:10px">
          Scores = percentiles vs each series’ last 10 years (with sensible inverts). Enhancers: Breadth, Synchronicity, Shock.
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Executive Summary</h2>
    <div id="execBody" class="muted">Run to generate a live note driven by current category scores and changes.</div>
  </div>

  <div class="panel">
    <h2>Categories</h2>
    <div id="cards" class="grid cols-2 cols-3"></div>
  </div>

  <footer>Marshall WBCI v1.0 • Built on public FRED data</footer>
</div>

<script>
/* ================= Utils ================= */
const $ = s=>document.querySelector(s);
const startISO = ()=>{const d=new Date();d.setFullYear(d.getFullYear()-10);return d.toISOString().slice(0,10);};
const proxies=[u=>u,u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),u=>'https://api.codetabs.com/v1/proxy/?quest='+encodeURIComponent(u)];
function timeout(ms,p){return Promise.race([p,new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),ms))]);}
async function jsonWithProxies(url){let last;for(const wrap of proxies){try{const r=await timeout(9000,fetch(wrap(url),{mode:'cors',cache:'no-store'}));if(!r.ok) throw new Error('HTTP '+r.status);return await r.json();}catch(e){ last=e; }}throw last||new Error('fetch failed');}
function fredURL(path,params){const u=new URL('fred/'+path,'https://api.stlouisfed.org/');for(const[k,v] of Object.entries(params))u.searchParams.set(k,v);u.searchParams.set('_t',Date.now());return u.toString();}
function percentileRank(values, x){const arr=values.filter(v=>Number.isFinite(v)).slice().sort((a,b)=>a-b);if(!arr.length||!Number.isFinite(x))return null;let lo=0,hi=arr.length;while(lo<hi){const m=(lo+hi>>1);if(arr[m]<=x)lo=m+1;else hi=m;}return Math.round(100*lo/arr.length);}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function mean(a){return a.length? a.reduce((x,y)=>x+y,0)/a.length : 0;}
function stdev(a){if(a.length<2) return 1;const m=mean(a);return Math.sqrt(mean(a.map(v=>(v-m)*(v-m))))||1;}
function band(score){if(score==null) return {name:'—', color:'#445', cls:''};if(score<40)return{name:'Green', color:'var(--green)', cls:'v-green'};if(score<=70)return{name:'Amber', color:'var(--amber)', cls:'v-amber'};return{name:'Red', color:'var(--red)', cls:'v-red'};}

/* ================= Categories & series (FRED) ================= */
const CATS = [
  { id:'rates',    name:'Rates / Curve',      why:'Tight or inverted curves + high long rates raise crash risk via refinancing and valuation pressure.' },
  { id:'credit',   name:'Credit / Stress',    why:'Credit spreads and systemic stress tend to lead equity drawdowns.' },
  { id:'liquidity',name:'Liquidity',          why:'When bond market depth and money conditions falter, sell‑offs accelerate.' },
  { id:'usd',      name:'USD / External',     why:'A strong USD tightens global financial conditions and can trigger funding squeezes.' },
  { id:'energy',   name:'Energy Shock',       why:'Energy burden spikes often precede recessions and earnings downgrades.' },
  { id:'house',    name:'Labor / Household',  why:'Rising claims and household delinquencies erode the demand buffer.' },
  { id:'act',      name:'Activity / Sentiment', why:'Softening real activity and confidence raise vulnerability to shocks.' }
];

const SERIES = [
  // Rates / Curve
  {id:'DGS10',    cat:'rates', name:'10y Treasury yield', code:'DGS10',      fmt:'pct',  invert:false},
  {id:'T10Y2Y',   cat:'rates', name:'10y–2y spread',      code:'T10Y2Y',     fmt:'pct',  invert:true},
  {id:'T10Y3M',   cat:'rates', name:'10y–3m spread',      code:'T10Y3M',     fmt:'pct',  invert:true},

  // Credit / Stress
  {id:'HY_OAS',   cat:'credit',name:'HY OAS',             code:'BAMLH0A0HYM2',fmt:'pct', invert:false},
  {id:'STLFSI4',  cat:'credit',name:'St. Louis FSI v4',   code:'STLFSI4',    fmt:'lev',  invert:false},
  {id:'NFCI',     cat:'credit',name:'Chicago Fed NFCI',   code:'NFCI',       fmt:'lev',  invert:false},

  // Liquidity
  {id:'UST_RVOL', cat:'liquidity', name:'UST realized vol (proxy)', code:'__SYNTH_RVOL__', fmt:'lev', invert:false},
  {id:'WALCL',    cat:'liquidity', name:'Fed balance sheet (assets)', code:'WALCL',     fmt:'num',  invert:true},

  // USD / External
  {id:'DTWEXBGS', cat:'usd',   name:'Broad trade-weighted USD', code:'DTWEXBGS', fmt:'lev', invert:false},

  // Energy
  {id:'WTI',      cat:'energy',name:'WTI crude oil',       code:'DCOILWTICO', fmt:'lev', invert:false},
  {id:'NATGAS',   cat:'energy',name:'Henry Hub gas',       code:'DHHNGSP',    fmt:'lev', invert:false},

  // Labor / Household
  {id:'ICSA',     cat:'house', name:'Initial jobless claims', code:'ICSA',    fmt:'num',  invert:false},
  {id:'UNRATE',   cat:'house', name:'Unemployment rate',      code:'UNRATE',  fmt:'pct',  invert:false},
  {id:'W875RX1',  cat:'house', name:'Real income ex-transfers',   code:'W875RX1',   fmt:'lev', invert:true},

  // Activity / Sentiment
  {id:'INDPRO',   cat:'act',   name:'Industrial production', code:'INDPRO',  fmt:'lev',  invert:true},
  {id:'TCU',      cat:'act',   name:'Capacity utilization',  code:'TCU',     fmt:'lev',  invert:true},
  {id:'RSAFS',    cat:'act',   name:'Retail sales (advance)',code:'RSAFS',   fmt:'num',  invert:true},
  {id:'PERMIT',   cat:'act',   name:'Building permits',      code:'PERMIT',  fmt:'num',  invert:true},
  {id:'UMCSENT',  cat:'act',   name:'UMich consumer sentiment', code:'UMCSENT', fmt:'lev', invert:true},
];

function fmtVal(meta,v){
  if(!Number.isFinite(v)) return '—';
  if(meta.fmt==='pct') return (+v).toFixed(2)+'%';
  if(meta.fmt==='num') return Number(v).toLocaleString();
  if(meta.fmt==='lev') return (Math.abs(v)>=1000?Number(v).toLocaleString():(+v.toFixed(4))).toString();
  return v;
}

/* ================= FRED ================= */
function fredObs(series_id, apiKey, start){
  const url = fredURL('series/observations',{series_id, api_key:apiKey, file_type:'json', observation_start:start});
  return jsonWithProxies(url).then(j=>{
    const obs=(j.observations||[]).filter(o=>o.value!=='.').map(o=>({t:o.date, v:+o.value}));
    return obs;
  });
}

/* synth UST realized vol from daily DGS10 */
function makeUSTRealizedVol(dgs10Daily){
  if(!dgs10Daily.length) return [];
  // daily |Δy| 10‑day rolling sum → monthly last value
  const absD=[]; for(let i=1;i<dgs10Daily.length;i++) absD.push({t:dgs10Daily[i].t, v:Math.abs(dgs10Daily[i].v-dgs10Daily[i-1].v)});
  const roll=[]; let acc=0; const W=10;
  for(let i=0;i<absD.length;i++){ acc+=absD[i].v; if(i>=W) acc-=absD[i-W].v; if(i>=W-1) roll.push({t:absD[i].t,v:acc}); }
  return resampleMonthly(roll);
}

function resampleMonthly(history){
  const map=new Map();
  for(const o of history){ const ym=o.t.slice(0,7); map.set(ym,o); }
  return [...map.entries()].sort((a,b)=>a[0]<b[0]?-1:1).map(e=>({t:e[0]+'-01', v:e[1].v}));
}

function scoreFromHistory(meta, history){
  if(!history.length) return null;
  const vals = history.map(h=>h.v);
  const latest = vals.at(-1);
  const p = percentileRank(vals, latest);
  if(p==null) return null;
  return clamp(meta.invert ? 100-p : p, 0, 100);
}

/* ============== Build monthly series & scores ============== */
async function loadAll(apiKey){
  const start = startISO();
  // fetch all needed raw series
  const ids = [...new Set(SERIES.filter(s=>s.code!=='__SYNTH_RVOL__').map(s=>s.code))];
  const jobs = ids.map(id => fredObs(id, apiKey, start).then(r=>({id,data:r})).catch(e=>({id,error:e})));
  const out = await Promise.all(jobs);
  const daily = Object.fromEntries(out.filter(x=>x.data).map(x=>[x.id,x.data]));
  const monthly = {};
  // resample to monthly
  for(const id of Object.keys(daily)){ monthly[id] = resampleMonthly(daily[id]); }
  // synth UST realized vol
  const rv = makeUSTRealizedVol(daily['DGS10']||[]);
  monthly['__SYNTH_RVOL__'] = rv;
  const fails = out.filter(x=>x.error || !x.data?.length).map(x=>x.id);
  return {monthly, fails};
}

function buildScores(monthly){
  // per series score
  const sScores = {};
  for(const s of SERIES){
    const hist = monthly[s.code] || [];
    const score = scoreFromHistory(s, hist);
    sScores[s.id] = {score, history: hist};
  }
  // per category score (avg of available series scores)
  const cScores = {};
  for(const c of CATS){
    const ids = SERIES.filter(x=>x.cat===c.id).map(x=>x.id);
    const xs = ids.map(id=>sScores[id].score).filter(v=>v!=null);
    cScores[c.id] = xs.length? Math.round(xs.reduce((a,b)=>a+b,0)/xs.length) : null;
  }
  // monthly category series for enhancers/spark
  const catMonthly = {};
  for(const c of CATS){
    const ids = SERIES.filter(x=>x.cat===c.id).map(x=>x.id);
    const arrs = ids.map(id=>sScores[id].history).filter(a=>a?.length);
    const len = arrs.length? Math.min(...arrs.map(a=>a.length)) : 0;
    const merged=[];
    for(let i=0;i<len;i++){
      const avg = arrs.reduce((acc,a)=>acc + a[a.length-len+i].v,0)/arrs.length;
      const t   = arrs[0][arrs[0].length-len+i].t;
      merged.push({t, v:avg});
    }
    catMonthly[c.id] = merged.slice(-24);
  }
  return {seriesScores:sScores, catScores:cScores, catMonthly};
}

/* ============== Enhancers & composite ============== */
function computeBreadth(catScores){ const xs=Object.values(catScores).filter(v=>v!=null); if(!xs.length) return 0; return xs.filter(v=>v>=70).length/xs.length; }
function computeSync(catMonthly, catScores){
  const actives = Object.keys(catMonthly).filter(k=> (catScores[k]??0)>=60);
  if(actives.length<2) return 0;
  const months = [...new Set(actives.flatMap(k=>catMonthly[k].map(p=>p.t)))].sort();
  const rows = actives.map(k=>{ const m=new Map(catMonthly[k].map(p=>[p.t,p.v])); return months.map(t=> m.get(t) ?? null); });
  const keep = []; for(let i=0;i<months.length;i++){ if(rows.every(r=>r[i]!=null)) keep.push(i); }
  if(keep.length<6) return 0;
  const A = rows.map(r=> keep.map(i=>r[i]));
  const cors=[];
  for(let i=0;i<A.length;i++) for(let j=i+1;j<A.length;j++){
    const a=A[i], b=A[j]; const ma=mean(a), mb=mean(b);
    const num=a.reduce((s,_,k)=>s+(a[k]-ma)*(b[k]-mb),0);
    const den=Math.sqrt(a.reduce((s,_,k)=>s+(a[k]-ma)**2,0))*Math.sqrt(b.reduce((s,_,k)=>s+(b[k]-mb)**2,0));
    cors.push(den? num/den : 0);
  }
  return clamp(mean(cors),0,1);
}
function computeShock(catMonthly){
  const zs=[];
  for(const arr of Object.values(catMonthly)){
    if(arr.length<6) continue;
    const vals=arr.map(p=>p.v);
    const deltas=[]; for(let i=3;i<vals.length;i++) deltas.push(vals[i]-vals[i-3]);
    if(deltas.length<3) continue;
    const mu=mean(deltas), sd=stdev(deltas);
    const lastZ=(deltas.at(-1)-mu)/(sd||1);
    if(lastZ>0) zs.push(lastZ);
  }
  const z=zs.length? mean(zs):0;
  return clamp(Math.round((z/2.5)*100),0,100);
}
function computeBase(catScores, mode){
  const w = (id)=>({credit:1.4, rates:1.3, liquidity:1.2, house:1.1, usd:1.0, energy:1.0, act:0.9}[id]||1);
  const items = Object.entries(catScores).filter(([_,v])=>v!=null);
  if(!items.length) return null;
  if(mode==='simple') return Math.round(mean(items.map(([_,v])=>v)));
  const W = items.reduce((a,[k])=>a+w(k),0);
  return Math.round(items.reduce((a,[k,v])=>a+w(k)*v,0)/W);
}
function computeWBCI(base, sync, breadth, shock){ if(base==null) return null; return clamp(Math.round(base*(1+0.4*sync+0.25*breadth)+0.25*shock),0,100); }

/* ============== SVG sparklines ============== */
function sparklineSVG(history, color){
  if(!history?.length) return '';
  const cut = history.slice(-24); // months
  const xs = cut.map((d,i)=>i), vs = cut.map(d=>d.v);
  const w=360,h=86,pad=8;
  const min=Math.min(...vs), max=Math.max(...vs);
  const y = v => max===min ? h/2 : h - ((v-min)/(max-min))*h;
  const x = i => (i/(xs.length-1||1))*w;
  let d=''; cut.forEach((pt,i)=>{ d += (i?'L':'M') + x(i)+','+y(pt.v)+' '; });
  const col = color||'#8ab6ff';
  return `
  <svg class="spark" viewBox="0 0 ${w+pad*2} ${h+pad*2}" preserveAspectRatio="none">
    <g transform="translate(${pad},${pad})">
      <line class="axis" x1="0" y1="${h}" x2="${w}" y2="${h}"></line>
      <line class="axis" x1="0" y1="0" x2="0" y2="${h}"></line>
      <path class="path" stroke="${col}" d="${d}"></path>
      <text class="tick" x="2" y="${h-4}">${cut[0].t.slice(0,7)}</text>
      <text class="tick" x="${w-46}" y="${h-4}">${cut[cut.length-1].t.slice(0,7)}</text>
      <text class="tick" x="2" y="10">${max.toFixed(0)}</text>
      <text class="tick" x="2" y="${h-20}">${min.toFixed(0)}</text>
    </g>
  </svg>`;
}

/* ============== UI paint ============== */
function paintGauge(x){
  $('#wcbiNum').textContent = x==null?'--':x;
  const b = band(x);
  const deg = x==null?0:Math.max(3,Math.min(360,Math.round(x/100*360)));
  document.querySelector('.gauge').style.background = `conic-gradient(${b.color} 0 ${deg}deg,#223041 ${deg}deg 360deg)`;
  $('#bandChip').textContent = `Band: ${b.name}`;
}
function renderCards(catScores, catMonthly){
  const wrap=$('#cards'); wrap.innerHTML='';
  for(const c of CATS){
    const s = catScores[c.id];
    const b = band(s);
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="vline ${b.cls}"></div>
      <div class="kv"><div class="series">${c.name}</div><div class="badge" style="background:#152234;border-color:#223345">${s==null?'—':s}</div></div>
      ${sparklineSVG(catMonthly[c.id]||[], b.color)}
      <div class="bandbar"></div>
      <div class="explain"><b>Baseline:</b> ${b.name}. <span class="muted">${c.why}</span></div>
    `;
    wrap.appendChild(div);
  }
}
function writeExecNoteSimple(base, breadth, sync, shock, catScores){
  const bandName = band(base||0).name;
  const cats = Object.entries(catScores).filter(([_,v])=>v!=null).sort((a,b)=>b[1]-a[1]);
  const top = cats.slice(0,3).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`);
  const low = cats.slice(-2).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`);
  const breadthNote = breadth>0.5 ? 'Risk is broad.' : breadth>0.2 ? 'Risk is spreading.' : 'Risk is concentrated.';
  const syncNote = sync>0.6 ? 'Many areas are moving together (late‑cycle feel).' : sync>0.3 ? 'Some clustering, not yet systemic.' : 'Little co‑movement right now.';
  const shockNote = shock>60 ? 'Conditions have worsened quickly.' : shock>30 ? 'Momentum is turning.' : 'Changes are gradual.';
  const stance = (()=> {
    if(base>=70 || (breadth>0.4 && sync>0.5)) return 'Defensive: raise cash quality, shorten duration, add crash hedges.';
    if(base>=50) return 'Cautious: run tighter risk, prefer quality balance sheets, keep selective hedges.';
    return 'Constructive but alert: use dips selectively; keep light hedges; watch the triggers.';
  })();
  const bullets = [
    `<b>Today’s take:</b> Base ${base==null?'—':base} — <b>${bandName}</b>. Breadth ${Math.round(breadth*100)}%, Synchronicity ${Math.round(sync*100)}%, Shock ${shock}.`,
    `<b>What this means:</b> ${breadthNote} ${syncNote} ${shockNote}`,
    `<b>What’s driving it:</b> ${top.join('; ')}${low.length?`. Offsets: ${low.join('; ')}`:''}.`,
    `<b>Watch next:</b> (1) front‑anchored curve steepening, (2) clear HY OAS/systemic‑stress widening, (3) a persistent rise in weekly claims.`,
    `<b>Portfolio stance:</b> ${stance}`
  ];
  $('#execBody').innerHTML = `<ul class="clean">${bullets.map(x=>`<li>${x}</li>`).join('')}</ul>`;
}

/* ============== Runner ============== */
function saveKey(){ const k=$('#apiKey').value.trim(); if(k) localStorage.setItem('fred_key',k); }
function loadKey(){ const k=localStorage.getItem('fred_key'); if(k) $('#apiKey').value=k; }

async function run(){
  $('#topErr').style.display='none'; $('#topErr').textContent='';
  const key=$('#apiKey').value.trim(); if(!key) return alert('Enter FRED API key'); saveKey();
  $('#runBtn').disabled=true; $('#runBtn').textContent='Running…';

  try{
    // 1) fetch & monthlyize
    const {monthly, fails} = await loadAll(key);

    // 2) build scores
    const built = buildScores(monthly);
    const catScores  = built.catScores;
    const catMonthly = built.catMonthly;

    // 3) enhancers
    const breadth = computeBreadth(catScores);
    const sync    = computeSync(catMonthly, catScores);
    const shock   = computeShock(catMonthly);

    // 4) base + final
    const mode = $('#mode').value;
    const base = computeBase(catScores, mode);
    const WBCI = computeWBCI(base, sync, breadth, shock);

    // 5) paint
    paintGauge(WBCI);
    $('#breadthChip').textContent = `Breadth: ${Math.round(breadth*100)}%`;
    $('#syncChip').textContent    = `Synchronicity: ${Math.round(sync*100)}%`;
    $('#shockChip').textContent   = `Shock: ${shock}`;
    $('#runMeta').textContent     = `Last run: ${new Date().toLocaleString()} • Mode: ${mode} • Categories loaded: ${Object.values(catScores).filter(v=>v!=null).length}/${CATS.length}`;
    renderCards(catScores, catMonthly);
    writeExecNoteSimple(base, breadth, sync, shock, catScores);

    if(fails.length){
      $('#topErr').style.display='block';
      $('#topErr').textContent = `Loaded with partial data (timed‑out/empty: ${fails.join(', ')}). Run again if needed.`;
    }
  }catch(err){
    console.error(err);
    $('#topErr').style.display='block';
    $('#topErr').textContent = 'Load error (network/proxy). Please try again.';
  }finally{
    $('#runBtn').disabled=false; $('#runBtn').textContent='Run / Refresh';
  }
}

document.getElementById('runBtn').addEventListener('click', run);
loadKey();
</script>
</body>
</html>

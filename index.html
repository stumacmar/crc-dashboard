<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marshall WBCI — World’s Best Crash Indicator</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0e1525; color:#eee; margin:0; padding:0; }
    header { padding:1rem; text-align:center; font-size:1.3rem; font-weight:600; }
    .card { background:#1c2537; border-radius:8px; margin:1rem; padding:1rem; }
    .btn { background:#3b82f6; color:#fff; border:none; border-radius:6px; padding:0.6rem 1rem; cursor:pointer; font-weight:600; }
    .btn:disabled { background:#555; cursor:wait; }
    .gauge { font-size:2.2rem; font-weight:700; text-align:center; margin-top:0.5rem; }
    .amber { color:#fbbf24; }
    .green { color:#22c55e; }
    .red { color:#ef4444; }
    ul.clean { list-style:none; padding-left:0; }
    ul.clean li { margin-bottom:0.4rem; }
    canvas { width:100%; height:180px; }
    .category { margin:1rem 0; padding:1rem; border-radius:8px; }
  </style>
</head>
<body>
  <header>Marshall WBCI — World’s Best Crash Indicator</header>

  <div class="card">
    <select id="mode">
      <option value="advanced">Advanced (predictive tilt + synchronicity)</option>
    </select>
    <button id="runBtn" class="btn">Run / Refresh</button>
    <div class="gauge" id="score">--</div>
    <div id="meta"></div>
  </div>

  <div class="card">
    <h3>Executive Summary</h3>
    <div id="execBody">Run the dashboard to generate an up-to-date note.</div>
  </div>

  <div class="card">
    <h3>Categories</h3>
    <div id="categories"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // --- Categories ---
    const CATS = [
      {id:'rates', name:'Rates / Curve'},
      {id:'credit', name:'Credit / Stress'},
      {id:'liq', name:'Liquidity'},
      {id:'usd', name:'USD / External'},
      {id:'energy', name:'Energy Shock'},
      {id:'labor', name:'Labor / Household'},
      {id:'activity', name:'Activity / Sentiment'},
    ];

    function band(v){
      if(v==null) return {name:'—', cls:''};
      if(v>=70) return {name:'Red', cls:'red'};
      if(v>=40) return {name:'Amber', cls:'amber'};
      return {name:'Green', cls:'green'};
    }

    // --- Simulated FRED data fetch ---
    async function fetchSeries(id){
      // Replace with live FRED API if you have a key
      // For now: simulate
      let data = [];
      let now = new Date();
      for(let i=0;i<24;i++){
        data.push({date:new Date(now.getFullYear(), now.getMonth()-i,1), value: Math.random()*100});
      }
      return data.reverse();
    }

    // --- Run dashboard ---
    async function run(){
      document.getElementById('runBtn').disabled=true;
      document.getElementById('runBtn').textContent='Running...';

      let scores={};
      let hist={};
      for(let cat of CATS){
        let series=await fetchSeries(cat.id);
        let last=series.at(-1).value;
        scores[cat.id]=Math.round(last);
        hist[cat.id]=series;
      }

      let vals=Object.values(scores).filter(v=>v!=null);
      let base=vals.reduce((a,b)=>a+b,0)/vals.length;
      let breadth=vals.filter(v=>v>=50).length/vals.length;
      let sync=0.2; // placeholder correlation calc
      let shock=Math.random()*80;

      document.getElementById('score').textContent=Math.round(base);
      document.getElementById('score').className='gauge '+band(base).cls;
      document.getElementById('meta').innerHTML=`Band: ${band(base).name}. Breadth: ${Math.round(breadth*100)}%. Synchronicity: ${Math.round(sync*100)}%. Shock: ${Math.round(shock)}.`;

      writeExecNoteSimple(base, breadth, sync, shock, scores);

      renderCats(scores, hist);

      document.getElementById('runBtn').disabled=false;
      document.getElementById('runBtn').textContent='Run / Refresh';
    }

    // --- Plain-English CIO Summary ---
    function writeExecNoteSimple(base, breadth, sync, shock, catScores){
      const bandName = band(base||0).name;
      const pct = n=> (n==null? '—' : (Math.round(n)));
      const cats = Object.entries(catScores).filter(([_,v])=>v!=null).sort((a,b)=>b[1]-a[1]);
      const top = cats.slice(0,3).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`);
      const low = cats.slice(-2).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`);

      const breadthNote = breadth>0.5 ? 'Risk is broad.' : breadth>0.2 ? 'Risk is spreading.' : 'Risk is concentrated.';
      const syncNote = sync>0.6 ? 'Many areas are moving together (late-cycle feel).' : sync>0.3 ? 'Some clustering, not yet systemic.' : 'Little co-movement right now.';
      const shockNote = shock>60 ? 'Conditions have worsened quickly.' : shock>30 ? 'Momentum is turning.' : 'Changes are gradual.';

      const stance = (()=> {
        if(base>=70 || (breadth>0.4 && sync>0.5)) return 'Defensive: raise cash quality, shorten duration, add crash hedges.';
        if(base>=50) return 'Cautious: run tighter risk, prefer quality balance sheets, keep selective hedges.';
        return 'Constructive but alert: use dips, keep hedges light, watch the triggers.';
      })();

      const bullets = [
        `<b>Today’s take:</b> Base ${pct(base)} — <b>${bandName}</b>. Breadth ${Math.round(breadth*100)}%, Synchronicity ${Math.round(sync*100)}%, Shock ${pct(shock)}.`,
        `<b>What this means:</b> ${breadthNote} ${syncNote} ${shockNote}`,
        `<b>What’s driving it:</b> ${top.join('; ')}${low.length?`. Offsets: ${low.join('; ')}`:''}.`,
        `<b>Watchlist:</b> (1) curve steepening led by the front end, (2) clear widening in HY OAS or systemic stress, (3) a persistent rise in weekly claims.`,
        `<b>Portfolio stance:</b> ${stance}`
      ];

      document.getElementById('execBody').innerHTML = `<ul class="clean">${bullets.map(x=>`<li>${x}</li>`).join('')}</ul>`;
    }

    // --- Category charts ---
    function renderCats(scores, hist){
      const cont=document.getElementById('categories');
      cont.innerHTML='';
      for(let cat of CATS){
        const div=document.createElement('div');
        div.className='category';
        div.innerHTML=`<h4>${cat.name} — ${scores[cat.id]||'--'} (${band(scores[cat.id]).name})</h4>
        <canvas id="chart_${cat.id}"></canvas>`;
        cont.appendChild(div);
        new Chart(div.querySelector('canvas').getContext('2d'),{
          type:'line',
          data:{
            labels: hist[cat.id].map(d=>d.date.toISOString().slice(0,10)),
            datasets:[{data: hist[cat.id].map(d=>d.value), borderColor:'#3b82f6', tension:0.3}]
          },
          options:{scales:{x:{display:false},y:{display:false}},plugins:{legend:{display:false}}}
        });
      }
    }

    document.getElementById('runBtn').onclick=run;
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>The Marshall Stock Market Crash Composite Indicator</title>
<meta name="theme-color" content="#0b1220">
<style>
  :root{
    --bg:#0b1220; --card:#121a2a; --line:#1f2b44; --muted:#9fb0c8; --text:#eef4ff;
    --chip:#24324a; --chip-text:#cfe0ff; --accent:#66a3ff; --shadow:rgba(0,0,0,.35);
    --g:#16a34a; --a:#f59e0b; --r:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:24px clamp(16px,4vw,24px) 40px}
  header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
  header img{width:60px;height:60px;border-radius:12px;border:1px solid var(--line);object-fit:cover;background:#0e172a}
  h1{font-size:clamp(22px,5vw,34px);line-height:1.1;margin:0}
  .sub{color:var(--muted);margin-top:2px}
  .controls{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,18,32,.97),rgba(11,18,32,.9) 80%,transparent);backdrop-filter:blur(6px);padding:8px 0 12px;margin:2px 0 12px}
  .row{display:flex;gap:10px;align-items:center}
  input[type=text]{flex:1;background:#0e172a;border:1px solid var(--line);color:var(--text);border-radius:12px;padding:12px 14px;font-size:15px}
  select,button{border:1px solid var(--line);border-radius:12px;background:#0e172a;color:var(--text)}
  select{padding:10px 12px}
  button{padding:12px 16px;background:linear-gradient(180deg,#3b82f6,#2563eb);border:none;font-weight:700}
  .saved{font-size:12px;color:#88d38a;background:#11321e;border:1px solid #215c35;padding:5px 8px;border-radius:999px}
  /* CRC donut */
  .gauge{display:flex;align-items:center;gap:14px;margin:10px 0 16px}
  .gauge svg{width:86px;height:86px;filter:drop-shadow(0 6px 14px var(--shadow))}
  .gauge .label{font-size:clamp(18px,4.5vw,24px);font-weight:800}
  .gauge .tag{display:inline-block;font-weight:800;padding:6px 10px;border-radius:10px;margin-left:8px}
  .tag.g{background:linear-gradient(180deg,#16a34a,#0f7a36)} .tag.a{background:linear-gradient(180deg,#f59e0b,#d97706)} .tag.r{background:linear-gradient(180deg,#ef4444,#dc2626)}
  /* RAG key */
  .key{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px 14px}
  .key h3{margin:0 0 8px}
  .legend{display:grid;grid-template-columns:108px 1fr;gap:8px 10px}
  .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:8px;position:relative;top:1px}
  /* Cards */
  .cards{display:grid;grid-template-columns:1fr;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px 14px 12px;box-shadow:0 10px 22px -18px var(--shadow)}
  .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .name{font-weight:700}
  .chip{background:var(--chip);color:var(--chip-text);padding:4px 8px;border-radius:999px;font-size:12px}
  .score{font-size:12px;padding:5px 8px;border-radius:999px;font-weight:800}
  .score.g{background:#103524} .score.a{background:#3a2a10} .score.r{background:#3a1313}
  .val{font-size:36px;font-weight:900;letter-spacing:.25px;margin:6px 0 2px}
  .meta{color:var(--muted);font-size:13px}
  .bar{height:8px;border-radius:999px;background:#0e172a;border:1px solid var(--line);overflow:hidden;margin-top:10px}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--g),#c3b50a,var(--r));width:0%}
  .spark{margin-top:10px}
  .muted{color:var(--muted)}
  details{margin-top:12px}
  summary{cursor:pointer}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <header>
    <img src="logo-alba.png" alt="Alba logo" onerror="this.style.display='none'">
    <div>
      <h1>The Marshall Stock Market Crash Composite Indicator</h1>
      <div class="sub">U.S. crash-risk dashboard from 20+ economic & market indicators.</div>
    </div>
  </header>

  <!-- Controls -->
  <div class="controls">
    <div class="row">
      <input id="apiKey" type="text" placeholder="Paste your 32-char FRED API key (saved locally)">
      <select id="proxySel">
        <option value="auto">Auto (race)</option>
        <option value="allorigins">AllOrigins</option>
        <option value="codetabs">CodeTabs</option>
        <option value="freeboard">Freeboard</option>
      </select>
      <button id="runBtn">Run / Refresh</button>
      <span id="saved" class="saved" style="display:none">Saved ✓</span>
    </div>
  </div>

  <!-- CRC donut -->
  <div class="gauge">
    <svg viewBox="0 0 120 120" aria-label="CRC gauge">
      <defs>
        <linearGradient id="grad" x1="0%" x2="100%">
          <stop offset="0%" stop-color="#16a34a"/>
          <stop offset="50%" stop-color="#f59e0b"/>
          <stop offset="100%" stop-color="#ef4444"/>
        </linearGradient>
      </defs>
      <circle cx="60" cy="60" r="48" fill="none" stroke="#0e172a" stroke-width="14"/>
      <circle id="arc" cx="60" cy="60" r="48" fill="none" stroke="url(#grad)" stroke-width="14"
              stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="0 999"/>
      <text id="crcNum" x="60" y="65" text-anchor="middle" font-size="26" font-weight="900" fill="#eef4ff">—</text>
    </svg>
    <div class="label">CRC <span id="crcTag" class="tag a">—</span></div>
  </div>

  <!-- RAG key -->
  <div class="key">
    <h3>How to read the CRC</h3>
    <div class="legend">
      <div><span class="dot" style="background:var(--g)"></span><b>Green &lt; 40</b></div>
      <div>Indicators mostly sit in the lower half of their last-10y ranges.</div>
      <div><span class="dot" style="background:var(--a)"></span><b>Amber 40–70</b></div>
      <div>Mixed/deteriorating signals. Typical responses: tighten risk controls; add selective hedges.</div>
      <div><span class="dot" style="background:var(--r)"></span><b>Red &gt; 70</b></div>
      <div>Broad elevation vs last decade. Focus often shifts to preservation/liquidity.</div>
    </div>
  </div>

  <!-- Cards -->
  <div id="cards" class="cards"></div>

  <details>
    <summary class="muted">Debug log</summary>
    <pre id="log" class="muted"></pre>
  </details>

</div>

<script>
/* ---------------- config (curated set, mobile-first) ---------------- */
const SERIES = [
  { id:"DGS10",       name:"10Y Treasury yield",             invert:false, decimals:2, unit:"%" },
  { id:"T10Y2Y",      name:"10Y–2Y spread",                  invert:true,  decimals:2, unit:"%" },
  { id:"T10Y3M",      name:"10Y–3M spread",                  invert:true,  decimals:2, unit:"%" },
  { id:"BAMLH0A0HYM2",name:"ICE BofA HY OAS",                invert:false, decimals:2, unit:"%" },
  { id:"STLFSI4",     name:"St. Louis Financial Stress (v4)",invert:false, decimals:4 },
  { id:"SP500",       name:"S

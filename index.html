<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Marshall Stock Market Crash Composite Indicator</title>
<link rel="preconnect" href="https://api.stlouisfed.org">
<link rel="preconnect" href="https://api.codetabs.com">
<style>
  :root{
    --bg:#0f1623;--card:#121b2a;--text:#dfe7f6;--muted:#9fb0cc;--accent:#3b82f6;
    --good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--chip:#2a3550;
  }
  *{box-sizing:border-box} body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
  .wrap{max-width:900px;margin:0 auto;padding:24px}
  h1{font-size:28px;margin:0 0 14px} .muted{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 18px}
  .input,button,.select{border-radius:12px;border:1px solid #22304b;background:#0e1523;color:var(--text)}
  .input{padding:12px 14px;flex:1;min-width:220px} .select{padding:12px}
  button{background:var(--accent);border:none;padding:12px 18px;font-weight:700;cursor:pointer}
  .card{background:var(--card);border:1px solid #1e2a41;border-radius:16px;padding:18px;margin:14px 0}
  .gauge{display:flex;align-items:center;gap:18px}
  .ring{width:96px;height:96px;border-radius:50%;background:
    conic-gradient(var(--warn) 0deg,var(--warn) var(--deg),#1b253a var(--deg) 360deg);
    display:grid;place-items:center}
  .ring span{font-size:28px;font-weight:800}
  .badge{background:#2b2230;padding:10px 14px;border-radius:12px;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
  @media(min-width:560px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(min-width:840px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .item{padding:14px;border-radius:14px;background:#0e1523;border:1px solid #1c2840}
  .tag{display:inline-block;background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px;color:#bcd}
  .mini{font-size:13px;color:var(--muted);margin-top:8px}
  .bar{height:3px;border-radius:2px;background:#21304d;margin-top:10px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--good),var(--warn),var(--bad));width:0%}
  .err{color:#ffb4b4}
  .foot{margin-top:6px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>The Marshall Stock Market Crash Composite Indicator</h1>
  <div class="row">
    <input id="key" class="input" placeholder="FRED API key" />
    <select id="mode" class="select">
      <option value="basic" selected>Basic (equal)</option>
      <option value="advanced">Advanced (predictive tilt)</option>
      <option value="custom">Custom (set below)</option>
    </select>
    <button id="run">Run / Refresh</button>
  </div>

  <div id="top" class="card">
    <div class="gauge">
      <div id="ring" class="ring" style="--deg:0deg"><span id="crcNum">--</span></div>
      <div>
        <div id="crcBadge" class="badge">CRC: --</div>
        <div class="foot">Composite = average of indicator percentiles vs last 10y (with sensible inverts).</div>
        <div class="foot" id="lastRun"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:4px 0 10px">Executive Summary</h3>
    <div id="exec" class="muted">Run the dashboard to generate a current analyst note.</div>
  </div>

  <div class="card">
    <h3 style="margin:4px 8px 10px">Indicators</h3>
    <div id="grid" class="grid"></div>
  </div>

  <div class="foot">Tip: if it ever stalls, tap Run again (proxy occasionally rate‑limits).</div>
</div>

<script>
const SERIES = [
  // code, title, unit, invertForRisk?
  {id:"DGS10", title:"10Y Treasury yield", unit:"%", invert:false, explain:"Higher long rates tighten financing costs and pressure valuations.", xform:v=>+v},
  {id:"T10Y2Y", title:"10Y–2Y spread", unit:"%", invert:false, explain:"Curve slope; deep negatives & tightness precede slowdowns.", xform:v=>+v},
  {id:"T10Y3M", title:"10Y–3M spread", unit:"%", invert:false, explain:"Front‑end tightness; inversion historically leads recessions.", xform:v=>+v},
  {id:"BAMLH0A0HYM2", title:"ICE BofA HY OAS", unit:"%", invert:false, explain:"Risk premium; widening = credit stress.", xform:v=>+v},
  {id:"STLFSI4", title:"St. Louis Financial Stress (v4)", unit:"", invert:false, explain:"Systemic stress; higher = tighter conditions.", xform:v=>+v},
  {id:"NFCI", title:"Chicago Fed Financial Conditions", unit:"", invert:false, explain:"Funding & risk appetite; higher = tighter.", xform:v=>+v},
  {id:"VIXCLS", title:"VIX index", unit:"%", invert:false, explain:"Equity volatility; high = pricier crash insurance.", xform:v=>+v},
  {id:"UNRATE", title:"Unemployment rate", unit:"%", invert:false, explain:"Labor slack; rising unemployment lifts drawdown odds.", xform:v=>+v},
  {id:"ICSA", title:"Initial jobless claims (wkly)", unit:"", invert:false, explain:"Early labor signal; rising claims warn of cooling.", xform:v=>+v},
  {id:"CPIAUCSL", title:"CPI (headline)", unit:"", invert:false, explain:"Inflation backdrop; higher keeps policy tighter.", xform:v=>+v},
  {id:"CPILFESL", title:"Core CPI", unit:"", invert:false, explain:"Underlying inflation persistence.", xform:v=>+v},
  {id:"PCEPI", title:"PCE prices", unit:"", invert:false, explain:"Fed‑preferred inflation gauge.", xform:v=>+v},
  {id:"INDPRO", title:"Industrial production", unit:"", invert:true, explain:"Real‑economy breadth; weakness raises risk.", xform:v=>+v},
  {id:"TCU", title:"Capacity utilization", unit:"", invert:true, explain:"Slack vs overheating; low utilization = weak demand.", xform:v=>+v},
  {id:"RSAFS", title:"Retail sales (advance)", unit:"", invert:true, explain:"Household demand; softness signals slower growth.", xform:v=>+v},
  {id:"HOUST", title:"Housing starts", unit:"", invert:true, explain:"Cyclical bellwether; weakness often leads downturns.", xform:v=>+v},
  {id:"PERMIT", title:"Building permits", unit:"", invert:true, explain:"Leading housing gauge; softness flags future activity.", xform:v=>+v},
  {id:"UMCSENT", title:"UMich consumer sentiment", unit:"", invert:true, explain:"Household mood; weakness → slower spending.", xform:v=>+v},
  {id:"DTWEXBGS", title:"Trade‑weighted USD (broad)", unit:"", invert:false, explain:"Stronger USD tightens global financial conditions.", xform:v=>+v},
];

const WEIGHTS = {
  basic: Object.fromEntries(SERIES.map(s=>[s.id,1])),
  advanced: (()=>{ // predictive tilt
    const w={};
    for(const s of SERIES){
      if(["BAMLH0A0HYM2","STLFSI4","NFCI","VIXCLS"].includes(s.id)) w[s.id]=1.5;      // credit/stress/vol
      else if(["T10Y2Y","T10Y3M"].includes(s.id)) w[s.id]=1.3;                         // curve
      else if(["UNRATE","ICSA"].includes(s.id)) w[s.id]=1.2;                           // labor
      else if(["CPIAUCSL","CPILFESL","PCEPI"].includes(s.id)) w[s.id]=1.1;             // inflation/policy
      else w[s.id]=1.0;
    }
    return w;
  })(),
  custom:{} // user can fill later
};

const $ = s=>document.querySelector(s);
const keyEl = $('#key'); const runBtn = $('#run'); const modeEl = $('#mode');
const ring = $('#ring'); const crcNum = $('#crcNum'); const badge = $('#crcBadge'); const execEl = $('#exec'); const gridEl = $('#grid'); const lastRun = $('#lastRun');

keyEl.value = localStorage.getItem('fred_key')||'';
keyEl.addEventListener('change',()=>localStorage.setItem('fred_key',keyEl.value));

function fredURL(series, key){ return `https://api.stlouisfed.org/fred/series/observations?series_id=${series}&api_key=${key}&file_type=json&observation_start=2014-01-01`; }
async function fetchSeries(id, key){
  const cacheKey = `ct_${id}`;
  const cached = sessionStorage.getItem(cacheKey);
  if(cached){
    try{
      const obj = JSON.parse(cached);
      if(Date.now()-obj.t < 30*60*1000) return obj.v;
    }catch{}
  }
  const url = 'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(fredURL(id,key));
  const r = await fetch(url);
  if(!r.ok) throw new Error(`Fetch ${id} ${r.status}`);
  const j = await r.json();
  const obs = j.observations||[];
  sessionStorage.setItem(cacheKey, JSON.stringify({t:Date.now(), v:obs}));
  return obs;
}

function latestValid(obs){
  for(let i=obs.length-1;i>=0;i--){
    const v = +obs[i].value;
    if(isFinite(v)) return {date:obs[i].date, value:v};
  }
  return {date:'—', value:null};
}

function pct10y(obs, invert){
  // last 10y slice (or whatever we fetched since 2014)
  const vals = obs.map(o=>+o.value).filter(Number.isFinite);
  if(vals.length<20) return null;
  const lo = Math.min(...vals), hi = Math.max(...vals);
  const last = vals[vals.length-1];
  if(hi===lo) return 50;
  let p = (last-lo)/(hi-lo)*100;
  if(invert) p = 100-p;
  return Math.max(0, Math.min(100, p));
}

function ragColor(score){ return score<40 ? 'var(--good)' : score<70 ? 'var(--warn)' : 'var(--bad)'; }
function setGauge(score){
  if(score==null){ ring.style.setProperty('--deg','0deg'); crcNum.textContent='--'; badge.textContent='CRC: --'; return; }
  const deg = Math.round(360*score/100);
  ring.style.background = `conic-gradient(${ragColor(score)} ${deg}deg,#1b253a ${deg}deg 360deg)`;
  ring.style.setProperty('--deg',deg+'deg'); crcNum.textContent=String(score);
  const label = score<40?'GREEN':score<70?'AMBER':'RED';
  badge.textContent = `CRC: ${score} — ${label}`;
  badge.style.background = score<40?'#0f2a19':score<70?'#2b220f':'#2a1212';
}

function fmt(v,unit){ if(v==null) return '—'; return unit==='%'? (v.toFixed(2)+'%') : String(v); }

function weightSet(){
  const m = modeEl.value;
  if(m==='basic') return WEIGHTS.basic;
  if(m==='advanced') return WEIGHTS.advanced;
  // custom: fallback to basic if empty
  return Object.keys(WEIGHTS.custom).length?WEIGHTS.custom:WEIGHTS.basic;
}

function buildItem(s, latest, score){
  const el = document.createElement('div');
  el.className='item';
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
      <div style="font-weight:700">${s.title}<span class="tag">${s.id}</span></div>
      <div class="mini">${latest?.date?.slice(0,10)||'—'}</div>
    </div>
    <div style="font-size:32px;font-weight:800;margin-top:6px">${fmt(latest?.value,s.unit)}</div>
    <div class="mini">score ${score==null?'—':Math.round(score)}</div>
    <div class="bar"><i style="width:${score==null?0:score}%"></i></div>
    <div class="mini" style="margin-top:8px">${s.explain}</div>
  `;
  return el;
}

function writeExec(summary){
  execEl.innerHTML = summary;
}

function makeSummary(scores){
  // Simple, readable, dynamic (no jargon).
  const s = (id)=>scores[id]?.score;
  const parts = [];

  const crc = scores.__crc;
  if(crc!=null){
    const band = crc<40?'green':crc<70?'amber':'red';
    parts.push(`<b>CRC ${crc} — ${band.toUpperCase()}.</b> Higher means conditions are riskier than usual over the last decade.`);
  }

  // Yields/curve
  if(s("DGS10")!=null || s("T10Y2Y")!=null || s("T10Y3M")!=null){
    const y = s("DGS10"), a = s("T10Y2Y"), b = s("T10Y3M");
    let msg = "Rates stay a key driver: ";
    if(y!=null) msg += `10‑year yield score ${Math.round(y)}; `;
    if(a!=null) msg += `10Y–2Y ${Math.round(a)}; `;
    if(b!=null) msg += `10Y–3M ${Math.round(b)}. `;
    msg += "Higher scores here mean tighter money and a harder backdrop for stocks.";
    parts.push(msg);
  }

  // Credit
  if(s("BAMLH0A0HYM2")!=null || s("STLFSI4")!=null || s("NFCI")!=null){
    parts.push(`Credit & stress: HY spread ${Math.round(s("BAMLH0A0HYM2")??0)}, STLFSI ${Math.round(s("STLFSI4")??0)}, NFCI ${Math.round(s("NFCI")??0)}. Rising readings usually come before equity drawdowns.`);
  }

  // Labor
  if(s("UNRATE")!=null || s("ICSA")!=null){
    parts.push(`Labor: unemployment ${Math.round(s("UNRATE")??0)}, claims ${Math.round(s("ICSA")??0)}. A steady climb in either is a common early warning.`);
  }

  // Prices
  if(s("CPIAUCSL")!=null || s("CPILFESL")!=null || s("PCEPI")!=null){
    parts.push(`Inflation (headline/core/PCE) scores ${[s("CPIAUCSL"),s("CPILFESL"),s("PCEPI")].filter(v=>v!=null).map(v=>Math.round(v)).join(" / ")}. Higher keeps policy tighter for longer.`);
  }

  // Activity
  const act = ["INDPRO","TCU","RSAFS","HOUST","PERMIT","UMCSENT"].map(sid=>scores[sid]?.score).filter(v=>v!=null);
  if(act.length){
    parts.push("Real‑economy: softer readings across production, utilization, spending, housing, or sentiment increase downside risk.");
  }

  // USD
  if(s("DTWEXBGS")!=null){
    parts.push(`Dollar score ${Math.round(s("DTWEXBGS"))}: a stronger USD tightens global conditions.`);
  }

  parts.push("<b>Watch next:</b> (1) curve steepening led by the front end, (2) a clear rise in HY spreads or stress, (3) a turn higher in claims. Together they would push CRC up; easing credit with steady labor would pull it down.");
  return parts.join(" ");
}

async function run(){
  const key = keyEl.value.trim();
  if(!key){ alert('Enter your FRED API key'); return; }
  runBtn.disabled = true; runBtn.textContent = 'Running…';
  gridEl.innerHTML='';

  const weights = weightSet();
  const scores = {};
  let sum=0, wsum=0;

  for(const s of SERIES){
    try{
      const obs = await fetchSeries(s.id,key);
      const latest = latestValid(obs);
      const p = pct10y(obs, s.invert);
      const w = (weights[s.id]??1);
      const item = buildItem(s, latest, p);
      gridEl.appendChild(item);
      if(p!=null){ sum += p*w; wsum += w; }
      scores[s.id] = {score:p, value:latest.value, date:latest.date};
    }catch(e){
      const item = document.createElement('div'); item.className='item';
      item.innerHTML = `<div style="font-weight:700">${s.title}<span class="tag">${s.id}</span></div>
        <div class="mini err">load error — ${e.message}</div>`;
      gridEl.appendChild(item);
    }
  }

  const crc = wsum? Math.round(sum/wsum): null;
  scores.__crc = crc;
  setGauge(crc);
  lastRun.textContent = `Last run: ${new Date().toLocaleString()}`;
  writeExec(makeSummary(scores));

  runBtn.disabled=false; runBtn.textContent='Run / Refresh';
}

$('#run').addEventListener('click', run);
</script>
</body>
</html>

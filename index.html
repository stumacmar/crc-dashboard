<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Marshall Stock Market Crash Composite Indicator</title>
<style>
:root{
  --bg:#0d1722; --panel:#0f1b27; --card:#102133; --edge:#1b2c3d;
  --text:#eaf0f6; --muted:#a8b6c6; --blue:#3a83ff;
  --green:#2ecc71; --amber:#f4b740; --red:#ff5565;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
h1{font:800 clamp(22px,5vw,38px)/1.15 system-ui;margin:22px 0}
h2{font:700 20px/1.25 system-ui;margin:0 0 12px}
.container{max-width:980px;margin:0 auto;padding:18px}
.panel{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:16px;margin:14px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{padding:12px 14px;border:1px solid var(--edge);border-radius:12px;background:#0b1620;color:var(--text)}
input{flex:1 1 280px}
select{flex:0 0 260px}
button{padding:12px 18px;border:0;border-radius:12px;background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;padding:8px 12px;border-radius:12px;background:#1b2636;border:1px solid var(--edge);font-weight:800}

.gauge{
  width:min(150px,32vw); min-width:120px;
  aspect-ratio:1/1;border-radius:50%;
  background:conic-gradient(var(--amber) 0 0,#223041 0 360deg);
  position:relative;flex:0 0 auto
}
.gauge>.hole{
  position:absolute;inset:12px;aspect-ratio:1/1;border-radius:50%;
  background:var(--bg);border:1px solid var(--edge);
  display:flex;align-items:center;justify-content:center;
  font:800 clamp(22px,6vw,36px)/1 system-ui
}
.crc-badge{background:#2a2215;border:1px solid #3c2f1a}
.flex{display:flex;gap:18px;align-items:center}
.muted{color:var(--muted)}
.err{background:#3b1b23;border:1px solid #5a2a37;color:#ffd7de;padding:10px 12px;border-radius:12px;margin-top:10px}

.grid{display:grid;gap:14px}
@media(min-width:680px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
@media(min-width:980px){ .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;position:relative;overflow:hidden}
.kv{display:flex;justify-content:space-between;gap:8px;align-items:center}
.series{font:700 18px/1.2 system-ui}
.code{background:#1c2a3b;border-radius:10px;padding:6px 10px;border:1px solid var(--edge);font-weight:700}
.value{font:800 clamp(22px,6vw,34px)/1.1 system-ui;margin:8px 0}
.sub{display:flex;gap:10px;align-items:center;color:var(--muted)}
.bandbar{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red));opacity:.9}
.explain{margin-top:10px;color:var(--muted)}
.vline{position:absolute;left:0;top:0;bottom:0;width:4px}
.v-green{background:linear-gradient(90deg,#1f8f5f,#2ecc71)}
.v-amber{background:linear-gradient(90deg,#9b7a17,#f4b740)}
.v-red{background:linear-gradient(90deg,#a11c2a,#ff5565)}
ul.clean{margin:0 0 0 18px;padding:0;display:grid;gap:6px}
footer{margin:28px 0 12px;text-align:center;color:#7f91a6;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h1>The Marshall Stock Market Crash Composite Indicator</h1>

  <div class="panel">
    <div class="row">
      <input id="apiKey" type="text" placeholder="FRED API key"/>
      <select id="mode">
        <option value="advanced">Advanced (predictive tilt)</option>
        <option value="simple">Simple (equal weights)</option>
      </select>
      <button id="runBtn">Run / Refresh</button>
    </div>
    <div id="topErr" class="err" style="display:none"></div>
  </div>

  <div class="panel">
    <div class="flex">
      <div class="gauge"><div id="crcNum" class="hole">--</div></div>
      <div>
        <div id="crcBadge" class="badge crc-badge">CRC: --</div>
        <div id="runMeta" class="muted" style="margin-top:10px">
          Composite = average of indicator percentiles vs last 10y (with sensible inverts).
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Executive Summary</h2>
    <div id="execBody" class="muted">Run the dashboard to generate a current analyst note.</div>
  </div>

  <div class="panel">
    <h2>Indicators</h2>
    <div id="cards" class="grid cols-2 cols-3"></div>
  </div>

  <footer>Marshall Composite • Built on public FRED data</footer>
</div>

<script>
/* ========= Utils ========= */
const $ = s=>document.querySelector(s);
const todayISO = ()=> new Date().toISOString().slice(0,10);
const startISO = ()=> { const d=new Date(); d.setFullYear(d.getFullYear()-10); return d.toISOString().slice(0,10); };

const proxies = [
  u=>u,
  u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),
  u=>'https://api.codetabs.com/v1/proxy/?quest='+encodeURIComponent(u),
];
function timeout(ms, p){return Promise.race([p,new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),ms))]);}
async function jsonWithProxies(url){
  let last; for(const wrap of proxies){
    try{
      const r = await timeout(8000, fetch(wrap(url),{mode:'cors',cache:'no-store'}));
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){ last=e; }
  } throw last || new Error('fetch failed');
}
function percentileRank(values, x){
  const arr = values.filter(v=>Number.isFinite(v)).slice().sort((a,b)=>a-b);
  if(!arr.length||!Number.isFinite(x)) return null;
  let lo=0,hi=arr.length; while(lo<hi){const m=(lo+hi>>1); if(arr[m]<=x) lo=m+1; else hi=m;}
  return Math.round(100*lo/arr.length);
}
function band(score){
  if(score==null) return {name:'—', color:'#445', cls:''};
  if(score<40) return {name:'Green', color:'var(--green)', cls:'v-green'};
  if(score<=70) return {name:'Amber', color:'var(--amber)', cls:'v-amber'};
  return {name:'Red', color:'var(--red)', cls:'v-red'};
}
function bandLabel(score){
  if(score==null) return {text:'—', cls:'', expl:'No score available.'};
  if(score<40) return {text:'Green', cls:'v-green', expl:'Below its decade median → easier/healthier than usual.'};
  if(score<=70) return {text:'Amber', cls:'v-amber', expl:'Around/above median → mixed/tighter than usual.'};
  return {text:'Red', cls:'v-red', expl:'Near top of decade range → elevated risk vs usual.'};
}

/* ========= Indicators ========= */
const INDICATORS = [
  { id:'DGS10', name:'10Y Treasury yield', code:'DGS10', fmt:'pct', invert:false, cat:'yields', scored:true, why:'Benchmark long rate; higher real financing costs and valuation pressure.' },
  { id:'T10Y2Y', name:'10Y–2Y spread', code:'T10Y2Y', fmt:'pct', invert:false, cat:'yields', scored:true, why:'Curve slope; deep negatives & tightness precede slowdowns.' },
  { id:'T10Y3M', name:'10Y–3M spread', code:'T10Y3M', fmt:'pct', invert:false, cat:'yields', scored:true, why:'Front‑end tightness; inversion historically leads recessions.' },
  { id:'BAMLH0A0HYM2', name:'ICE BofA HY OAS', code:'BAMLH0A0HYM2', fmt:'pct', invert:false, cat:'credit', scored:true, why:'High‑yield spread; widening = credit stress.' },
  { id:'STLFSI4', name:'St. Louis Financial Stress (v4)', code:'STLFSI4', fmt:'level', invert:false, cat:'credit', scored:true, why:'Systemic stress; higher = tighter conditions.' },
  { id:'NFCI', name:'Chicago Fed Financial Conditions', code:'NFCI', fmt:'level', invert:false, cat:'credit', scored:true, why:'Funding & risk appetite; higher = tighter.' },
  { id:'SP500', name:'S&P 500 index (display only)', code:'SP500', fmt:'level', invert:null, cat:'valuation', scored:false, why:'Level context only; not scored in CRC.' },
  { id:'VIXCLS', name:'VIX index', code:'VIXCLS', fmt:'level', invert:false, cat:'vol', scored:true, why:'Equity volatility; higher = pricier crash insurance.' },
  { id:'BUFF', name:'Buffett Ratio (Wilshire/GDP) — proxy', code:'synthetic', fmt:'level', invert:false, cat:'valuation', scored:true, why:'Total market value vs GDP; higher valuation = greater drawdown vulnerability.' },
  { id:'UNRATE', name:'Unemployment rate', code:'UNRATE', fmt:'pct', invert:true, cat:'labor', scored:true, why:'Labor slack; rising unemployment lifts drawdown odds.' },
  { id:'ICSA', name:'Initial jobless claims (wkly)', code:'ICSA', fmt:'num', invert:true, cat:'labor', scored:true, why:'Early labor signal; rising claims warn of cooling.' },
  { id:'CPIAUCSL', name:'CPI (headline)', code:'CPIAUCSL', fmt:'level', invert:false, cat:'prices', scored:true, why:'Inflation backdrop; higher keeps policy tighter.' },
  { id:'CPILFESL', name:'Core CPI', code:'CPILFESL', fmt:'level', invert:false, cat:'prices', scored:true, why:'Underlying inflation persistence.' },
  { id:'PCEPI', name:'PCE prices', code:'PCEPI', fmt:'level', invert:false, cat:'prices', scored:true, why:'Fed‑preferred inflation gauge.' },
  { id:'INDPRO', name:'Industrial production', code:'INDPRO', fmt:'level', invert:true, cat:'activity', scored:true, why:'Real‑economy breadth; weakness raises risk.' },
  { id:'TCU', name:'Capacity utilization', code:'TCU', fmt:'level', invert:true, cat:'activity', scored:true, why:'Slack vs overheating; low utilization = weak demand.' },
  { id:'RSAFS', name:'Retail sales (advance)', code:'RSAFS', fmt:'num', invert:true, cat:'activity', scored:true, why:'Household demand; softness signals slower growth.' },
  { id:'HOUST', name:'Housing starts', code:'HOUST', fmt:'num', invert:true, cat:'housing', scored:true, why:'Cyclical bellwether; weakness often leads downturns.' },
  { id:'PERMIT', name:'Building permits', code:'PERMIT', fmt:'num', invert:true, cat:'housing', scored:true, why:'Leading housing gauge; softness flags future activity.' },
  { id:'UMCSENT', name:'UMich consumer sentiment', code:'UMCSENT', fmt:'level', invert:true, cat:'sentiment', scored:true, why:'Household mood; weakness → slower spending.' },
  { id:'DTWEXBGS', name:'Trade‑weighted USD (broad)', code:'DTWEXBGS', fmt:'level', invert:false, cat:'usd', scored:true, why:'Stronger USD tightens global financial conditions.' },
];
function fmtVal(meta,v){
  if(!Number.isFinite(v)) return '—';
  if(meta.fmt==='pct') return (+v).toFixed(2)+'%';
  if(meta.fmt==='num') return Number(v).toLocaleString();
  if(meta.fmt==='level') return (Math.abs(v)>=1000?Number(v).toLocaleString():(+v.toFixed(4))).toString();
  return v;
}

/* ========= FRED ========= */
const FRED_BASE='https://api.stlouisfed.org/';
const fredURL=(path,params)=>{const u=new URL('fred/'+path,FRED_BASE); for(const[k,v] of Object.entries(params)) u.searchParams.set(k,v); u.searchParams.set('_t',Date.now()); return u.toString(); };

async function fetchSeries(code, apiKey, start){
  const url = fredURL('series/observations',{series_id:code, api_key:apiKey, file_type:'json', observation_start:start, observation_end:todayISO()});
  const j = await jsonWithProxies(url);
  const obs = (j.observations||[]).filter(o=>o.value!=='.').map(o=>({t:o.date, v:+o.value}));
  const last = obs[obs.length-1]||{};
  return {latest:last.v??null, date:last.t??null, history:obs};
}
async function fetchBuffett(apiKey, start){
  const wil = await jsonWithProxies(fredURL('series/observations',{series_id:'WILL5000INDFC',api_key:apiKey,file_type:'json',observation_start:start}));
  const gdp = await jsonWithProxies(fredURL('series/observations',{series_id:'GDP',api_key:apiKey,file_type:'json',observation_start:start}));
  const W = (wil.observations||[]).filter(o=>o.value!=='.').map(o=>({t:o.date,v:+o.value}));
  const G = (gdp.observations||[]).filter(o=>o.value!=='.').map(o=>({t:o.date,v:+o.value}));
  if(!W.length || !G.length) return {latest:null,date:null,history:[]};
  // Normalize both to base 100, align Wilshire to the latest point ≤ each GDP date
  const w0=W[0].v, g0=G[0].v;
  const hist=[];
  let wi=0;
  for(const q of G){
    while(wi<W.length && new Date(W[wi].t) <= new Date(q.t)) wi++;
    const chosen = W[wi-1] || W[0];
    const wilN = chosen.v/w0*100;
    const gdpN = q.v/g0*100;
    hist.push({t:q.t, v:(wilN/gdpN)*100}); // ≈ market cap as % of GDP (proxy)
  }
  const last = hist[hist.length-1]||{};
  return {latest:last.v??null, date:last.t??null, history:hist};
}

function scoreFromHistory(meta, history){
  if(!history.length) return null;
  const vals = history.map(h=>h.v);
  const latest = vals[vals.length-1];
  const p = percentileRank(vals, latest);
  if(p==null) return null;
  return Math.max(0,Math.min(100, meta.invert ? (100-p) : p));
}

/* ========= CRC + summary ========= */
function crcFrom(scores, mode){
  const scoredMetas = INDICATORS.filter(m=>m.scored);
  const xs = scoredMetas.map(m=>scores[m.id]).filter(s=>s!=null);
  if(!xs.length) return null;
  if(mode==='simple') return Math.round(xs.reduce((a,b)=>a+b,0)/xs.length);
  const wMap={yields:1.4, credit:1.4, labor:1.1, prices:1.1, activity:1.0, housing:1.0, sentiment:0.9, usd:1.0, vol:1.0, valuation:0.8};
  const pairs = scoredMetas.map(m=>({w:wMap[m.cat]??1, s:scores[m.id]})).filter(o=>o.s!=null);
  const W = pairs.reduce((a,b)=>a+b.w,0);
  return Math.round(pairs.reduce((a,b)=>a+b.w*b.s,0)/W);
}
const niceCat = c=>({yields:'Yields/Curve',credit:'Credit/Stress',prices:'Inflation',labor:'Labor',activity:'Activity',housing:'Housing',sentiment:'Sentiment',usd:'USD',vol:'Volatility',valuation:'Valuation'})[c]||c;

function writeExec(state){
  const {scores} = state;
  const agg = {};
  INDICATORS.forEach(m=>{
    if(!m.scored) return;
    const s = scores[m.id]; if(s==null) return;
    (agg[m.cat]??=[]).push(s);
  });
  const avg = o=>Object.fromEntries(Object.entries(o).map(([k,v])=>[k,Math.round(v.reduce((a,b)=>a+b,0)/v.length)]));
  const A = avg(agg);
  const top = Object.entries(A).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${niceCat(k)} <b>${v}</b> (${band(v).name})`).join(', ');
  const low = Object.entries(A).sort((a,b)=>a[1]-b[1]).slice(0,2).map(([k,v])=>`${niceCat(k)} <b>${v}</b> (${band(v).name})`).join(', ');

  const bullets = [];
  bullets.push(`<b>CRC ${state.crc} — ${band(state.crc).name}.</b> Higher = riskier relative to each series’ own last‑10‑year range (we invert “good‑high” series so all scores are apples‑to‑apples risk).`);
  if(top) bullets.push(`<b>Pressure points:</b> ${top}.`);
  if(low) bullets.push(`<b>Offsets:</b> ${low}.`);
  bullets.push(`<b>Watch next:</b> front‑anchored curve steepening (10Y–3M rising while bills hold high); a jump in <b>HY OAS / stress</b>; and a turn higher in <b>claims</b>. A synchronized move likely pushes CRC toward Red; easing OAS with steady claims would pull it toward Green.`);
  $('#execBody').innerHTML = `<ul class="clean">${bullets.map(x=>`<li>${x}</li>`).join('')}</ul>`;
}

/* ========= UI paint ========= */
function paintCRC(x){
  $('#crcNum').textContent = x==null?'--':x;
  const b = band(x);
  $('#crcBadge').textContent = `CRC: ${x==null?'--':x} — ${b.name}`;
  const deg = x==null?0:Math.max(3,Math.min(360,Math.round(x/100*360)));
  $('.gauge').style.background = `conic-gradient(${b.color} 0 ${deg}deg,#223041 ${deg}deg 360deg)`;
}
function renderCards(state){
  const wrap = $('#cards'); wrap.innerHTML='';
  INDICATORS.forEach(meta=>{
    const L = state.latest[meta.id]||{};
    const s = state.scores[meta.id] ?? null;
    const bl = bandLabel(s);
    const dateStr = L.t || '—';
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="vline ${bl.cls}"></div>
      <div class="kv"><div class="series">${meta.name}</div><div class="code">${meta.id==='BUFF'?'synthetic':meta.code}</div></div>
      <div class="value">${fmtVal(meta, L.v)}</div>
      <div class="sub"><span>score <b>${s==null?'—':s}</b></span><span>•</span><span>${dateStr}</span></div>
      <div class="bandbar"></div>
      <div class="explain"><b>Baseline:</b> ${bl.text}. <span class="muted">${bl.expl}</span><br/>
      <b>What this tracks:</b> ${meta.why}</div>
    `;
    wrap.appendChild(div);
  });
}

/* ========= Runner ========= */
const state={latest:{},scores:{},crc:null};

function loadApiKey(){
  const k = localStorage.getItem('fred_key');
  $('#apiKey').value = k ? k : 'b78d7171c0fc2576225970999f88fa7f7';
}
function saveApiKey(){ const k=$('#apiKey').value.trim(); if(k) localStorage.setItem('fred_key',k); }

async function run(){
  $('#topErr').style.display='none'; $('#topErr').textContent='';
  const key = $('#apiKey').value.trim(); saveApiKey();
  const mode = $('#mode').value;
  $('#runBtn').disabled=true; $('#runBtn').textContent='Running…';
  try{
    const start = startISO();
    const jobs = INDICATORS.map(async meta=>{
      try{
        if(meta.id==='BUFF'){ return [meta.id, await fetchBuffett(key, start)]; }
        const r = await fetchSeries(meta.code, key, start);
        return [meta.id, r];
      }catch(e){ return [meta.id, {latest:null,date:null,history:[]}]; }
    });
    const results = await Promise.all(jobs);

    state.latest={}; state.scores={};
    for(const [id, data] of results){
      state.latest[id] = {v:data.latest, t:data.date};
      const meta = INDICATORS.find(x=>x.id===id);
      if(meta.scored){
        state.scores[id] = scoreFromHistory(meta, data.history);
      }
    }
    state.crc = crcFrom(state.scores, mode);
    paintCRC(state.crc);
    renderCards(state);
    $('#runMeta').textContent = `Last run: ${new Date().toLocaleString()} • Scores = percentiles vs last 10y (after sensible inverts).`;
    writeExec(state);
  }catch(err){
    console.error(err);
    $('#topErr').style.display='block';
    $('#topErr').textContent = 'Load error (network/proxy). Please try again.';
  }finally{
    $('#runBtn').disabled=false; $('#runBtn').textContent='Run / Refresh';
  }
}

document.getElementById('runBtn').addEventListener('click', run);
loadApiKey();
</script>
</body>
</html>

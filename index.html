<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>World's Best Crash Indicator</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: system-ui, sans-serif; background:#0f1226; color:#eef0ff; margin:0; padding:1rem; }
  h1 { font-size:1.4rem; margin-bottom:1rem; }
  input,select,button { font-size:1rem; margin:0.3rem 0; padding:0.4rem; border-radius:4px; border:none; }
  input { width:100%; }
  button { cursor:pointer; }
  #log { margin-top:1rem; font-family:monospace; white-space:pre-wrap; color:#ffd166; }
  #chartBox { margin-top:2rem; }
</style>
</head>
<body>
<h1>World's Best Crash Indicator</h1>

<input id="apiKey" placeholder="Enter FRED API key" spellcheck="false" autocapitalize="none" autocomplete="off">
<br>
<button onclick="run()">Run / Refresh</button>
<button onclick="resetCache()">Reset Cache</button>

<div id="log">Waiting…</div>
<div id="chartBox"><canvas id="chart"></canvas></div>

<script>
const CACHE_TTL = 1000*60*60*6; // 6 hours

function log(msg) {
  document.getElementById('log').textContent = msg;
}

function resetCache() {
  localStorage.removeItem('fredCache');
  log("Cache cleared.");
}

async function fetchFRED(seriesId, key) {
  const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${seriesId}&api_key=${key}&file_type=json`;
  try {
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    const data = await res.json();
    if (data.error_code) throw new Error(`FRED error ${data.error_code}: ${data.error_message}`);
    return data.observations.map(o => ({x:o.date, y: parseFloat(o.value)})).filter(p=>!isNaN(p.y));
  } catch(e) {
    throw new Error(`Fetch failed for ${seriesId}\nURL: ${url}\n${e.message}`);
  }
}

async function run() {
  const raw = document.getElementById('apiKey').value.trim();
  if (!/^[a-z0-9]{32}$/.test(raw)) {
    log("❌ Invalid API key: must be exactly 32 chars [a–z0–9]");
    return;
  }
  log("Running… fetching from FRED…");

  const cache = JSON.parse(localStorage.getItem('fredCache') || "null");
  if (cache && Date.now() - cache.timestamp < CACHE_TTL) {
    log("Loaded from cache.");
    drawChart(cache.data);
    return;
  }

  try {
    const gdp = await fetchFRED("GDP", raw);
    const spx = await fetchFRED("SP500", raw);
    const data = {gdp, spx};
    localStorage.setItem('fredCache', JSON.stringify({timestamp:Date.now(), data}));
    log("✅ Data loaded successfully.");
    drawChart(data);
  } catch(e) {
    log("❌ " + e.message);
  }
}

function drawChart(data) {
  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {label:'GDP', data:data.gdp, borderColor:'#21d07a', tension:0.1},
        {label:'S&P500', data:data.spx, borderColor:'#ffd166', tension:0.1}
      ]
    },
    options: {
      responsive:true,
      parsing:false,
      scales:{x:{type:'time', time:{unit:'year'}}}
    }
  });
}
</script>
</body>
</html>

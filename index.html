<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Marshall Stock Market Crash Composite Indicator</title>
<meta name="theme-color" content="#0b1220" />
<style>
  :root{
    --bg:#0b1220; --card:#121a2a; --muted:#99a3b3; --text:#e8eefc;
    --accent:#6ea8fe; --green:#10b981; --amber:#f59e0b; --red:#ef4444;
    --chip:#24324a; --chip-text:#c9d6ea;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  a{color:var(--accent);text-decoration:none} h1,h2,h3{margin:0 0 .5rem}
  .wrap{max-width:980px;margin:0 auto;padding:24px}
  header{display:grid;grid-template-columns:72px 1fr;gap:16px;align-items:center;margin:8px 0 16px}
  header img{width:72px;height:72px;border-radius:8px;background:#0e172a;object-fit:cover;border:1px solid #1f2b44}
  header .sub{color:var(--muted)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 18px}
  input[type=text]{flex:1 1 340px;background:#0e172a;border:1px solid #1f2b44;border-radius:12px;color:var(--text);padding:12px 14px;font-size:15px}
  select{background:#0e172a;border:1px solid #1f2b44;color:var(--text);border-radius:12px;padding:10px 12px}
  button{background:linear-gradient(180deg,#3b82f6,#2563eb);border:none;color:#fff;border-radius:12px;padding:12px 16px;font-weight:600}
  .badge{display:inline-block;margin:6px 0 16px;padding:16px 18px;border-radius:14px;font-weight:800;font-size:22px}
  .b-green{background:linear-gradient(180deg,#10b981,#059669)}
  .b-amber{background:linear-gradient(180deg,#f59e0b,#d97706)}
  .b-red{background:linear-gradient(180deg,#ef4444,#dc2626)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:760px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #1f2b44;border-radius:14px;padding:16px}
  .chip{display:inline-block;background:var(--chip);color:var(--chip-text);padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px}
  .val{font-size:32px;font-weight:800;letter-spacing:0.3px;margin:6px 0}
  .muted{color:var(--muted);font-size:14px}
  details{background:var(--card);border:1px solid #1f2b44;border-radius:14px;padding:12px;margin-top:16px}
  summary{cursor:pointer;font-weight:700}
  pre{white-space:pre-wrap;margin:10px 0 0;color:#cbd5e1}
  .key{background:var(--card);border:1px solid #1f2b44;border-radius:14px;padding:16px;margin:10px 0 18px}
  .key h3{margin-bottom:8px}
  .legend{display:grid;grid-template-columns:120px 1fr;gap:10px;margin:8px 0}
  .dot{width:14px;height:14px;border-radius:999px;display:inline-block;margin-right:8px;position:relative;top:2px}
  .g{background:#10b981}.a{background:#f59e0b}.r{background:#ef4444}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <!-- Use your provided Alba mark file name -->
    <img src="logo-alba.png" alt="Alba knot mark" onerror="this.style.display='none'">
    <div>
      <h1>The Marshall Stock Market Crash Composite Indicator</h1>
      <div class="sub">Live U.S. crash-risk dashboard — powered by 20+ economic &amp; market indicators.</div>
    </div>
  </header>

  <div class="controls">
    <input id="apiKey" type="text" inputmode="latin" autocomplete="off" placeholder="Paste your 32-char FRED API key (saved locally)" />
    <select id="proxySel" title="Proxy">
      <option value="auto">Auto (race)</option>
      <option value="allorigins">AllOrigins</option>
      <option value="codetabs">CodeTabs</option>
      <option value="freeboard">Freeboard</option>
    </select>
    <button id="runBtn">Run / Refresh</button>
  </div>

  <div id="crc" class="badge b-amber">CRC: —</div>

  <div class="key">
    <h3>How to read the CRC (RAG) score</h3>
    <div class="legend"><div><span class="dot g"></span><b>Green&nbsp;&lt; 40</b></div><div>Most indicators sit in the lower half of their last-10y ranges. Markets are typically stable; many participants keep baseline risk.</div></div>
    <div class="legend"><div><span class="dot a"></span><b>Amber&nbsp;40–70</b></div><div>Mixed or deteriorating signals. Common responses include tightening risk controls (position sizing, stops, selective hedges) and watching for confirmation.</div></div>
    <div class="legend"><div><span class="dot r"></span><b>Red&nbsp;&gt; 70</b></div><div>Broad elevation vs. the last decade. Many focus on capital preservation, stress-testing exposures, and emphasizing defensive/liquid assets.</div></div>
    <div class="muted">CRC is a simple average of each indicator’s **percentile vs the past 10 years** (with sensible “inverts” applied, e.g., higher unemployment = higher risk). It’s an aggregated risk thermometer—not a market-timing signal.</div>
  </div>

  <div id="cards" class="grid"></div>

  <details id="dbg">
    <summary>Debug Log</summary>
    <pre id="log"></pre>
  </details>
</div>

<script>
/* -------------------- config -------------------- */
const SERIES = [
  { id:"DGS10",      name:"10Y Treasury yield",            invert:false, decimals:2, unit:"%" },
  { id:"T10Y2Y",     name:"10Y–2Y spread",                 invert:true,  decimals:2, unit:"%" },
  { id:"T10Y3M",     name:"10Y–3M spread",                 invert:true,  decimals:2, unit:"%" },
  { id:"BAMLH0A0HYM2", name:"ICE BofA HY OAS",            invert:false, decimals:2, unit:"%" },
  { id:"STLFSI4",    name:"St. Louis Financial Stress (v4)", invert:false, decimals:4 },
  { id:"SP500",      name:"S&P 500 index",                 invert:true,  decimals:1 },
  { id:"VIXCLS",     name:"VIX index",                     invert:false, decimals:2 },
  { id:"UNRATE",     name:"Unemployment rate",             invert:false, decimals:1, unit:"%" },
  { id:"UMCSENT",    name:"UMich consumer sentiment",      invert:true,  decimals:1 },
  { id:"CPIAUCSL",   name:"CPI (headline)",                invert:false, decimals:2 },
  { id:"CPILFESL",   name:"Core CPI",                      invert:false, decimals:2 },
  { id:"PCEPI",      name:"PCE prices",                    invert:false, decimals:3 },
  { id:"INDPRO",     name:"Industrial production",         invert:false, decimals:2 },
  { id:"TCU",        name:"Capacity utilization",          invert:false, decimals:2 },
  { id:"RSAFS",      name:"Retail sales (advance)",        invert:false, decimals:0 },
  { id:"HOUST",      name:"Housing starts",                invert:false, decimals:0 },
  { id:"PERMIT",     name:"Building permits",              invert:false, decimals:0 },
  { id:"DTWEXBGS",   name:"Trade-weighted USD (broad)",    invert:false, decimals:4 },
  { id:"ICSA",       name:"Initial jobless claims (wkly)", invert:false, decimals:0 },
  { id:"SP500MN",    name:"S&P 500 (monthly avg)",         invert:true,  decimals:1 }
];

const PROXIES = {
  allorigins: u => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
  codetabs:   u => 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u),
  freeboard:  u => 'https://thingproxy.freeboard.io/fetch/' + u
};

/* -------------------- helpers -------------------- */
const $ = s => document.querySelector(s);
const log = msg => { const el = $("#log"); el.textContent += msg + "\n"; };
const fmt = (v, dec=2) => Number(v).toLocaleString(undefined,{maximumFractionDigits:dec});
const clamp01 = x => Math.min(1, Math.max(0, x));

function badge(avg){
  const b = $("#crc");
  b.classList.remove('b-green','b-amber','b-red');
  let color='b-amber', label='AMBER';
  if (avg < 40){ color='b-green'; label='GREEN'; }
  else if (avg > 70){ color='b-red'; label='RED'; }
  b.classList.add(color);
  b.textContent = `CRC: ${Math.round(avg)} — ${label}`;
}

function buildCards(){
  const c = $("#cards"); c.innerHTML='';
  for (const s of SERIES){
    const id = `card-${s.id}`;
    c.insertAdjacentHTML('beforeend', `
      <div class="card" id="${id}">
        <div><b>${s.name}</b> <span class="chip">${s.id}</span></div>
        <div class="val" data-val>—</div>
        <div class="muted" data-meta>—</div>
        <div class="muted" data-score>score —</div>
      </div>
    `);
  }
}

function fredURL(seriesId, key){
  const start = new Date(); start.setFullYear(start.getFullYear()-11);
  const iso = start.toISOString().slice(0,10);
  const base = 'https://api.stlouisfed.org/fred/series/observations';
  return `${base}?series_id=${seriesId}&api_key=${key}&file_type=json&observation_start=${iso}`;
}

async function fetchRace(url, mode='auto', timeout=15000){
  const make = (fn) => fetch(fn(url));
  const racers = mode==='auto'
    ? [PROXIES.allorigins, PROXIES.codetabs, PROXIES.freeboard].map(make)
    : [ make(PROXIES[mode]) ];
  const to = new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), timeout));
  if (racers.length===1){
    const r = await Promise.race([racers[0], to]);
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    return r.json();
  } else {
    // Promise.any for first successful; if all fail, throw last error
    const results = racers.map(p=>p.then(r=>r.ok?r.json():Promise.reject(new Error(r.status))));
    return Promise.any(results);
  }
}

function percentileLast10y(obs, latest){
  // obs: [{date,value(number)}], assume already filtered to last 11y window by request
  const cut = new Date(); cut.setFullYear(cut.getFullYear()-10);
  const sample = obs.filter(o => new Date(o.date) >= cut && isFinite(o.value));
  const arr = (sample.length>=24? sample : obs).map(o=>o.value).filter(v=>isFinite(v)).sort((a,b)=>a-b);
  if (!arr.length) return { pct: NaN, n: 0 };
  // percentile rank (<=)
  let i = 0; while (i < arr.length && arr[i] <= latest) i++;
  const pct = (i/arr.length)*100;
  return { pct, n: arr.length };
}

/* -------------------- main runner -------------------- */
async function run(){
  $("#log").textContent = '';
  const key = $("#apiKey").value.trim();
  const mode = $("#proxySel").value;

  if(!/^[a-z0-9]{32}$/.test(key)){
    alert("Please paste a valid 32-character FRED API key (lower-case letters/numbers).");
    $("#apiKey").focus(); return;
  }
  localStorage.setItem('fred_api_key', key);

  buildCards();
  badge(0);
  log(`Fetching ${SERIES.length} indicators (last 10y window)…`);

  const tasks = SERIES.map(async s=>{
    const card = document.getElementById(`card-${s.id}`);
    const vEl  = card.querySelector('[data-val]');
    const mEl  = card.querySelector('[data-meta]');
    const scEl = card.querySelector('[data-score]');

    try{
      const url = fredURL(s.id, key);
      const data = await fetchRace(url, mode);
      if(!data || !Array.isArray(data.observations)) throw new Error('bad response');

      // numeric observations
      const obs = data.observations.map(o=>({ date:o.date, value: Number(o.value) }))
        .filter(o => isFinite(o.value));
      if (!obs.length) throw new Error('no numeric observations');

      const latest = obs[obs.length-1]; // already requested only recent 11y+ window
      const { pct } = percentileLast10y(obs, latest.value);
      let score = pct;
      if (s.invert) score = 100 - pct;

      vEl.textContent = s.unit ? `${fmt(latest.value, s.decimals)}${s.unit}` : fmt(latest.value, s.decimals);
      mEl.textContent = `${latest.date}`;
      scEl.textContent = `score ${isFinite(score)? Math.round(score) : '—'}`;
      card.dataset.score = isFinite(score)? score : '';

      log(`✓ ${s.id} OK`);
    }catch(e){
      vEl.textContent = '—';
      mEl.textContent = 'insufficient data';
      scEl.textContent = 'score —';
      card.dataset.score = '';
      log(`✗ ${s.id} failed: ${e.message||e}`);
    }
  });

  await Promise.allSettled(tasks);

  // CRC average
  const scores = Array.from(document.querySelectorAll('[id^=card-]'))
    .map(c=>parseFloat(c.dataset.score))
    .filter(v=>isFinite(v));
  const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length) : NaN;
  badge(isFinite(avg)? avg : 0);
  log(`Done. ${scores.length}/${SERIES.length} series contributed to CRC.`);
}

/* -------------------- boot -------------------- */
(function init(){
  buildCards();
  // preload saved key
  const saved = localStorage.getItem('fred_api_key');
  if (saved) $("#apiKey").value = saved;
  $("#runBtn").addEventListener('click', run);
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marshall WBCI</title>
<style>
body{margin:0;font-family:sans-serif;background:#0e1621;color:#e7f0ff;text-align:center;padding:20px}
h1{margin:0 0 20px}
input,button{padding:10px;border-radius:6px;border:0;margin:5px}
button{background:#3b82f6;color:#fff;font-weight:bold;cursor:pointer}
#ring{width:160px;height:160px;border-radius:50%;margin:20px auto;
  display:flex;align-items:center;justify-content:center;
  font-size:36px;font-weight:bold;background:#1f2b3a;color:#fff}
</style>
</head>
<body>
<h1>Marshall WBCI — Crash Indicator</h1>
<input id="key" placeholder="FRED API key"/>
<button onclick="run()">Run / Refresh</button>

<div id="ring">--</div>
<div id="summary">Enter API key and press Run.</div>

<script>
const SERIES = {
  rates:["T10Y3M","T10Y2Y"],              // yield curves
  credit:["BAMLH0A0HYM2"],               // HY spreads
  usd:["DTWEXBGS"],                      // USD index
  labor:["UNRATE"],                      // unemployment
  activity:["UMCSENT"]                   // sentiment
};

async function fred(id,key){
  const url=`https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${key}&file_type=json`;
  const r=await fetch(url);
  const j=await r.json();
  const vals=j.observations.map(o=>+o.value).filter(v=>!isNaN(v));
  return vals;
}
function percentile(arr,v){
  const xs=arr.slice().sort((a,b)=>a-b);
  let i=xs.findIndex(x=>x>v);
  if(i<0) i=xs.length;
  return Math.round(100*i/xs.length);
}
function band(score){return score<40?"green":score<70?"orange":"red"}

async function run(){
  const key=document.getElementById("key").value.trim();
  if(!key){alert("Enter API key");return}
  document.getElementById("summary").innerText="Loading...";
  let scores=[];
  for(const [cat,ids] of Object.entries(SERIES)){
    for(const id of ids){
      try{
        const vals=await fred(id,key);
        const last=vals[vals.length-1];
        const pct=percentile(vals,last);
        scores.push(pct);
      }catch(e){console.error(e)}
    }
  }
  if(!scores.length){document.getElementById("summary").innerText="No data";return}
  const wbci=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
  document.getElementById("ring").style.background=band(wbci);
  document.getElementById("ring").innerText=wbci;
  document.getElementById("summary").innerText=
    `WBCI ${wbci} — ${wbci<40?"Low risk (Green)":wbci<70?"Medium (Amber)":"High risk (Red)"}`;
}
</script>
</body>
</html>

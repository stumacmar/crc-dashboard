<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>The Marshall Stock Market Crash Composite Indicator</title>
<link rel="preconnect" href="https://api.stlouisfed.org" crossorigin>
<link rel="dns-prefetch" href="https://api.stlouisfed.org">
<link rel="dns-prefetch" href="https://api.allorigins.win">
<link rel="dns-prefetch" href="https://api.codetabs.com">
<link rel="dns-prefetch" href="https://thingproxy.freeboard.io">
<style>
  :root{
    --bg:#0f1720; --panel:#121b26; --muted:#7c8aa0; --text:#e6edf6; --chip:#2a3a4e;
    --green:#19c37d; --amber:#f5a524; --red:#ef4444; --ring:#1e2a39; --accent:#4386f9;
    --card:#0f1823;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text); background:var(--bg);
  }
  .wrap{max-width:1080px;margin:0 auto;padding:20px 16px 80px}
  header h1{margin:0 0 6px;font-size:clamp(22px,3.8vw,40px);line-height:1.1}
  header .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  input[type=text]{flex:1;min-width:260px;background:#0b121a;border:1px solid #223045;border-radius:12px;color:var(--text);padding:12px 14px}
  select,button{background:#182334;border:1px solid #274059;color:var(--text);border-radius:12px;padding:12px 14px}
  button.primary{background:var(--accent);border-color:#3a6fe0;color:white;font-weight:600}
  button:disabled{opacity:.6}
  .row{display:grid;gap:16px;margin-top:16px}
  .row.cols-2{grid-template-columns:1fr; }
  @media (min-width:560px){ .row.cols-2{grid-template-columns:1fr 1fr} }
  @media (min-width:900px){ .row.cols-3{grid-template-columns:repeat(3,1fr)} }
  .panel{background:var(--panel);border:1px solid #1f2a38;border-radius:16px;padding:16px}
  .gauge-wrap{display:flex;gap:16px;align-items:center}
  .gauge{width:132px;height:132px;border-radius:50%;background:
    conic-gradient(var(--gaugeColor) var(--gaugePct,0%), #263343 0);
    display:grid;place-items:center;position:relative}
  .gauge::before{
    content:"";position:absolute;inset:12px;border-radius:50%;background:var(--panel);
    box-shadow:inset 0 0 0 10px var(--ring);
  }
  .gauge .num{position:relative;font-size:34px;font-weight:700}
  .badge{display:inline-block;background:#2a3a4e;border:1px solid #3a5068;color:#d9e2ed;
    padding:8px 12px;border-radius:12px;font-weight:700}
  .muted{color:var(--muted)}
  .title{font-weight:700;font-size:20px;margin:0 0 8px}
  .summary{font-size:15px;color:#cfd8e4}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .chip{background:var(--chip);border:1px solid #34506b;border-radius:999px;padding:4px 10px;font-size:12px;color:#cfe1ff}
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:1fr}
  @media (min-width:560px){ .cards{grid-template-columns:1fr 1fr} }
  @media (min-width:900px){ .cards{grid-template-columns:repeat(3,1fr)} }
  .card{background:var(--card);border:1px solid #1d2836;border-radius:14px;padding:14px}
  .card .top{display:flex;justify-content:space-between;align-items:center}
  .card .value{font-size:28px;font-weight:800;margin:6px 0}
  .card .score{font-size:13px;color:#9bb0c7}
  .card small{color:#9cb0c7}
  .help{font-size:13px;color:#a8b7c9;margin-top:6px}
  .flex{display:flex;gap:10px;align-items:center}
  .hidden{display:none!important}
  .footer-note{color:#93a7be;font-size:13px;margin-top:10px}
  .error{color:#ffb4b4}
  canvas{background:#0e1620;border:1px solid #1e2b3d;border-radius:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>The Marshall Stock Market Crash Composite Indicator</h1>
    <div class="bar">
      <input id="key" type="text" placeholder="Your FRED API key" />
      <select id="weightMode">
        <option value="advanced">Advanced (predictive tilt)</option>
        <option value="basic">Basic (balanced)</option>
        <option value="simple">Simple (equal)</option>
        <option value="custom">Custom (from localStorage)</option>
      </select>
      <button id="run" class="primary">Run / Refresh</button>
      <!-- Proxy picker intentionally hidden; unhide by removing style -->
      <select id="proxy" class="hidden">
        <option value="auto">Auto (race)</option>
        <option value="direct">Direct (CORS ok)</option>
        <option value="allorigins">AllOrigins</option>
        <option value="codetabs">Codetabs</option>
        <option value="thingproxy">ThingProxy</option>
      </select>
    </div>
  </header>

  <!-- CRC / Summary -->
  <section class="panel">
    <div class="gauge-wrap">
      <div class="gauge" id="gauge"><div class="num" id="gNum">--</div></div>
      <div>
        <div id="crcBadge" class="badge">CRC: --</div>
        <div class="footer-note" id="runMeta"></div>
        <div class="footer-note muted">Composite = average of indicator percentiles vs last 10y (using sensible inverts).</div>
      </div>
    </div>
    <h3 class="title" style="margin-top:16px">Executive Summary</h3>
    <div id="summary" class="summary">—</div>
    <div class="chips" style="margin-top:10px">
      <button id="historyBtn" class="badge" style="background:#243349;border-color:#2f4966">Show History</button>
      <a class="badge" target="_blank" rel="noreferrer" style="text-decoration:none;background:#243349;border-color:#2f4966" href="https://fred.stlouisfed.org/releases/calendar">Release Calendar</a>
    </div>
    <div id="history" class="hidden help"></div>
  </section>

  <!-- Chart -->
  <section class="panel">
    <div class="flex" style="margin-bottom:10px">
      <h3 class="title" style="margin:0">Interactive Chart</h3>
      <select id="chartSel" style="margin-left:auto">
        <option value="SP500">S&P 500 (SP500)</option>
        <option value="VIXCLS">VIX (VIXCLS)</option>
        <option value="BAMLH0A0HYM2">HY OAS (BAMLH0A0HYM2)</option>
        <option value="DGS10">10Y Yield (DGS10)</option>
        <option value="T10Y2Y">10Y–2Y spread (T10Y2Y)</option>
        <option value="T10Y3M">10Y–3M spread (T10Y3M)</option>
        <option value="DTWEXBGS">Trade‑weighted USD (DTWEXBGS)</option>
        <option value="BUFFETT">Buffett Ratio (Wilshire/GDP)</option>
      </select>
    </div>
    <canvas id="chart" height="260"></canvas>
    <div class="help">Pinch to zoom • Drag while holding one finger + second finger to pan • Double‑tap to reset.</div>
  </section>

  <!-- Indicators -->
  <section class="panel">
    <h3 class="title">Indicators</h3>
    <div id="cards" class="grid cards"></div>
  </section>
</div>

<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>

<script>
/* =========================
   CONFIG
========================= */
const TTL_HOURS = 6;            // cache time
const CONCURRENCY = 6;          // parallel fetch cap
const YEARS_BACK = 11;          // observation window (keeps payloads small)
const STORAGE_KEY = 'MCI_LAST_RUN';
const KEY_STORAGE = 'FRED_KEY';
const WEIGHT_MODE_KEY = 'MCI_WEIGHT_MODE';
const CUSTOM_WEIGHTS_KEY = 'MCI_CUSTOM_WEIGHTS'; // JSON map when mode=custom

// Indicator definition
const INDICATORS = [
  { id:'DGS10',      name:'10Y Treasury yield',           invert:false, cat:'curve',   fmt:'pct',  desc:'Benchmark long rate; higher real financing costs raise crash risk.' },
  { id:'T10Y2Y',     name:'10Y–2Y spread',                invert:true,  cat:'curve',   fmt:'pct',  desc:'Curve tightness/inversion; lower or inverted spreads flag late-cycle risk.' },
  { id:'T10Y3M',     name:'10Y–3M spread',                invert:true,  cat:'curve',   fmt:'pct',  desc:'Front-end vs long-end; deep inversion often precedes recessions.' },
  { id:'BAMLH0A0HYM2',name:'ICE BofA HY OAS',             invert:false, cat:'credit',  fmt:'pct',  desc:'High-yield spread; wider OAS = tighter credit & higher default risk.' },
  { id:'STLFSI4',    name:'St. Louis Financial Stress (v4)', invert:false,cat:'credit',fmt:'raw',  desc:'Systemic stress gauge across markets; higher = tighter conditions.' },
  { id:'NFCI',       name:'Chicago Fed Financial Conditions', invert:false,cat:'credit',fmt:'raw',  desc:'Tightness across funding & risk appetite; higher = tighter.' },
  { id:'SP500',      name:'S&P 500 index',                 invert:false, cat:'display', fmt:'index',desc:'Level context (display only, not scored in CRC).', exclude:true },
  { id:'VIXCLS',     name:'VIX index',                     invert:false, cat:'vol',    fmt:'pct',  desc:'Equity vol; higher implies pricier crash insurance & fragility.' },
  { id:'UNRATE',     name:'Unemployment rate',             invert:false, cat:'labor',  fmt:'pct',  desc:'Labor slack; rising unemployment historically raises drawdown odds.' },
  { id:'ICSA',       name:'Initial jobless claims (wkly)', invert:false, cat:'labor',  fmt:'int',  desc:'Early labor deterioration often shows in claims first.' },
  { id:'CPIAUCSL',   name:'CPI (headline)',                invert:false, cat:'prices', fmt:'idx',  desc:'Broad inflation; higher keeps policy restrictive longer.' },
  { id:'CPILFESL',   name:'Core CPI',                      invert:false, cat:'prices', fmt:'idx',  desc:'Underlying inflation trend; persistence sustains policy restraint.' },
  { id:'PCEPI',      name:'PCE prices',                    invert:false, cat:'prices', fmt:'idx',  desc:'Fed’s preferred inflation gauge (headline).' },
  { id:'INDPRO',     name:'Industrial production',         invert:true,  cat:'activity',fmt:'idx', desc:'Real activity breadth; softer production raises risk.' },
  { id:'TCU',        name:'Capacity utilization',          invert:true,  cat:'activity',fmt:'pct', desc:'Factory use; falling utilization signals cooling demand.' },
  { id:'RSAFS',      name:'Retail sales (advance)',        invert:true,  cat:'activity',fmt:'int', desc:'Household demand proxy; weakening sales raise risk.' },
  { id:'HOUST',      name:'Housing starts',                invert:true,  cat:'activity',fmt:'int', desc:'Cyclical housing; softer starts indicate slowing demand.' },
  { id:'PERMIT',     name:'Building permits',              invert:true,  cat:'activity',fmt:'int', desc:'Leading housing gauge; weakness flags future softness.' },
  { id:'DTWEXBGS',   name:'Trade‑weighted USD (broad)',    invert:false, cat:'usd',    fmt:'idx', desc:'Stronger USD tightens global financial conditions.' },
  // Buffett (synthetic series)
  { id:'BUFFETT',    name:'Buffett Ratio (Wilshire/GDP)',  invert:false, cat:'valuation',fmt:'pct', desc:'Total market value vs GDP; higher valuation = higher drawdown vulnerability.', synthetic:true }
];

// Weight maps
function weightMap(mode='advanced'){
  const m = {};
  const base = 1;
  INDICATORS.forEach(s=>m[s.id]= base);
  if(mode==='simple') return m;
  if(mode==='basic'){
    scale(m,['T10Y2Y','T10Y3M','DGS10'],1.2);
    scale(m,['BAMLH0A0HYM2','STLFSI4','NFCI'],1.3);
    scale(m,['UNRATE','ICSA'],1.2);
    scale(m,['VIXCLS','DTWEXBGS'],0.7);
    scale(m,['INDPRO','TCU','RSAFS','HOUST','PERMIT'],0.9);
    scale(m,['BUFFETT'],1.1);
    m['SP500']=0;
    return m;
  }
  if(mode==='advanced'){
    scale(m,['T10Y2Y','T10Y3M','DGS10'],1.5);
    scale(m,['BAMLH0A0HYM2','STLFSI4','NFCI'],1.6);
    scale(m,['UNRATE','ICSA'],1.4);
    scale(m,['CPIAUCSL','CPILFESL','PCEPI'],0.9);
    scale(m,['INDPRO','TCU','RSAFS','HOUST','PERMIT'],1.1);
    scale(m,['VIXCLS','DTWEXBGS'],0.8);
    scale(m,['BUFFETT'],1.3);
    m['SP500']=0;
    return m;
  }
  // custom
  try {
    const json = JSON.parse(localStorage.getItem(CUSTOM_WEIGHTS_KEY)||'{}');
    Object.keys(json).forEach(k=>{ if(k in m && typeof json[k]==='number') m[k]=json[k]; });
  } catch(e){}
  m['SP500']=0;
  return m;
}
function scale(map,ids,fac){ ids.forEach(id=>map[id]=(map[id]||1)*fac); }

// helpers
const $ = sel => document.querySelector(sel);
const fmt = {
  pct: v => (v==null||isNaN(v)) ? '—' : (+v).toFixed(2)+'%',
  raw: v => (v==null||isNaN(v)) ? '—' : String(+v),
  idx: v => (v==null||isNaN(v)) ? '—' : (+v).toFixed(3),
  int: v => (v==null||isNaN(v)) ? '—' : (+v).toLocaleString(),
  index:v => (v==null||isNaN(v)) ? '—' : (+v).toLocaleString()
};

// storage
function getKey(){
  const urlKey = new URL(location.href).searchParams.get('key');
  const k = urlKey || localStorage.getItem(KEY_STORAGE) || '';
  if(urlKey) localStorage.setItem(KEY_STORAGE,urlKey);
  return k;
}
function setKey(v){ localStorage.setItem(KEY_STORAGE,v); }

// dates
function dateISO(d){ return d.toISOString().slice(0,10); }
function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d; }
const startDate = dateISO(daysAgo(365*YEARS_BACK));
const endDate = dateISO(new Date());

// cache
function cacheGet(k){
  const raw = localStorage.getItem('CACHE_'+k);
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    if(Date.now()-obj.t > TTL_HOURS*3600*1000) return null;
    return obj.v;
  }catch(e){return null;}
}
function cacheSet(k,v){ localStorage.setItem('CACHE_'+k, JSON.stringify({t:Date.now(),v})); }

// proxy fetch (race)
async function fetchJSON(url){
  // direct first
  const direct = fetch(url,{mode:'cors'}).then(r=>r.ok?r.json():Promise.reject(r.status));
  // proxies
  const allorigins = fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(url)).then(r=>r.ok?r.json():Promise.reject('ao'));
  const codetabs   = fetch('https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(url)).then(r=>r.ok?r.json():Promise.reject('ct'));
  const thingproxy = fetch('https://thingproxy.freeboard.io/fetch/'+encodeURIComponent(url)).then(r=>r.ok?r.json():Promise.reject('tp'));
  try{
    return await Promise.any([direct, allorigins, codetabs, thingproxy]);
  }catch(e){
    // try sequential as fallback
    for(const p of [allorigins, codetabs, thingproxy]){
      try{ return await p; }catch(_){}
    }
    throw new Error('All proxies failed');
  }
}

// FRED observations helper
async function fredSeries(series_id, api_key){
  const cacheK = series_id;
  const c = cacheGet(cacheK);
  if(c) return c;

  const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${series_id}&api_key=${api_key}&file_type=json&observation_start=${startDate}&observation_end=${endDate}`;
  const json = await fetchJSON(url);
  cacheSet(cacheK,json);
  return json;
}

// Concurrency runner
async function runPool(items, limit, worker){
  const ret = [];
  let i=0; let active=0;
  return await new Promise(resolve=>{
    const next = ()=>{
      if(i===items.length && active===0) return resolve(ret);
      while(active<limit && i<items.length){
        const idx=i++; active++;
        worker(items[idx]).then(v=>ret[idx]=v).catch(e=>ret[idx]=null).finally(()=>{active--; next();});
      }
    };
    next();
  });
}

// Percentile (vs last 10y)
function percentile(values, v){
  const arr = values.filter(x=>x!=null && !isNaN(x)).sort((a,b)=>a-b);
  if(!arr.length) return null;
  let lo=0, hi=arr.length-1;
  if(v<=arr[0]) return 0;
  if(v>=arr[hi]) return 100;
  while(hi-lo>1){
    const mid=(lo+hi)>>1;
    if(arr[mid]<=v) lo=mid; else hi=mid;
  }
  return (lo/(arr.length-1))*100;
}

// Exec summary (dynamic)
function buildSummary(scores, deltas, rag, meta){
  const up = [], down = [];
  const add = (arr,label)=>arr.push(label);
  const s = id => scores[id]?.score;

  // drivers up (risk up = higher score)
  if(s('DGS10')>80) add(up,`10‑year yield near the top of its decade range`);
  if(s('T10Y3M')>70||s('T10Y2Y')>70) add(up,`curve tightness still elevated`);
  if(s('BAMLH0A0HYM2')>65||s('NFCI')>60||s('STLFSI4')>60) add(up,`credit stress rising`);
  if(s('BUFFETT')>70) add(up,`valuations rich vs GDP`);

  // drivers down
  if(s('VIXCLS')<35) add(down,`volatility subdued`);
  if(s('UNRATE')<55 && s('ICSA')<55) add(down,`labor remains a buffer`);
  if(s('INDPRO')<40 && s('TCU')<50) add(down,`real‑activity softness not broad‑based`);

  const chg = [];
  Object.entries(deltas).forEach(([id,d])=>{
    if(Math.abs(d)>=6){
      const label = INDICATORS.find(x=>x.id===id)?.name || id;
      chg.push(`${label} ${d>0?'↑':'↓'} ${Math.abs(d).toFixed(0)} pts`);
    }
  });

  const lead = `CRC ${meta.crc.toFixed(0)} — ${rag}. A higher CRC means broader, elevated crash vulnerability versus each indicator’s own last‑decade history.`;

  const upLine = up.length? `Drivers ↑: ${up.slice(0,3).join(' · ')}.` : '';
  const downLine = down.length? `Offsets ↓: ${down.slice(0,3).join(' · ')}.` : '';
  const chgLine = chg.length? `Since last run: ${chg.slice(0,5).join(' · ')}.` : '';
  const watch = `Watch next: curve steepening (front stable, long rates ↑), a decisive jump in HY OAS / stress gauges, and a turn higher in claims confirming softer labor.`;

  return [lead, upLine, downLine, chgLine, watch].filter(Boolean).join(' ');
}

// Chart
let chart;
function renderChart(label, series){
  const ctx = document.getElementById('chart').getContext('2d');
  const labels = series.map(x=>x.date);
  const data = series.map(x=>x.value==null?null:+x.value);
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{label, data, borderColor:'#53a1ff', pointRadius:0, tension:.15}]},
    options:{
      animation:false,
      parsing:false,
      responsive:true,
      scales:{
        x:{ ticks:{ maxTicksLimit:7 }, grid:{ color:'#1c2a3a' } },
        y:{ grid:{ color:'#1c2a3a' } }
      },
      plugins:{
        legend:{ labels:{ color:'#cfe1ff' } },
        zoom:{
          pan:{ enabled:true, mode:'xy' },
          zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'xy' }
        },
        tooltip:{ intersect:false, mode:'index' }
      }
    }
  });
}

// Cards renderer
function renderCards(map){
  const el = $('#cards'); el.innerHTML='';
  INDICATORS.forEach(ind=>{
    const d = map[ind.id] || {};
    const card = document.createElement('div'); card.className='card';
    const val = d.value==null?'—': (ind.fmt==='pct'? (+d.value).toFixed(2)+'%' :
                                   ind.fmt==='int'? (+d.value).toLocaleString():
                                   ind.fmt==='index'? (+d.value).toLocaleString():
                                   ind.fmt==='idx'? (+d.value).toFixed(3):
                                   String(d.value));
    const score = d.score==null ? '—' : Math.round(d.score);
    const date = d.date || '—';
    card.innerHTML = `
      <div class="top">
        <div class="title" style="font-size:18px">${ind.name}</div>
        <span class="chip">${ind.synthetic? 'synthetic':' '+ind.id}</span>
      </div>
      <div class="value">${val}</div>
      <div class="score">score ${score} • <small class="muted">${date}</small></div>
      <div class="help">${ind.desc}</div>`;
    el.appendChild(card);
  });
}

// Gauge
function setGauge(crc){
  const clamp = Math.max(0,Math.min(100,crc));
  const color = clamp<40? 'var(--green)': clamp>70? 'var(--red)': 'var(--amber)';
  const ringPct = Math.max(6, clamp); // small min arc so it’s visible
  const gauge = $('#gauge');
  gauge.style.setProperty('--gaugeColor', color);
  gauge.style.setProperty('--gaugePct', ringPct+'%');
  $('#gNum').textContent = Math.round(clamp);
  $('#crcBadge').textContent = `CRC: ${Math.round(clamp)} — ${clamp<40?'GREEN':clamp>70?'RED':'AMBER'}`;
}

// Buffett ratio (Wilshire / GDP)
async function buffettSeries(api_key){
  const k='BUFFETT_SER';
  const c = cacheGet(k);
  if(c) return c;
  // Wilshire (daily), GDP (quarterly). Carry forward GDP; compute ratio; then monthly sample.
  const wil = await fredSeries('WILL5000IND', api_key);
  const gdp = await fredSeries('GDP', api_key);

  const gdpMap = {};
  gdp.observations.forEach(o=>{
    const v = parseFloat(o.value);
    if(!isNaN(v)) gdpMap[o.date]=v;
  });

  // Carry-forward GDP
  let lastGDP=null;
  const daily = wil.observations.map(o=>{
    const v = parseFloat(o.value);
    if(isNaN(v)) return null;
    // find nearest previous GDP date
    if(gdpMap[o.date]!=null) lastGDP = gdpMap[o.date];
    return lastGDP ? {date:o.date, value: v/lastGDP*100 } : null; // % of GDP (scale not important; percentile handles)
  }).filter(Boolean);

  // Downsample to monthly end
  const byMonth = {};
  daily.forEach(x=>{
    const m = x.date.slice(0,7)+'-28'; // rough month key, we’ll keep last seen
    byMonth[m]=x;
  });
  const series = Object.values(byMonth).sort((a,b)=>a.date.localeCompare(b.date));
  cacheSet(k, series);
  return series;
}

// Run
async function run(){
  const api_key = $('#key').value.trim();
  if(!api_key){ alert('Enter your FRED API key'); return; }
  setKey(api_key);
  $('#run').disabled = true;

  const mode = $('#weightMode').value;
  localStorage.setItem(WEIGHT_MODE_KEY, mode);
  const weights = weightMap(mode);

  const last = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');

  const seriesToFetch = INDICATORS.filter(s=>!s.exclude && !s.synthetic).map(s=>s.id);
  const results = {};

  // pull real series (concurrent)
  await runPool(seriesToFetch, CONCURRENCY, async (sid)=>{
    try{
      const j = await fredSeries(sid, api_key);
      const obs = j.observations.map(o=>{
        const v = parseFloat(o.value); return {date:o.date, value: isNaN(v)? null: v};
      }).filter(Boolean);
      results[sid] = obs;
    }catch(e){ results[sid]=null; }
  });

  // synthetic Buffett
  try{ results['BUFFETT'] = await buffettSeries(api_key); } catch(e){ results['BUFFETT']=null; }

  // compute latest + percentile scores
  const scores = {};
  for(const ind of INDICATORS){
    const arr = results[ind.id];
    if(!arr || !arr.length){ scores[ind.id]={score:null,value:null,date:null}; continue; }
    const values = arr.map(x=>x.value).filter(v=>v!=null);
    const latest = arr[arr.length-1];
    let p = percentile(values, latest.value);
    if(p==null) { scores[ind.id]={score:null,value:null,date:latest.date}; continue; }
    if(ind.invert) p = 100 - p;
    scores[ind.id] = { score:p, value:latest.value, date:latest.date };
  }

  // weighted CRC
  let num=0, den=0;
  Object.entries(scores).forEach(([id,obj])=>{
    if(obj.score==null) return;
    const w = weights[id]||0;
    if(w<=0) return;
    num += obj.score * w;
    den += w;
  });
  const crc = den>0 ? num/den : 0;

  // deltas vs last run
  const deltas = {};
  Object.keys(scores).forEach(id=>{
    const cur = scores[id]?.score;
    const prev = last.scores?.[id]?.score;
    if(cur==null || prev==null) return;
    deltas[id] = cur - prev;
  });

  // render gauge + meta
  const rag = crc<40?'GREEN': crc>70?'RED':'AMBER';
  setGauge(crc);
  $('#runMeta').textContent = `Last run: ${new Date().toLocaleString()} • Data cadence varies (daily/weekly/monthly).`;

  // exec summary
  const summaryText = buildSummary(scores, deltas, rag, {crc});
  $('#summary').textContent = summaryText;

  // cards
  renderCards(scores);

  // chart default
  const chartSel = $('#chartSel').value;
  if(chartSel==='BUFFETT'){
    renderChart('Buffett Ratio', results['BUFFETT']||[]);
  }else{
    renderChart(chartSel, results[chartSel]||[]);
  }

  // history
  const hist = last.history || [];
  hist.push({t:Date.now(), crc});
  if(hist.length>30) hist.shift();

  localStorage.setItem(STORAGE_KEY, JSON.stringify({scores, crc, history:hist}));
  $('#run').disabled = false;
}

// UI wires
(function init(){
  // preload key & weight mode
  $('#key').value = getKey();
  const wm = localStorage.getItem(WEIGHT_MODE_KEY)||'advanced';
  $('#weightMode').value = wm;

  $('#run').addEventListener('click', run);
  $('#chartSel').addEventListener('change', async (e)=>{
    const id = e.target.value;
    const api_key = $('#key').value.trim();
    if(!api_key) return;
    if(id==='BUFFETT'){
      const s = await buffettSeries(api_key);
      renderChart('Buffett Ratio', s);
    }else{
      const j = await fredSeries(id, api_key);
      const arr = j.observations.map(o=>({date:o.date, value: parseFloat(o.value)}));
      renderChart(id, arr);
    }
  });
  $('#historyBtn').addEventListener('click', ()=>{
    const box = $('#history');
    const last = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
    const hist = last.history||[];
    if(!hist.length){ box.textContent='No history yet.'; box.classList.remove('hidden'); return; }
    const lines = hist.slice(-20).map(h=>`${new Date(h.t).toLocaleString()}: CRC ${h.crc.toFixed(0)}`);
    box.textContent = lines.join('\n');
    box.classList.toggle('hidden');
  });

  // auto-run if key present
  if($('#key').value) run();
})();
</script>
</body>
</html>

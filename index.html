<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>The Marshall Stock Market Crash Composite Indicator</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0d1420;--panel:#121a28;--soft:#0e1724;--muted:#95a3be;--text:#e9f0ff;
    --chip:#24324a;--chipText:#cfe0ff;--ringTrack:#1e2a40;
    --green:#17c27d;--amber:#f5a524;--red:#ef4444;--accent:#4c82ff;
    --card:#0f1625;--cardBorder:#1d2a3b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:26px 16px 100px}
  h1{margin:0 0 6px;font-size:clamp(24px,5.6vw,42px);line-height:1.1;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);margin:4px 0 16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{font:600 15px/1 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  input.api{flex:1;min-width:260px;background:var(--soft);border:1px solid var(--ringTrack);color:var(--text);
    padding:12px 14px;border-radius:12px}
  select.mode{background:var(--soft);border:1px solid var(--ringTrack);color:var(--text);
    padding:10px 12px;border-radius:12px}
  button.run{background:var(--accent);border:0;color:#fff;border-radius:12px;padding:12px 16px;font-weight:800}
  .panel{background:var(--panel);border:1px solid var(--ringTrack);border-radius:18px;padding:18px;margin-top:14px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
  .flex{display:flex;gap:16px;align-items:center}
  .gauge{position:relative;width:120px;height:120px;min-width:120px}
  .gauge svg{transform:rotate(-90deg)}
  .gauge .track{stroke:var(--ringTrack)}
  .gauge .arc{stroke-linecap:round;transition:stroke-dashoffset .5s ease,stroke .2s ease}
  .gauge .num{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:28px}
  .badge{display:inline-block;padding:8px 12px;border-radius:12px;font-weight:800}
  .badge.green{background:#123524;color:#98f1c7;border:1px solid #1f7b58}
  .badge.amber{background:#3b2a0a;color:#ffd48f;border:1px solid #6b4b12}
  .badge.red{background:#3a1313;color:#ffbbbb;border:1px solid #6e2b2b}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--cardBorder);border-radius:14px;padding:14px}
  .ind .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .id{background:var(--chip);color:var(--chipText);border-radius:999px;padding:4px 8px;font-size:12px}
  .val{font-size:32px;font-weight:800;letter-spacing:.2px}
  .exec h2{margin:0 0 8px;font-size:22px}
  .exec .body{font-size:17px;line-height:1.7;white-space:pre-wrap}
  .settings{display:grid;gap:10px}
  .pill{display:inline-block;background:var(--chip);color:var(--chipText);padding:4px 8px;border-radius:999px;font-size:12px}
  textarea#custom{width:100%;min-height:110px;background:var(--soft);border:1px solid var(--ringTrack);border-radius:12px;color:var(--text);padding:10px}
  .hidden{display:none!important}
  /* Chart */
  .chartWrap{position:relative;height:260px}
  canvas{display:block;width:100%;height:100%;border-radius:10px;background:#0b1420;border:1px solid #1c2a3a}
  .chartHead{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:8px}
  .miniMeta{color:#bcd2ff;font-size:12px}
  .btn{background:#22314a;color:#cfe0ff;border:1px solid #2b3b58;border-radius:10px;padding:8px 10px;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>The Marshall Stock Market Crash Composite Indicator</h1>
  <div class="sub">U.S. crash-risk dashboard from 20+ economic &amp; market indicators.</div>

  <div class="row">
    <input id="apiKey" class="api" placeholder="YOUR_FRED_API_KEY" autocomplete="off">
    <select id="weightMode" class="mode" title="Weighting">
      <option value="simple">Simple (equal)</option>
      <option value="basic">Basic (balanced)</option>
      <option value="advanced">Advanced (predictive tilt)</option>
      <option value="custom">Custom (JSON)</option>
    </select>
    <button id="runBtn" class="run">Run / Refresh</button>
  </div>

  <div id="customBox" class="panel settings hidden">
    <div class="muted">Paste weights JSON (keys are series IDs). Unknown IDs ignored; weights auto-renormalized to the indicators that loaded.</div>
    <div class="pill">Example: {"T10Y2Y":0.2,"T10Y3M":0.2,"BAMLH0A0HYM2":0.2,"STLFSI4":0.1,"NFCI":0.1,"UNRATE":0.05,"ICSA":0.05,"VIXCLS":0.05,"BUFFETT":0.05}</div>
    <textarea id="custom" spellcheck="false" placeholder='{"T10Y2Y":0.2,"T10Y3M":0.2,"BAMLH0A0HYM2":0.2,"STLFSI4":0.1,"NFCI":0.1,"UNRATE":0.05,"ICSA":0.05,"VIXCLS":0.05,"BUFFETT":0.05}'></textarea>
  </div>

  <!-- CRC + Executive summary (same panel) -->
  <section class="panel exec">
    <div class="flex">
      <div class="gauge">
        <svg width="120" height="120" viewBox="0 0 100 100">
          <circle class="track" cx="50" cy="50" r="44" fill="none" stroke-width="10"/>
          <circle id="arc" class="arc" cx="50" cy="50" r="44" fill="none" stroke-width="10"
                  stroke-dasharray="276.46" stroke-dashoffset="276.46" stroke="#f5a524"/>
        </svg>
        <div id="crcNum" class="num">â€“</div>
      </div>
      <div>
        <div id="crcBadge" class="badge amber">CRC: â€” â€” AMBER</div>
        <div class="muted" style="margin-top:6px">Composite = weighted average of each indicatorâ€™s percentile vs last 10y (with sensible inverts). S&P level is display-only (weight 0).</div>
      </div>
    </div>
    <h2 style="margin:14px 0 6px">Executive Summary</h2>
    <div id="execBody" class="body muted">Paste your key and press Run. The narrative will auto-generate (up to ~1,000 words) from the live readings.</div>

    <!-- History toggle -->
    <div style="margin-top:14px">
      <button id="toggleHist" class="btn">ðŸ“œ Show History</button>
      <span id="histCount" class="miniMeta"></span>
    </div>
    <div id="historyBox" class="hidden" style="margin-top:10px"></div>
  </section>

  <!-- Chart panel -->
  <section class="panel">
    <div class="chartHead">
      <div>
        <strong>FRED Line Chart</strong>
        <div id="chartMeta" class="miniMeta">Select a series to plot the last 2 years.</div>
      </div>
      <div>
        <select id="chartSeries" class="mode">
          <option value="SP500">SP500 (daily)</option>
          <option value="DGS10">DGS10 (10Y yield)</option>
          <option value="T10Y2Y">T10Y2Y (10Yâ€“2Y)</option>
          <option value="T10Y3M">T10Y3M (10Yâ€“3M)</option>
          <option value="BAMLH0A0HYM2">HY OAS</option>
          <option value="VIXCLS">VIX</option>
        </select>
        <button id="refreshChart" class="btn">Refresh Chart</button>
      </div>
    </div>
    <div class="chartWrap">
      <canvas id="chart" width="900" height="400"></canvas>
    </div>
  </section>

  <!-- Indicators -->
  <section class="panel">
    <h2 style="margin:0 0 10px">Indicators</h2>
    <div id="cards" class="grid"></div>
  </section>
</div>

<script>
/* ================= SHARED CONFIG ================= */
const $ = s => document.querySelector(s);
const ringLen = 2*Math.PI*44;
const state = { rows:[], cache:{} }; // cache series by id for charting

/* Indicator set (SP500 is display-only / weight 0) */
const SERIES = [
  // Yield curve & rates
  { id:'T10Y2Y',    name:'10Yâ€“2Y spread',                   invert:true,  type:'pct', cat:'curve' },
  { id:'T10Y3M',    name:'10Yâ€“3M spread',                   invert:true,  type:'pct', cat:'curve' },
  { id:'DGS10',     name:'10Y Treasury yield',              invert:false, type:'pct', cat:'rates' },

  // Credit & stress
  { id:'BAMLH0A0HYM2', name:'ICE BofA HY OAS',              invert:false, type:'pct', cat:'credit' },
  { id:'STLFSI4',   name:'St. Louis Financial Stress (v4)', invert:false, type:'raw', cat:'credit' },
  { id:'NFCI',      name:'Chicago Fed Financial Conditions', invert:false, type:'raw', cat:'credit' },

  // Markets / Valuation
  { id:'VIXCLS',    name:'VIX index',                       invert:false, type:'raw', cat:'markets' },
  { id:'BUFFETT',   name:'â€œBuffettâ€ valuation (Wilshire/GDP)', invert:false, type:'pct', cat:'markets' },
  { id:'SP500',     name:'S&P 500 index (display-only)',    invert:false, type:'raw', cat:'markets', score:false },

  // Labor
  { id:'UNRATE',    name:'Unemployment rate',               invert:false, type:'pct', cat:'labor' },
  { id:'ICSA',      name:'Initial jobless claims (weekly)', invert:false, type:'raw', cat:'labor' },

  // Inflation
  { id:'CPIAUCSL',  name:'CPI (headline)',                  invert:false, type:'raw', cat:'infl' },
  { id:'CPILFESL',  name:'Core CPI',                        invert:false, type:'raw', cat:'infl' },
  { id:'PCEPI',     name:'PCE prices',                      invert:false, type:'raw', cat:'infl' },

  // Real economy (higher = safer â‡’ invert=true)
  { id:'INDPRO',    name:'Industrial production',           invert:true,  type:'raw', cat:'macro' },
  { id:'TCU',       name:'Capacity utilization',            invert:true,  type:'pct', cat:'macro' },
  { id:'RSAFS',     name:'Retail sales (advance)',          invert:true,  type:'raw', cat:'macro' },
  { id:'HOUST',     name:'Housing starts',                  invert:true,  type:'raw', cat:'macro' },
  { id:'PERMIT',    name:'Building permits',                invert:true,  type:'raw', cat:'macro' },

  // FX / Financial conditions
  { id:'DTWEXBGS',  name:'Trade-weighted USD (broad)',      invert:false, type:'raw', cat:'fx' }
];

/* Weighting schemes */
const WEIGHTS = {
  simple: null, // equal by default
  basic: {
    T10Y2Y:0.10, T10Y3M:0.10,
    BAMLH0A0HYM2:0.0833, STLFSI4:0.0833, NFCI:0.0833,
    UNRATE:0.075, ICSA:0.075,
    INDPRO:0.03, TCU:0.03, RSAFS:0.03, HOUST:0.03, PERMIT:0.03,
    CPIAUCSL:0.0333, CPILFESL:0.0333, PCEPI:0.0333,
    VIXCLS:0.05, BUFFETT:0.05,
    DTWEXBGS:0.03, DGS10:0.02, SP500:0
  },
  advanced: {
    T10Y2Y:0.175, T10Y3M:0.175,
    BAMLH0A0HYM2:0.10, STLFSI4:0.10, NFCI:0.10,
    UNRATE:0.05, ICSA:0.05,
    INDPRO:0.016, TCU:0.016, RSAFS:0.016, HOUST:0.016, PERMIT:0.016,
    CPIAUCSL:0.0167, CPILFESL:0.0167, PCEPI:0.0167,
    VIXCLS:0.04, BUFFETT:0.03,
    DTWEXBGS:0.03, DGS10:0.02, SP500:0
  }
};

/* ================= FETCH / PROXY ================= */
const proxiers = [
  u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://cors.isomorphic-git.org/${u}`
];
function fredURL(id,key,start){
  const u = new URL('https://api.stlouisfed.org/fred/series/observations');
  u.searchParams.set('series_id', id);
  u.searchParams.set('api_key', key);
  u.searchParams.set('file_type','json');
  if(start) u.searchParams.set('observation_start', start);
  u.searchParams.set('limit','100000');
  return u.toString();
}
async function fetchRace(url){
  const tries = proxiers.map(p=>fetch(p(url)).then(r=>r.ok?r.json():Promise.reject(r.status)));
  const settled = await Promise.allSettled(tries);
  for(const s of settled){ if(s.status==='fulfilled') return s.value; }
  throw new Error('All proxies failed');
}
async function fredSeries(id,key,years=11){
  const start = new Date(); start.setFullYear(start.getFullYear()-years);
  const txtStart = start.toISOString().slice(0,10);
  const j = await fetchRace(fredURL(id,key,txtStart));
  const obs = (j?.observations||[]).map(o=>({date:o.date,value:o.value})).filter(o=>o.value!=='.');
  const arr = obs.map(o=>({date:o.date,value:+o.value}));
  state.cache[id]=arr; // cache for chart
  return arr;
}

/* Buffett ratio = Wilshire / GDP (quarterly align) */
async function buffettRatio(key){
  const wil = await fredSeries('WILL5000INDFC', key, 12);
  const gdp = await fredSeries('GDP', key, 12); // billions SAAR
  if(!wil.length || !gdp.length) return [];
  const wilByDate = new Map(wil.map(d=>[d.date,d.value]));
  function nearestWil(d){
    let t = new Date(d);
    for(let i=0;i<7;i++){
      const k = t.toISOString().slice(0,10);
      if(wilByDate.has(k)) return wilByDate.get(k);
      t.setUTCDate(t.getUTCDate()-1);
    }
    const prior = wil.filter(x=>x.date<=d).pop();
    return prior? prior.value : wil[wil.length-1].value;
  }
  const ratio = gdp.map(q=>({date:q.date, value:(nearestWil(q.date)/q.value)*100})).filter(x=>Number.isFinite(x.value));
  state.cache['BUFFETT']=ratio;
  return ratio;
}

/* ================= STATS / SCORING ================= */
function lastNumeric(arr){ for(let i=arr.length-1;i>=0;i--){ if(Number.isFinite(arr[i].value)) return arr[i]; } return null; }
function window10y(arr){
  if(!arr.length) return [];
  const last = new Date(arr[arr.length-1].date);
  const cut = new Date(last); cut.setFullYear(cut.getFullYear()-10);
  return arr.filter(d=>new Date(d.date)>=cut);
}
function pctRank(latest, sample){
  if(!Number.isFinite(latest) || !sample.length) return NaN;
  const xs = sample.map(x=>x.value).filter(Number.isFinite).sort((a,b)=>a-b);
  if(!xs.length) return NaN;
  let lo=0,hi=xs.length;
  while(lo<hi){ const m=(lo+hi)>>1; if(xs[m]<=latest) lo=m+1; else hi=m; }
  return 100*(lo/xs.length);
}

/* ================= UI: GAUGE & CARDS ================= */
function setGauge(n){
  const pct = Number.isFinite(n)? Math.max(0,Math.min(100,n)) : 0;
  const offset = ringLen*(1-pct/100);
  const arc = $('#arc'); const num = $('#crcNum'); const badge=$('#crcBadge');
  const band = n>70?'red':(n>=40?'amber':'green');
  const color = band==='red'? getComputedStyle(document.documentElement).getPropertyValue('--red').trim()
              : band==='amber'? getComputedStyle(document.documentElement).getPropertyValue('--amber').trim()
              : getComputedStyle(document.documentElement).getPropertyValue('--green').trim();
  arc.style.strokeDashoffset = offset; arc.style.stroke = color;
  num.textContent = Number.isFinite(n)? Math.round(n) : 'â€“';
  badge.className = 'badge ' + band;
  badge.textContent = Number.isFinite(n)? `CRC: ${Math.round(n)} â€” ${band.toUpperCase()}` : 'CRC: â€”';
}
function makeCard(row){
  const el = document.createElement('div'); el.className='card ind';
  const date = row.latest?.date ?? 'â€”';
  const value = row.latest? row.display : 'â€”';
  const score = Number.isFinite(row.score)? `score ${Math.round(row.score)}` : 'score â€”';
  el.innerHTML = `
    <div class="top"><div><strong>${row.name}</strong> <span class="id">${row.id}</span></div><div class="muted" style="font-size:12px">${date}</div></div>
    <div class="val">${value}</div>
    <div class="muted">${score}</div>
  `;
  return el;
}

/* ================= NARRATIVE ENGINE ================= */
function asPct(v, d=2){ return Number.isFinite(v)? v.toFixed(d)+'%' : 'â€”'; }
function asNum(v){
  return Number.isFinite(v)? (Math.abs(v)>=1000? Intl.NumberFormat('en-US').format(Math.round(v)) : (Math.round(v*1000)/1000).toString()) : 'â€”';
}
function buildNarrative(rows, crc, modeLabel){
  const byId = Object.fromEntries(rows.map(r=>[r.id,r]));
  const s = id => byId[id]?.score;
  const v = id => byId[id]?.latest?.value;
  const band = crc>70?'Red':(crc>=40?'Amber':'Green');
  const parts = [];
  parts.push(`Crash Risk Composite (CRC) prints at ${Math.round(crc)} â€” ${band}. That places overall market conditions in the ${band.toLowerCase()} band on a 0â€“100 scale where higher reflects greater crash vulnerability relative to each indicatorâ€™s own last-decade history. Weighting mode: ${modeLabel}. The gauge is a weighted mean of standardized percentiles, not a forecast; it tells us where we stand within the distribution of recent cycles, and how broad or concentrated the pressure is.`);

  // Curve
  const curveFlags = [];
  if (Number.isFinite(v('T10Y2Y'))) curveFlags.push(`10Yâ€“2Y spread at ${asPct(v('T10Y2Y'))} (score ${Math.round(s('T10Y2Y')||0)})`);
  if (Number.isFinite(v('T10Y3M'))) curveFlags.push(`10Yâ€“3M at ${asPct(v('T10Y3M'))} (score ${Math.round(s('T10Y3M')||0)})`);
  if (curveFlags.length){
    const invNow = (v('T10Y2Y')<0 || v('T10Y3M')<0);
    parts.push(`Yield curves remain ${invNow?'inverted':'tight but not inverted'}, a classic late-cycle configuration. ${curveFlags.join('; ')}. Elevated curve scores indicate policy restraint that historically precedes slower growth. Watch for bear-steepening (long rates up, front stable) as a potential stress trigger for duration-sensitive sectors.`);
  }
  if (Number.isFinite(v('DGS10'))) {
    parts.push(`The 10-year Treasury yield stands at ${asPct(v('DGS10'))} (score ${Math.round(s('DGS10')||0)}). High scores here imply more restrictive real financing costs and a higher hurdle for equity multiples and rate-sensitive activity.`);
  }

  // Credit & Stress
  if (Number.isFinite(v('BAMLH0A0HYM2')) || Number.isFinite(v('STLFSI4')) || Number.isFinite(v('NFCI'))){
    const lines = [];
    if (Number.isFinite(v('BAMLH0A0HYM2'))) lines.push(`High-yield OAS at ${asPct(v('BAMLH0A0HYM2'))} (score ${Math.round(s('BAMLH0A0HYM2')||0)})`);
    if (Number.isFinite(v('STLFSI4')))      lines.push(`St. Louis FSI ${asNum(v('STLFSI4'))} (score ${Math.round(s('STLFSI4')||0)})`);
    if (Number.isFinite(v('NFCI')))         lines.push(`Chicago Fed FCI ${asNum(v('NFCI'))} (score ${Math.round(s('NFCI')||0)})`);
    parts.push(`Credit conditions and systemic stress: ${lines.join('; ')}. Rising scores here usually precede equity drawdowns as refinancing channels tighten and default risk is repriced. A jump in OAS without commensurate movement in the curve typically signals idiosyncratic credit risk; a broad uptick across OAS and stress indices indicates systemic pressure.`);
  }

  // Markets / Valuation
  const mktBits = [];
  if (Number.isFinite(v('SP500')))  mktBits.push(`S&P 500 level ${asNum(v('SP500'))} (display-only)`);
  if (Number.isFinite(v('VIXCLS'))) mktBits.push(`VIX ${asNum(v('VIXCLS'))} (score ${Math.round(s('VIXCLS')||0)})`);
  if (Number.isFinite(v('BUFFETT')))mktBits.push(`â€œBuffettâ€ ratio ${asPct(v('BUFFETT'))} vs GDP (score ${Math.round(s('BUFFETT')||0)})`);
  if (mktBits.length){
    parts.push(`Market internals and valuation context: ${mktBits.join('; ')}. VIX captures near-term crash insurance pricing, while the Buffett ratio anchors long-horizon valuation. A high VIX with low credit stress can be vol-of-vol noise; high valuation with calm credit often leaves markets fragile to macro surprises rather than pricing an imminent shock.`);
  }

  // Labor
  if (Number.isFinite(v('UNRATE')) || Number.isFinite(v('ICSA'))){
    const L = [];
    if (Number.isFinite(v('UNRATE'))) L.push(`unemployment ${asPct(v('UNRATE'),1)} (score ${Math.round(s('UNRATE')||0)})`);
    if (Number.isFinite(v('ICSA')))   L.push(`initial claims ${asNum(v('ICSA'))} (score ${Math.round(s('ICSA')||0)})`);
    parts.push(`Labor remains the core buffer for household demand: ${L.join('; ')}. Because jobs data lags turning points, a creeping rise in claims often provides the earliest confirmation that private-sector momentum is cooling. Sustained deterioration here tends to amplify existing credit and curve signals.`);
  }

  // Inflation
  if (Number.isFinite(v('CPIAUCSL')) || Number.isFinite(v('CPILFESL')) || Number.isFinite(v('PCEPI'))){
    const I = [];
    if (Number.isFinite(v('CPIAUCSL'))) I.push(`headline CPI (score ${Math.round(s('CPIAUCSL')||0)})`);
    if (Number.isFinite(v('CPILFESL'))) I.push(`core CPI (score ${Math.round(s('CPILFESL')||0)})`);
    if (Number.isFinite(v('PCEPI')))    I.push(`PCE prices (score ${Math.round(s('PCEPI')||0)})`);
    parts.push(`Price pressures: ${I.join(', ')}. Higher inflation scores sustain restrictive policy for longer and compress valuation headroom. Disinflation eases policy risk but can coincide with weakening nominal growthâ€”important for earnings resilience.`);
  }

  // Real economy
  const reals = ['INDPRO','TCU','RSAFS','HOUST','PERMIT'].map(id=>({id,sc:s(id)})).filter(x=>Number.isFinite(x.sc));
  if (reals.length){
    const hot = reals.filter(x=>x.sc>60).map(x=>x.id);
    const cool= reals.filter(x=>x.sc<=60).map(x=>x.id);
    parts.push(`Real-activity mix: elevated scores in ${hot.join(', ') || 'none'}, steadier readings in ${cool.join(', ') || 'none'}. These series are inverted (high activity â†’ low risk), so a high score implies softness vs the decade range. Weakening real-economy breadth typically converts a soft-landing narrative into a mid-cycle slowdown or contraction.`);
  }

  // USD
  if (Number.isFinite(v('DTWEXBGS'))){
    parts.push(`Dollar strength sits at a score of ${Math.round(s('DTWEXBGS')||0)}. A firmer USD tightens global financial conditions, weighs on non-U.S. earnings translation, and can pressure commodity-sensitive segments.`);
  }

  // Synthesis
  const sc = rows.filter(r=>r.score!=null && r.id!=='SP500').map(r=>r.score);
  const breadth = (!sc.length) ? 'insufficient'
                   : (sc.filter(x=>x>70).length >= sc.length*0.5 ? 'broadly elevated'
                   : (sc.filter(x=>x<40).length >= sc.length*0.5 ? 'broadly benign' : 'mixed'));
  parts.push(`Putting it together: the CRCâ€™s ${band.toLowerCase()} reading with ${breadth} breadth suggests ${band==='Red'?'defensive posture and liquidity awareness':band==='Amber'?'heightened selectivity and active risk management':'measured risk-taking with guardrails'}. Near-term watch-list: (1) further curve steepening from the front end, (2) a break higher in high-yield OAS or systemic stress indices, and (3) a turn in claims confirming labor softening. A synchronized move would likely push the CRC higher; easing OAS with curve normalization and stable claims would pull it lower.`);

  return parts.join('\n\n');
}

/* ================= WEIGHTING & RENDER ================= */
function fmtValue(row){
  const id=row.id, val=row.latest?.value;
  if(!Number.isFinite(val)) return 'â€”';
  if (['T10Y2Y','T10Y3M','DGS10','BAMLH0A0HYM2','BUFFETT','UNRATE'].includes(id)) return (+val).toFixed(2)+'%';
  if (id==='ICSA') return Intl.NumberFormat('en-US').format(Math.round(val));
  if (id==='VIXCLS') return (+val).toFixed(2);
  return (Math.abs(val)>=1000)? Intl.NumberFormat('en-US').format(Math.round(val)) : (Math.round(val*1000)/1000).toString();
}
function normalizeWeights(mode, rows){
  let base;
  if(mode==='simple') { base = {}; rows.forEach(r=>{ if(r.score!=null) base[r.id]=1; }); }
  else if(mode==='basic' || mode==='advanced'){ base = {...WEIGHTS[mode]}; }
  else { try{ base = JSON.parse($('#custom').value||'{}'); }catch{ base={}; } }

  const usable = rows.filter(r=>r.score!=null).map(r=>r.id);
  const w = {}; usable.forEach(id=> w[id] = Math.max(0, +base[id] || (mode==='simple'?1:0)));
  let sum = Object.values(w).reduce((a,b)=>a+b,0);
  if (sum<=0){ usable.forEach(id=> w[id]=1); sum = usable.length; }
  Object.keys(w).forEach(id=> w[id] = w[id]/sum);
  return w;
}

/* ================= RUN ================= */
async function run(){
  const key = $('#apiKey').value.trim();
  if(!key){ alert('Enter your FRED API key'); return; }
  localStorage.setItem('FRED_KEY', key);

  $('#runBtn').disabled = true; $('#runBtn').textContent = 'Loadingâ€¦';
  $('#cards').innerHTML = ''; $('#execBody').textContent = 'Fetching seriesâ€¦';
  setGauge(0);

  try{
    // Load series (parallel)
    const base = await Promise.all(SERIES.map(async meta=>{
      if (meta.id==='BUFFETT'){
        const series = await buffettRatio(key);
        const latest = lastNumeric(series);
        const win = window10y(series);
        const p = pctRank(latest?.value, win);
        const row = { id:meta.id, name:meta.name, invert:meta.invert, type:meta.type, cat:meta.cat,
                      latest, score: Number.isFinite(p)? (meta.invert?100-p:p) : null };
        row.display = latest? (latest.value.toFixed(2)+'%') : 'â€”';
        return row;
      }
      if (meta.id==='SP500'){
        const series = await fredSeries('SP500', key, 12);
        const latest = lastNumeric(series);
        const row = { id:meta.id, name:meta.name, invert:meta.invert, type:meta.type, cat:meta.cat,
                      latest, score: null };
        row.display = latest? (Math.round(latest.value).toLocaleString()):'â€”';
        return row;
      }
      const series = await fredSeries(meta.id, key, 11);
      const latest = lastNumeric(series);
      const win = window10y(series);
      const p = pctRank(latest?.value, win);
      const row = { id:meta.id, name:meta.name, invert:meta.invert, type:meta.type, cat:meta.cat,
                    latest, score: Number.isFinite(p)? (meta.invert?100-p:p) : null };
      row.display = latest? fmtValue(row) : 'â€”';
      return row;
    }));

    state.rows = base;

    // Weighted CRC
    const mode = $('#weightMode').value;
    const weights = normalizeWeights(mode, base);
    const scored = base.filter(r=>r.score!=null);
    const crc = Math.round(scored.reduce((a,r)=>a + (r.score* (weights[r.id]??0)), 0));
    setGauge(crc);

    // Narrative
    const modeName = ({simple:'Simple (equal)', basic:'Basic (balanced)', advanced:'Advanced (predictive tilt)', custom:'Custom'})[mode];
    const narrative = buildNarrative(base, crc, modeName);
    $('#execBody').textContent = narrative;

    // Save to history (keep last 10)
    const stamp = new Date().toLocaleString();
    const hist = JSON.parse(localStorage.getItem('CRC_HISTORY')||'[]');
    hist.unshift({ ts: stamp, crc, mode: modeName, text: narrative });
    localStorage.setItem('CRC_HISTORY', JSON.stringify(hist.slice(0,10)));
    updateHistory();

    // Cards
    const cards = $('#cards');
    cards.innerHTML = '';
    base.sort((a,b)=> (b.score??-1)-(a.score??-1));
    base.forEach(r=> cards.appendChild(makeCard(r)));

    // Update chart (if series cached for current selection)
    drawChartFromCache();

  }catch(err){
    $('#execBody').textContent = 'Load error (proxy rate limits or network). Try again.';
    console.error(err);
  }finally{
    $('#runBtn').disabled = false; $('#runBtn').textContent = 'Run / Refresh';
  }
}

/* ================= HISTORY (HYBRID) ================= */
function updateHistory(){
  const histWrap = $('#historyBox'); const btn = $('#toggleHist'); const count = $('#histCount');
  const hist = JSON.parse(localStorage.getItem('CRC_HISTORY')||'[]');
  count.textContent = hist.length ? `(${hist.length} saved)` : '(no history yet)';
  histWrap.innerHTML = hist.map(h=>`
    <div class="card" style="margin-top:8px">
      <div class="muted" style="font-size:12px">${h.ts} â€¢ CRC ${h.crc} â€¢ ${h.mode}</div>
      <div style="white-space:pre-wrap;margin-top:8px">${h.text}</div>
    </div>`).join('');
}
$('#toggleHist').addEventListener('click', ()=>{
  $('#historyBox').classList.toggle('hidden');
  $('#toggleHist').textContent = $('#historyBox').classList.contains('hidden') ? 'ðŸ“œ Show History' : 'ðŸ“• Hide History';
});

/* ================= CHART ================= */
function getLastYears(id, years=2){
  const arr = state.cache[id]||[];
  if(!arr.length) return [];
  const lastDate = new Date(arr[arr.length-1].date);
  const cut = new Date(lastDate); cut.setFullYear(cut.getFullYear()-years);
  return arr.filter(d=> new Date(d.date) >= cut);
}
function drawChartFromCache(){
  const id = $('#chartSeries').value;
  const data = getLastYears(id, 2);
  const canvas = $('#chart'); const ctx = canvas.getContext('2d');
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!data.length){
    ctx.fillStyle='#9fb3d9'; ctx.font='14px Inter'; ctx.fillText('No data cached yet. Run the dashboard first.', 16, 24);
    return;
  }
  const pad = {l:48,r:16,t:16,b:30};
  const W = canvas.width - pad.l - pad.r, H = canvas.height - pad.t - pad.b;
  const xs = data.map(d=>new Date(d.date).getTime());
  const ys = data.map(d=>d.value);
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const x = t => pad.l + ( (t-minX)/(maxX-minX) ) * W;
  const y = v => pad.t + (1 - ( (v-minY)/(maxY-minY) )) * H;

  // axes
  ctx.strokeStyle='#213147'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad.l, pad.t); ctx.lineTo(pad.l, pad.t+H); ctx.lineTo(pad.l+W, pad.t+H); ctx.stroke();

  // gridlines
  ctx.strokeStyle='#1a2536';
  for(let i=1;i<5;i++){
    const yy = pad.t + i*H/5;
    ctx.beginPath(); ctx.moveTo(pad.l, yy); ctx.lineTo(pad.l+W, yy); ctx.stroke();
  }

  // line
  ctx.strokeStyle='#6aa3ff'; ctx.lineWidth=2;
  ctx.beginPath();
  data.forEach((d,i)=>{ const xi=x(new Date(d.date).getTime()), yi=y(d.value); i?ctx.lineTo(xi,yi):ctx.moveTo(xi,yi); });
  ctx.stroke();

  // last point + label
  const last = data[data.length-1];
  const lx=x(new Date(last.date).getTime()), ly=y(last.value);
  ctx.fillStyle='#6aa3ff'; ctx.beginPath(); ctx.arc(lx,ly,3,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#bcd2ff'; ctx.font='12px Inter';
  ctx.fillText(`${id}: ${typeof last.value==='number' ? (Math.abs(last.value)>=1000?Math.round(last.value).toLocaleString():last.value.toFixed(2)) : last.value} (${last.date})`, pad.l+8, pad.t+16);
}
$('#refreshChart').addEventListener('click', drawChartFromCache);
$('#chartSeries').addEventListener('change', drawChartFromCache);

/* ================= BOOT ================= */
(function init(){
  const saved = localStorage.getItem('FRED_KEY'); if(saved) $('#apiKey').value = saved;
  $('#runBtn').addEventListener('click', run);
  $('#weightMode').addEventListener('change', e=>{
    const show = e.target.value==='custom';
    $('#customBox').classList.toggle('hidden', !show);
  });
  updateHistory();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Marshall Stock Market Crash Composite Indicator</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e1420; --panel:#121a28; --muted:#94a3b8; --text:#e6edf6;
    --green:#1fc26b; --amber:#f6a723; --red:#f25656; --track:#273043; --brand:#8ecae6;
    --card-radius:16px; --gap:16px;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:860px;margin:0 auto;padding:24px 16px 80px}
  header h1{margin:0 0 8px;font-size:clamp(26px,5.5vw,36px);line-height:1.1}
  header p{margin:0 0 14px;color:var(--muted)}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 14px}
  input,select,button{border-radius:12px;border:1px solid #1f2937;background:#0c1220;color:var(--text);padding:12px 14px}
  input{flex:1;min-width:220px}
  button{background:#3371ff;border-color:#3371ff;font-weight:700}
  .panel{background:var(--panel);border:1px solid #1e293b;border-radius:var(--card-radius);padding:16px;margin-top:var(--gap)}
  .flex{display:flex;gap:16px;align-items:center}
  .crcBadge{font-weight:800;background:#1f2937;padding:8px 12px;border-radius:12px}
  .crcBadge.green{background:color-mix(in oklab,var(--green) 25%,#1f2937)}
  .crcBadge.amber{background:color-mix(in oklab,var(--amber) 25%,#1f2937)}
  .crcBadge.red{background:color-mix(in oklab,var(--red) 25%,#1f2937)}
  /* Gauge (solid color) */
  .gauge{position:relative;width:96px;height:96px}
  .gauge svg{transform:rotate(-90deg)}
  .gTrack{stroke:var(--track);opacity:.9}
  .gBar{stroke-linecap:round;transition:stroke-dashoffset .6s ease,stroke .2s ease}
  .gauge .val{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:20px}
  .gBar.green{stroke:var(--green)}
  .gBar.amber{stroke:var(--amber)}
  .gBar.red{stroke:var(--red)}
  .key li{display:flex;gap:10px;margin:8px 0}
  .dot{width:10px;height:10px;border-radius:50%}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:640px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:#0f1625;border:1px solid #1f2a3b;border-radius:14px;padding:14px}
  .id{display:inline-block;background:#24324a;color:#aab7cf;border-radius:999px;padding:4px 8px;margin-left:8px;font-size:12px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>The Marshall Stock Market Crash Composite Indicator</h1>
    <p>U.S. crash-risk dashboard from 20+ economic &amp; market indicators.</p>
  </header>

  <div class="controls">
    <input id="key" placeholder="YOUR_FRED_API_KEY" value="">
    <select id="proxy">
      <option value="auto" selected>Auto (race)</option>
      <option value="codetabs">Codetabs</option>
      <option value="allorigins">AllOrigins</option>
      <option value="isomorphic">Isomorphic CORS</option>
    </select>
    <button id="run">Run / Refresh</button>
  </div>

  <!-- CRC block -->
  <section class="panel flex" id="crcPanel">
    <div class="gauge" aria-label="CRC gauge">
      <svg width="96" height="96" viewBox="0 0 100 100">
        <circle class="gTrack" cx="50" cy="50" r="44" fill="none" stroke-width="10"/>
        <circle id="gBar" class="gBar amber" cx="50" cy="50" r="44" fill="none" stroke-width="10"
                stroke-dasharray="276.46" stroke-dashoffset="276.46"/>
      </svg>
      <div class="val" id="gVal">–</div>
    </div>
    <div>
      <div id="crcBadge" class="crcBadge amber">CRC: —</div>
      <div class="muted" style="margin-top:6px">Composite = average of indicator percentiles vs last 10y (using sensible inverts).</div>
    </div>
  </section>

  <!-- Exec summary -->
  <section class="panel" id="summaryPanel">
    <h2 style="margin:0 0 8px">Executive Summary</h2>
    <p id="summary" class="muted" style="margin:0">Tap “Run / Refresh”.</p>
  </section>

  <!-- Indicators -->
  <section class="panel">
    <h2 style="margin:0 0 12px">Indicators</h2>
    <div class="grid" id="cards"></div>
  </section>

  <!-- How to read -->
  <section class="panel">
    <h2 style="margin:0 0 10px">How to read the CRC (RAG)</h2>
    <ul class="key" style="list-style:none;padding:0;margin:0">
      <li><span class="dot" style="background:var(--green)"></span><strong>Green &lt; 40</strong><span class="muted"> — Indicators mostly sit in the lower half of their last-10y ranges.</span></li>
      <li><span class="dot" style="background:var(--amber)"></span><strong>Amber 40–70</strong><span class="muted"> — Mixed/deteriorating signals. Tighten risk controls; add selective hedges.</span></li>
      <li><span class="dot" style="background:var(--red)"></span><strong>Red &gt; 70</strong><span class="muted"> — Broad elevation vs last decade; emphasize capital preservation/liquidity.</span></li>
    </ul>
  </section>
</div>

<script>
/* ---------- Config: series + formatting ---------- */
const SERIES = [
  // Yields & curve
  { id:'DGS10',       name:'10Y Treasury yield',              invert:false, fmt:v=>(+v).toFixed(2)+'%' },
  { id:'T10Y2Y',      name:'10Y–2Y spread',                   invert:true,  fmt:v=>(+v).toFixed(2)+'%' },
  { id:'T10Y3M',      name:'10Y–3M spread',                   invert:true,  fmt:v=>(+v).toFixed(2)+'%' },

  // Credit & stress
  { id:'BAMLH0A0HYM2',name:'ICE BofA HY OAS',                 invert:false, fmt:v=>(+v).toFixed(2) },
  { id:'STLFSI4',     name:'St. Louis Financial Stress (v4)', invert:false, fmt:v=>(+v).toFixed(4) },
  { id:'NFCI',        name:'Chicago Fed Financial Conditions', invert:false, fmt:v=>(+v).toFixed(5) },

  // Equities & vol
  { id:'SP500',       name:'S&P 500 index',                   invert:false, fmt:v=>(+v).toLocaleString() },
  { id:'SP500MN',     name:'S&P 500 (monthly avg)',           invert:false, fmt:v=>(+v).toFixed(1) },
  { id:'VIXCLS',      name:'VIX index',                       invert:false, fmt:v=>(+v).toFixed(2) },

  // Labor
  { id:'UNRATE',      name:'Unemployment rate',               invert:false, fmt:v=>(+v).toFixed(1) },
  { id:'ICSA',        name:'Initial jobless claims (wkly)',   invert:false, fmt:v=>(+v).toLocaleString() },

  // Prices
  { id:'CPIAUCSL',    name:'CPI (headline)',                  invert:false, fmt:v=>(+v).toFixed(3) },
  { id:'CPILFESL',    name:'Core CPI',                        invert:false, fmt:v=>(+v).toFixed(3) },
  { id:'PCEPI',       name:'PCE prices',                      invert:false, fmt:v=>(+v).toFixed(3) },

  // Real economy (higher = safer ⇒ invert)
  { id:'INDPRO',      name:'Industrial production',           invert:true,  fmt:v=>(+v).toFixed(3) },
  { id:'TCU',         name:'Capacity utilization',            invert:true,  fmt:v=>(+v).toFixed(2) },
  { id:'RSAFS',       name:'Retail sales (advance)',          invert:true,  fmt:v=>(+v).toLocaleString() },
  { id:'HOUST',       name:'Housing starts',                  invert:true,  fmt:v=>(+v).toLocaleString() },
  { id:'PERMIT',      name:'Building permits',                invert:true,  fmt:v=>(+v).toLocaleString() },

  // Sentiment (lower = riskier ⇒ invert)
  { id:'UMCSENT',     name:'UMich consumer sentiment',        invert:true,  fmt:v=>(+v).toFixed(1) },

  // Dollar (stronger = tighter ⇒ treat as risk-up-when-high)
  { id:'DTWEXBGS',    name:'Trade-weighted USD (broad)',      invert:false, fmt:v=>(+v).toFixed(4) }
];

/* ---------- Helpers ---------- */
const $ = sel => document.querySelector(sel);
const ringLen = 2*Math.PI*44;

function rankPctile(arr, value){
  // arr = array of numeric strings; value = latest numeric string
  const xs = arr.filter(v=>v!=='.').map(x=>+x).sort((a,b)=>a-b);
  if (!xs.length) return NaN;
  const v = +value;
  let idx = xs.findIndex(x=>v<=x);
  if (idx<0) idx = xs.length-1;
  const pct = 100*(idx/(xs.length-1 || 1));
  return Math.max(0, Math.min(100, pct));
}

function ragColor(n){ return n>70 ? 'red' : n>=40 ? 'amber' : 'green'; }

function setGauge(n){
  const pct = isFinite(n)? Math.max(0,Math.min(100, n)) : 0;
  const offset = ringLen*(1-pct/100);
  const bar = $('#gBar'); const val = $('#gVal'); const badge = $('#crcBadge');
  bar.style.strokeDasharray = ringLen;
  bar.style.strokeDashoffset = offset;
  bar.classList.remove('green','amber','red');
  const cls = ragColor(n);
  bar.classList.add(cls);
  val.textContent = isFinite(n)? Math.round(n) : '–';
  badge.textContent = isFinite(n)? `CRC: ${Math.round(n)} — ${cls.toUpperCase()}` : 'CRC: —';
  badge.classList.remove('green','amber','red'); badge.classList.add(cls);
}

/* ---------- Fetch (proxy race) ---------- */
const proxiers = {
  codetabs:(url)=>`https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(url)}`,
  allorigins:(url)=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  isomorphic:(url)=>`https://cors.isomorphic-git.org/${url}`,
};

async function fredSeries(id, key, prox='auto'){
  const base = `https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${key}&file_type=json&observation_start=${new Date(Date.now()-31557600000*11).toISOString().slice(0,10)}&limit=100000`;
  const urls = prox==='auto'
    ? [proxiers.codetabs(base), proxiers.allorigins(base), proxiers.isomorphic(base)]
    : [proxiers[prox]? proxiers[prox](base) : base];

  // Race attempts
  for (const u of urls){
    try{
      const r = await fetch(u, {mode:'cors'});
      if (!r.ok) continue;
      const j = await r.json();
      if (j && j.observations && j.observations.length>1) return j;
    }catch(e){}
  }
  throw new Error('Load failed');
}

/* ---------- UI build ---------- */
function makeCard(s){
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:8px;align-items:baseline">
      <div><strong>${s.name}</strong><span class="id">${s.id}</span></div>
      <div class="muted" style="font-size:12px" id="d_${s.id}">—</div>
    </div>
    <div style="margin-top:6px;font-size:28px;font-weight:800" id="v_${s.id}">—</div>
    <div class="muted" style="margin-top:2px;font-size:13px" id="s_${s.id}">score —</div>
  `;
  return el;
}
SERIES.forEach(s => $('#cards').appendChild(makeCard(s)));

/* ---------- Run ---------- */
async function run(){
  const key = $('#key').value.trim();
  const prox = $('#proxy').value;
  $('#summary').textContent = 'Loading…';
  setGauge(NaN);

  const results = [];
  for (const s of SERIES){
    try{
      const j = await fredSeries(s.id, key, prox);
      const obs = j.observations.filter(o=>o.value!=='.');
      const latest = obs[obs.length-1];
      const seriesVals = obs.map(o=>o.value);
      const pct = rankPctile(seriesVals, latest.value);
      const score = s.invert ? 100 - pct : pct;
      results.push({ id:s.id, name:s.name, latest, score, fmt:s.fmt });

      // paint card
      $(`#v_${s.id}`).textContent = s.fmt(latest.value);
      $(`#d_${s.id}`).textContent = latest.date;
      $(`#s_${s.id}`).textContent = `score ${Math.round(score)}`;
    }catch(e){
      $(`#v_${s.id}`).textContent = '—';
      $(`#s_${s.id}`).textContent = 'score —';
    }
  }

  const used = results.filter(r=>Number.isFinite(r.score));
  const crc = used.length ? used.reduce((a,b)=>a+b.score,0)/used.length : NaN;
  setGauge(crc);
  $('#crcBadge').title = `Based on ${used.length}/${SERIES.length} indicators`;

  // Executive summary (≤ ~80 words)
  $('#summary').textContent = summarize(used, crc);
}

/* ---------- Simple summary generator ---------- */
function summarize(items, crc){
  const get = id => items.find(x=>x.id===id);
  const s = (id)=>get(id)?.score ?? NaN;

  const curveTight = (s('T10Y2Y')>60 || s('T10Y3M')>60);
  const creditTight = (s('BAMLH0A0HYM2')>60 || s('STLFSI4')>60 || s('NFCI')>60);
  const equityHot   = (s('SP500')>80 || s('SP500MN')>80);
  const laborOK     = (s('UNRATE')<60 && s('ICSA')<60);
  const inflationOK = (s('CPIAUCSL')<50 && s('CPILFESL')<50 && s('PCEPI')<50);
  const activityOK  = (s('INDPRO')<40 && s('TCU')<50 && s('RSAFS')<50 && s('HOUST')<60 && s('PERMIT')<60);
  const usdTight    = s('DTWEXBGS')>60;

  const bits = [];
  if (curveTight)   bits.push('Curve remains tight/inverted, keeping recession risk elevated');
  if (creditTight)  bits.push('Credit conditions/stress are firm; watch HY spreads');
  if (equityHot)    bits.push('Equities look stretched and volatile');
  if (!laborOK)     bits.push('Labor is softening around the edges');
  if (!inflationOK) bits.push('Inflation pressures linger');
  if (!activityOK)  bits.push('Real-economy momentum is uneven');
  if (usdTight)     bits.push('Stronger USD implies tighter global financial conditions');

  const label = ragColor(crc).toUpperCase();
  const lead  = `CRC ${Math.round(crc)} — ${label}.`;
  const tail  = bits.length ? bits.join('. ') + '.' : 'Signals are mixed; no single driver dominates.';
  return `${lead} ${tail}`;
}

/* ---------- Init ---------- */
document.getElementById('run').addEventListener('click', run);
document.getElementById('key').value = localStorage.getItem('FRED_KEY') || '';
document.getElementById('key').addEventListener('change', e=>{
  localStorage.setItem('FRED_KEY', e.target.value.trim());
});
</script>
</body>
</html>

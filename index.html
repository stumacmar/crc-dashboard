<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marshall WBCI — World’s Best Crash Indicator</title>
<style>
:root{
  --bg:#0d1722; --panel:#0f1b27; --card:#102133; --edge:#1b2c3d;
  --text:#eaf0f6; --muted:#a8b6c6; --blue:#3a83ff;
  --green:#2ecc71; --amber:#f4b740; --red:#ff5565;
  --grid:#273244; --accent:#8ab6ff; --accentFill:rgba(138,182,255,.18);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
h1{font:800 clamp(22px,5vw,36px)/1.15 system-ui;margin:20px 0}
h2{font:700 20px/1.25 system-ui;margin:0 0 10px}
.container{max-width:1000px;margin:0 auto;padding:16px}
.panel{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{padding:12px 14px;border:1px solid var(--edge);border-radius:12px;background:#0b1620;color:var(--text)}
input{flex:1 1 280px}
select{flex:0 0 260px}
button{padding:12px 18px;border:0;border-radius:12px;background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;padding:8px 12px;border-radius:12px;background:#1b2636;border:1px solid var(--edge);font-weight:800}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:999px;background:#152234;border:1px solid #243449;color:#b8c8d8;font-weight:700}

.gauge{width:min(150px,32vw);min-width:120px;aspect-ratio:1/1;border-radius:50%;
  background:conic-gradient(var(--amber) 0 0,#223041 0 360deg);position:relative;flex:0 0 auto}
.gauge>.hole{position:absolute;inset:12px;aspect-ratio:1/1;border-radius:50%;
  background:var(--bg);border:1px solid var(--edge);display:flex;align-items:center;justify-content:center;
  font:800 clamp(22px,6vw,36px)/1 system-ui}

.grid{display:grid;gap:14px}
@media(min-width:680px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
@media(min-width:980px){ .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;position:relative;overflow:hidden}
.kv{display:flex;justify-content:space-between;gap:8px;align-items:center}
.series{font:700 18px/1.2 system-ui}
.sub{display:flex;gap:10px;align-items:center;color:var(--muted)}
.vline{position:absolute;left:0;top:0;bottom:0;width:4px}
.v-green{background:linear-gradient(90deg,#1f8f5f,#2ecc71)}
.v-amber{background:linear-gradient(90deg,#9b7a17,#f4b740)}
.v-red{background:linear-gradient(90deg,#a11c2a,#ff5565)}
.bandbar{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red));opacity:.9}
.explain{margin-top:8px;color:var(--muted)}
ul.clean{margin:0 0 0 18px;padding:0;display:grid;gap:6px}
.err{background:#3b1b23;border:1px solid #5a2a37;color:#ffd7de;padding:10px 12px;border-radius:12px;margin-top:10px}

.chart-wrap{position:relative;height:180px;margin:8px 0}
footer{margin:18px 0 12px;text-align:center;color:#7f91a6;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h1>Marshall WBCI — World’s Best Crash Indicator</h1>

  <div class="panel">
    <div class="row">
      <input id="fredKey" type="text" placeholder="FRED API key (saved locally)"/>
      <select id="mode">
        <option value="advanced">Advanced (predictive tilt + sync/shock)</option>
        <option value="simple">Simple (equal weights)</option>
      </select>
      <button id="runBtn">Run / Refresh</button>
    </div>
    <div id="topErr" class="err" style="display:none"></div>
  </div>

  <div class="panel">
    <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap">
      <div class="gauge"><div id="wcbiNum" class="hole">--</div></div>
      <div>
        <div class="chips">
          <div id="bandChip" class="chip">Band: —</div>
          <div id="breadthChip" class="chip">Breadth: —</div>
          <div id="syncChip" class="chip">Synchronicity: —</div>
          <div id="shockChip" class="chip">Shock: —</div>
        </div>
        <div id="runMeta" class="muted" style="margin-top:10px">
          Scores = percentiles vs each series’ last 10 years (with sensible inverts). Enhancers: Breadth, Synchronicity, Shock.
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Executive Summary</h2>
    <div id="execBody" class="muted">Run to generate a live CIO‑style note.</div>
  </div>

  <div class="panel">
    <h2>Categories</h2>
    <div id="cards" class="grid cols-2 cols-3"></div>
  </div>

  <footer>Marshall WBCI • Built on public FRED data</footer>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0"></script>

<script>
/* ====================== Config ====================== */
const CATS = [
  { id:'rates',    name:'Rates / Curve',      why:'Tight/inverted curves + high long rates raise crash risk via refinancing & valuation pressure.' },
  { id:'credit',   name:'Credit / Stress',    why:'Credit spreads & systemic stress typically lead equity drawdowns.' },
  { id:'liquidity',name:'Liquidity',          why:'When market depth falters, sell‑offs accelerate.' },
  { id:'usd',      name:'USD / External',     why:'Strong USD tightens global conditions and can trigger funding squeezes.' },
  { id:'energy',   name:'Energy Shock',       why:'Energy burden spikes often precede recessions and earnings downgrades.' },
  { id:'house',    name:'Labor / Household',  why:'Rising claims & delinquencies erode the demand buffer.' },
  { id:'act',      name:'Activity / Sentiment', why:'Softening activity/confidence increases vulnerability to shocks.' }
];
// FRED series per category (public, stable)
const SERIES = {
  rates:   ['DGS10','T10Y2Y','T10Y3M'],
  credit:  ['BAMLH0A0HYM2','STLFSI4','NFCI'],
  liquidity:['SOFR','RRPONTSYD'],             // SOFR (since 2018), ON RRP as proxy for money conditions
  usd:     ['DTWEXBGS'],
  energy:  ['DCOILWTICO','DHHNGSP'],
  house:   ['UNRATE','ICSA','W875RX1'],       // real income ex‑transfers (invert)
  act:     ['INDPRO','TCU','RSAFS','PERMIT','UMCSENT']
};
// Invert where “higher = safer/stronger” so score always means “higher = riskier”
const INVERT = new Set(['INDPRO','TCU','RSAFS','PERMIT','UMCSENT','W875RX1']);

/* ====================== Helpers ====================== */
const $ = s=>document.querySelector(s);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const mean=a=>a.length? a.reduce((x,y)=>x+y,0)/a.length : 0;
const stdev=a=>{ if(a.length<2) return 1; const m=mean(a); return Math.sqrt(mean(a.map(v=>(v-m)*(v-m))))||1; };
function band(score){ if(score==null) return {name:'—', color:'#445', cls:''};
  if(score<40) return {name:'Green', color:'var(--green)', cls:'v-green'};
  if(score<=70) return {name:'Amber', color:'var(--amber)', cls:'v-amber'};
  return {name:'Red', color:'var(--red)', cls:'v-red'};}
function monthKey(d){ return d.toISOString().slice(0,7); }
function resampleMonthly(obs){ const map=new Map(); for(const o of obs){ map.set(monthKey(o.date), o); } return [...map.entries()].sort((a,b)=>a[0]<b[0]?-1:1).map(e=>({date:new Date(e[0]+'-01'), value:e[1].value})); }
function percentileRank(values, x){ const arr=values.filter(Number.isFinite).slice().sort((a,b)=>a-b); if(!arr.length||!Number.isFinite(x)) return null;
  let lo=0,hi=arr.length; while(lo<hi){const m=(lo+hi>>1); if(arr[m]<=x) lo=m+1; else hi=m;} return Math.round(100*lo/arr.length); }

/* ====================== FRED fetch (parallel + proxy) ====================== */
const proxies=[u=>u,u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),u=>'https://api.codetabs.com/v1/proxy/?quest='+encodeURIComponent(u)];
function fredURL(series, key, start){ const u=new URL('https://api.stlouisfed.org/fred/series/observations'); u.searchParams.set('series_id',series); u.searchParams.set('api_key',key); u.searchParams.set('file_type','json'); u.searchParams.set('observation_start',start); u.searchParams.set('_t',Date.now()); return u.toString(); }
function timeout(ms,p){ return Promise.race([p,new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),ms))]); }
async function getSeries(series, key, startISO){
  const url = fredURL(series, key, startISO);
  let lastErr=null;
  for(const wrap of proxies){
    try{
      const r = await timeout(9000, fetch(wrap(url),{mode:'cors',cache:'no-store'}));
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      const obs = (j.observations||[]).map(o=>({date:new Date(o.date), value: o.value==='.'? null : +o.value})).filter(x=>x.value!=null);
      return obs;
    }catch(e){ lastErr=e; }
  }
  throw lastErr||new Error('fetch failed '+series);
}

/* ====================== Scoring & enhancers ====================== */
function scoreSeries(obs, invert){
  const vals = obs.map(o=>o.value);
  const latest = vals.at(-1);
  let p = percentileRank(vals, latest);
  if(p==null) return null;
  if(invert) p = 100 - p;
  return clamp(p,0,100);
}
function buildCategoryScores(raw){
  // raw: { seriesId: monthlyObs[] }
  const catScore={}, catMonthly={};
  for(const c of CATS){
    const ids = SERIES[c.id];
    const percs=[], alignedLen=[];
    const monthlySeries = [];
    for(const sid of ids){
      const m = raw[sid]||[];
      if(!m.length) continue;
      const s = scoreSeries(m, INVERT.has(sid));
      if(s!=null) percs.push(s);
      // keep last 24 months for plots
      monthlySeries.push(m.slice(-24));
      alignedLen.push(monthlySeries.at(-1).length);
    }
    catScore[c.id] = percs.length? Math.round(mean(percs)) : null;

    // merge to single spark (avg) by index
    const len = alignedLen.length? Math.min(...alignedLen) : 0;
    const merged=[];
    for(let i=0;i<len;i++){
      const avg = mean(monthlySeries.map(arr=>arr[arr.length-len+i].value));
      const d   = monthlySeries[0][monthlySeries[0].length-len+i].date;
      merged.push({date:d, value:avg});
    }
    catMonthly[c.id]=merged;
  }
  return {catScore, catMonthly};
}
function computeBreadth(catScore){ const xs=Object.values(catScore).filter(v=>v!=null); if(!xs.length) return 0; return xs.filter(v=>v>=70).length/xs.length; }
function computeBase(catScore, mode){
  const w = (id)=>({credit:1.4, rates:1.3, liquidity:1.2, house:1.1, usd:1.0, energy:1.0, act:0.9}[id]||1);
  const items = Object.entries(catScore).filter(([_,v])=>v!=null);
  if(!items.length) return null;
  if(mode==='simple') return Math.round(mean(items.map(([_,v])=>v)));
  const W = items.reduce((a,[k,v])=>a+w(k),0);
  return Math.round(items.reduce((a,[k,v])=>a+w(k)*v,0)/W);
}
// monthly category series → synchronicity & shock
function computeSync(catMonthly, catScore){
  const actives = Object.keys(catMonthly).filter(k=> (catScore[k]??0)>=60);
  if(actives.length<2) return 0;
  // align on common dates
  const dates = [...new Set(actives.flatMap(k=>catMonthly[k].map(p=>p.date.getTime())))].sort((a,b)=>a-b);
  const rows = actives.map(k=>{
    const map = new Map(catMonthly[k].map(p=>[p.date.getTime(),p.value]));
    return dates.map(t=> map.get(t) ?? null);
  });
  const keep = []; for(let i=0;i<dates.length;i++){ if(rows.every(r=>r[i]!=null)) keep.push(i); }
  if(keep.length<6) return 0;
  const A = rows.map(r=> keep.map(i=>r[i]));
  const cors=[];
  for(let i=0;i<A.length;i++) for(let j=i+1;j<A.length;j++){
    const a=A[i], b=A[j]; const ma=mean(a), mb=mean(b);
    const num=a.reduce((s,_,k)=>s+(a[k]-ma)*(b[k]-mb),0);
    const den=Math.sqrt(a.reduce((s,_,k)=>s+(a[k]-ma)**2,0))*Math.sqrt(b.reduce((s,_,k)=>s+(b[k]-mb)**2,0));
    cors.push(den? num/den : 0);
  }
  return clamp(mean(cors),0,1);
}
function computeShock(catMonthly){
  // 3m delta z-score, positives only, averaged and scaled to 0..100
  const zs=[];
  for(const arr of Object.values(catMonthly)){
    if(arr.length<6) continue;
    const vals=arr.map(p=>p.value);
    const deltas=[]; for(let i=3;i<vals.length;i++) deltas.push(vals[i]-vals[i-3]);
    if(deltas.length<3) continue;
    const mu=mean(deltas), sd=stdev(deltas);
    const lastZ=(deltas.at(-1)-mu)/(sd||1);
    if(lastZ>0) zs.push(lastZ);
  }
  const z=zs.length? mean(zs):0;
  return clamp(Math.round((z/2.5)*100),0,100);
}
function computeWBCI(base,sync,breadth,shock){ if(base==null) return null; const x = base*(1+0.4*sync+0.25*breadth)+0.25*shock; return clamp(Math.round(x),0,100); }

/* ====================== Charts ====================== */
function makeSpark(canvas, data, color){
  const ctx = canvas.getContext('2d');
  const labels = data.map(p=>p.date);
  const values = data.map(p=>p.value);
  return new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{ data:values, borderColor:color, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--accentFill').trim(), fill:true, tension:.25, pointRadius:0, borderWidth:2 }]},
    options:{
      responsive:true, maintainAspectRatio:false, parsing:false, normalized:true,
      scales:{
        x:{ type:'time', grid:{color:'rgba(255,255,255,.05)'}, ticks:{color:'var(--muted)', maxTicksLimit:4}},
        y:{ grid:{color:'rgba(255,255,255,.06)'}, ticks:{color:'var(--muted)', maxTicksLimit:4}}
      },
      plugins:{
        legend:{display:false},
        tooltip:{mode:'index',intersect:false,backgroundColor:'rgba(15,23,42,.92)',titleColor:'#cbd5e1',bodyColor:'#e5e7eb',
                 callbacks:{ label:(ctx)=> ctx.parsed.y!=null? ctx.parsed.y.toFixed(2):'—' } },
        zoom:{ zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'}, pan:{enabled:true,mode:'x'} }
      }
    }
  });
}

/* ====================== UI ====================== */
function paintGauge(x){
  $('#wcbiNum').textContent = x==null?'--':x;
  const b = band(x);
  const deg = x==null?0:Math.max(3,Math.min(360,Math.round(x/100*360)));
  document.querySelector('.gauge').style.background = `conic-gradient(${b.color} 0 ${deg}deg,#223041 ${deg}deg 360deg)`;
  $('#bandChip').textContent = `Band: ${b.name}`;
}
function renderCards(catScore, catMonthly){
  const wrap=$('#cards'); wrap.innerHTML='';
  for(const c of CATS){
    const s = catScore[c.id];
    const b = band(s);
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class="vline ${b.cls}"></div>
      <div class="kv">
        <div class="series">${c.name}</div>
        <div class="badge" style="background:#152234;border-color:#223345">${s==null?'—':s}</div>
      </div>
      <div class="chart-wrap"><canvas id="spark_${c.id}"></canvas></div>
      <div class="bandbar"></div>
      <div class="explain"><b>Baseline:</b> ${b.name}. <span class="muted">${c.why}</span></div>
    `;
    wrap.appendChild(div);
    const data = catMonthly[c.id]||[];
    if(data.length){
      makeSpark(div.querySelector('canvas'), data, b.color);
    }
  }
}
function writeExecNoteSimple(base, breadth, sync, shock, catScore){
  const bandName = band(base||0).name;
  const cats = Object.entries(catScore).filter(([_,v])=>v!=null).sort((a,b)=>b[1]-a[1]);
  const top = cats.slice(0,3).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`);
  const low = cats.slice(-2).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`);
  const breadthNote = breadth>0.5 ? 'Risk is broad.' : breadth>0.2 ? 'Risk is spreading.' : 'Risk is concentrated.';
  const syncNote = sync>0.6 ? 'Many areas are moving together (late‑cycle feel).' : sync>0.3 ? 'Some clustering, not yet systemic.' : 'Little co‑movement right now.';
  const shockNote = shock>60 ? 'Conditions have worsened quickly.' : shock>30 ? 'Momentum is turning.' : 'Changes are gradual.';
  const stance = (()=> {
    if(base>=70 || (breadth>0.4 && sync>0.5)) return 'Defensive: raise cash quality, shorten duration, add crash hedges.';
    if(base>=50) return 'Cautious: run tighter risk, favor quality balance sheets, keep selective hedges.';
    return 'Constructive but alert: use dips selectively; keep light hedges; watch the triggers.';
  })();
  const bullets = [
    `<b>Today’s take:</b> Base ${base==null?'—':base} — <b>${bandName}</b>. Breadth ${Math.round(breadth*100)}%, Synchronicity ${Math.round(sync*100)}%, Shock ${shock}.`,
    `<b>What this means:</b> ${breadthNote} ${syncNote} ${shockNote}`,
    `<b>What’s driving it:</b> ${top.join('; ')}${low.length?`. Offsets: ${low.join('; ')}`:''}.`,
    `<b>Watch next:</b> (1) front‑anchored curve steepening, (2) clear HY OAS/systemic‑stress widening, (3) persistent rise in weekly claims.`,
    `<b>Portfolio stance:</b> ${stance}`
  ];
  $('#execBody').innerHTML = `<ul class="clean">${bullets.map(x=>`<li>${x}</li>`).join('')}</ul>`;
}

/* ====================== Run ====================== */
function loadKey(){ const k=localStorage.getItem('fred_key'); if(k) $('#fredKey').value=k; }
function saveKey(){ const k=$('#fredKey').value.trim(); if(k) localStorage.setItem('fred_key',k); }
function startISO(){ const d=new Date(); d.setFullYear(d.getFullYear()-10); return d.toISOString().slice(0,10); }

async function run(){
  $('#topErr').style.display='none'; $('#topErr').textContent='';
  const key=$('#fredKey').value.trim(); if(!key) { alert('Enter your FRED API key'); return; }
  saveKey();
  $('#runBtn').disabled=true; $('#runBtn').textContent='Running…';

  const start = startISO();
  // 1) Pull all series in parallel, resample monthly immediately (for speed/memory)
  const allIds = [...new Set(Object.values(SERIES).flat())];
  const jobs = allIds.map(id => getSeries(id, key, start)
    .then(obs => ({id, data: resampleMonthly(obs)}))
    .catch(err => ({id, error: err})));
  const settled = await Promise.all(jobs);

  const raw={}; const fails=[];
  for(const r of settled){
    if(r.error || !r.data?.length){ fails.push(r.id); continue; }
    raw[r.id]=r.data;
  }

  // 2) Build category scores & monthly series
  const {catScore, catMonthly} = buildCategoryScores(raw);

  // 3) Enhancers
  const breadth = computeBreadth(catScore);
  const sync    = computeSync(catMonthly, catScore);
  const shock   = computeShock(catMonthly);

  // 4) Base & Final
  const mode = $('#mode').value;
  const base = computeBase(catScore, mode);
  const wcbi = computeWBCI(base, sync, breadth, shock);

  // 5) Paint
  paintGauge(wcbi);
  $('#breadthChip').textContent = `Breadth: ${Math.round(breadth*100)}%`;
  $('#syncChip').textContent    = `Synchronicity: ${Math.round(sync*100)}%`;
  $('#shockChip').textContent   = `Shock: ${shock}`;
  $('#runMeta').textContent     = `Last run: ${new Date().toLocaleString()} • Mode: ${mode} • Categories loaded: ${Object.values(catScore).filter(v=>v!=null).length}/${CATS.length}`;
  renderCards(catScore, catMonthly);
  writeExecNoteSimple(base, breadth, sync, shock, catScore);

  if(fails.length){
    $('#topErr').style.display='block';
    $('#topErr').textContent = `Loaded with partial data (timed‑out/empty: ${fails.join(', ')}). Hit Run again if needed.`;
  }
  $('#runBtn').disabled=false; $('#runBtn').textContent='Run / Refresh';
}

document.getElementById('runBtn').addEventListener('click', run);
loadKey();
</script>
</body>
</html>

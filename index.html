<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marshall WBCI — World’s Best Crash Indicator</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --amber:#f59e0b; --green:#22c55e; --red:#ef4444; --chip:#1f2937; --chipText:#cbd5e1;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:clamp(22px,3.5vw,36px);line-height:1.2;margin:0 0 18px}
  .controls{background:var(--panel);border-radius:16px;padding:16px;margin-bottom:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type="text"]{flex:1;min-width:280px;background:#0b1220;border:1px solid #202b40;color:var(--text);padding:10px 12px;border-radius:10px}
  select{background:#0b1220;border:1px solid #202b40;color:var(--text);padding:10px 12px;border-radius:10px}
  button{background:#3b82f6;border:none;color:#fff;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:800px){.grid{grid-template-columns:1.2fr 2fr}}
  .card{background:var(--panel);border-radius:16px;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .chip{background:var(--chip);color:var(--chipText);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
  .ring{position:relative;width:152px;height:152px}
  .ring svg{width:100%;height:100%}
  .ring .num{position:absolute;inset:0;display:grid;place-items:center;font-size:36px;font-weight:800}
  .kvs{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .kvs .chip{font-weight:800}
  h2{margin:0 0 10px}
  .summary p{margin:.5rem 0;color:var(--text);}
  .cats{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:800px){.cats{grid-template-columns:1fr 1fr}}
  .cat-card{background:#0b1220;border:1px solid #1f2a3f;border-radius:14px;padding:14px;position:relative}
  .cat-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .score-badge{font-weight:800;background:#101a2e;color:#c9d4ec;border:1px solid #223150;padding:4px 10px;border-radius:999px}
  .baseline{font-size:14px;color:#c7cad2;margin-top:6px}
  .bar{height:6px;border-radius:6px;background:linear-gradient(90deg,#16a34a,#f59e0b 50%,#ef4444);opacity:.85;margin:8px 0 6px}
  .cat-note{font-size:13px;color:#bfc6d8;margin-top:6px}
  .footer{color:#9aa4bd;font-size:12px;text-align:center;margin:18px 0}
  canvas{width:100%;height:80px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Marshall WBCI — World’s Best Crash Indicator</h1>

    <div class="controls">
      <input id="apiKey" type="text" placeholder="(Optional) FRED API key" />
      <select id="mode">
        <option value="advanced">Advanced (predictive tilt + synchronicity)</option>
        <option value="basic">Basic (equal weight)</option>
      </select>
      <button id="runBtn">Run / Refresh</button>
      <button id="resetBtn" style="background:#64748b">Reset Cache</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div class="ring" id="ring">
            <svg viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="54" stroke="#0b1220" stroke-width="12" fill="none"/>
              <circle id="arc" cx="60" cy="60" r="54" stroke="#f59e0b" stroke-width="12" fill="none"
                      stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="339.292" stroke-dashoffset="339.292"/>
            </svg>
            <div class="num" id="ringNum">--</div>
          </div>
          <div style="min-width:260px;flex:1">
            <div class="chip" id="bandChip">CRC: --</div>
            <p style="color:#cbd5e1;margin:8px 0 0">
              Composite = average of category risk percentiles vs their own last decade (with sensible inverts).
            </p>
            <div class="kvs">
              <div class="chip" id="kvBand">Band: —</div>
              <div class="chip" id="kvBreadth">Breadth: —</div>
              <div class="chip" id="kvSynch">Synchronicity: —</div>
              <div class="chip" id="kvShock">Shock: —</div>
            </div>
            <p style="color:#93a2bf;margin-top:6px" id="runMeta">Last run: —</p>
          </div>
        </div>
      </div>

      <div class="card summary">
        <h2>Executive Summary</h2>
        <div id="exec-summary" style="margin-top:6px;color:#dbe3f8">Run the dashboard to generate a current analyst note.</div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom:10px">Categories</h2>
      <div class="cats" id="cats"></div>
    </div>

    <div class="footer">Marshall WBCI v1.0 • Built on public data • Deterministic CIO summary</div>
  </div>

<!-- Chart.js for sparklines -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

<!-- ===== CIO Exec Summary Helper (from previous message) ===== -->
<script>
window.CIOExec = (() => {
  const clamp=(x,lo=0,hi=100)=>Math.max(lo,Math.min(hi,x));
  const band = s => s>=70 ? "Red" : (s>=40 ? "Amber" : "Green");
  const arrow=d=>d>0?"↑":(d<0?"↓":"→");
  const pct=x=>`${Math.round(x)}%`;
  const fmt=x=>Math.round(clamp(x));
  const title=s=>({Green:"Constructive",Amber:"Cautious",Red:"Defensive"})[s];
  function rankCats(cats){
    const arr=Object.entries(cats).map(([k,v])=>({key:k,label:v.label,score:fmt(v.score||0),delta:Math.round(v.delta||0)}))
      .sort((a,b)=>b.score-a.score);
    return {
      pressures:arr.filter(x=>x.score>=60).slice(0,4),
      offsets:arr.filter(x=>x.score<40).slice(0,4),
      mids:arr.filter(x=>x.score>=40&&x.score<60).slice(0,4),
      ranked:arr
    };
  }
  const catOneLiners={
    ratesCurve:s=>s>=60?"Rates/curve are tight — financing is harder and valuations face a headwind."
                       :s<40?"Rates/curve are easy-ish — financing backdrop is friendlier."
                             :"Rates/curve are neutral — not a major push or drag right now.",
    creditStress:s=>s>=60?"Credit stress is rising — refinancing and risk appetite could wobble."
                        :s<40?"Credit stress is calm — a useful cushion against shocks."
                              :"Credit is steady — watch for spread moves.",
    liquidity:s=>s>=60?"Liquidity looks thin — air pockets risk bigger moves."
                      :s<40?"Liquidity is decent — market depth helps absorb shocks."
                            :"Liquidity is mixed — fine in spots, patchy in others.",
    usdExternal:s=>s>=60?"USD/external pressure is high — tightens global conditions."
                        :s<40?"USD/external looks easy — tailwind for risk assets."
                              :"USD/external is neutral — not driving the tape.",
    energyShock:s=>s>=60?"Energy burden is elevated — margins and demand can suffer."
                        :s<40?"Energy burden is light — helps consumers and margins."
                              :"Energy is manageable — not a swing factor yet.",
    laborHousehold:s=>s>=60?"Labor/household are softening — demand buffer is thinner."
                          :s<40?"Labor/household look resilient — spending support remains."
                                :"Labor/household are stable — no clear turn.",
    activitySentiment:s=>s>=60?"Activity/sentiment are weakening — growth sensitivity is higher."
                             :s<40?"Activity/sentiment are firm — downside absorption improves."
                                   :"Activity/sentiment are middling — watch direction."
  };
  function buildText(s){
    const score=fmt(s.score), last=(s.lastScore==null?null:fmt(s.lastScore)), delta=(last==null?null:(score-last));
    const b=band(score), breadth=Math.max(0,Math.min(100,Math.round(s.breadthPct||0)));
    const synch=Math.max(0,Math.min(100,Math.round(s.synchPct||0))); const shock=fmt(s.shock||0);
    const {pressures,offsets,ranked}=rankCats(s.categories||{});
    const head=[`<strong>WBCI ${score} — ${b}</strong>${last==null?``:` (${delta>0?`+${delta}`:delta} vs last run)`}.`,
                `Breadth ${pct(breadth)} (share of pillars above average risk).`,
                `Synchronicity ${pct(synch)} (how many pillars are moving together).`,
                `Shock ${shock} (speed of change).`].join(" ");
    const pressTxt=pressures.length?`Main pressures: ${pressures.map(x=>`${x.label} ${x.score}${x.delta?` ${arrow(x.delta)}`:""}`).join(", ")}.`
                                 :`No major pressure clusters — risks are not concentrated at the top end.`;
    const offsTxt=offsets.length?`Cushions: ${offsets.map(x=>`${x.label} ${x.score}${x.delta?` ${arrow(x.delta)}`:""}`).join(", ")}.`
                                :`Few cushions — most pillars are mid/high.`;
    const breadthTxt=breadth>=60?"Risk is broad-based; more areas are pulling the same way."
                      :breadth>=30?"Risk breadth is mixed; some areas elevated, others calm."
                                   :"Risk is narrow; stress is concentrated, not yet systemic.";
    const synchTxt=synch>=60?"Co-movement is strong — regime shifts accelerate in this state."
                    :synch>=30?"Co-movement is building — a turn could spread."
                               :"Little co-movement — deterioration is still patchy.";
    const shockTxt=shock>=70?"Momentum is hot — the tape can move quickly."
                   :shock>=40?"Momentum is turning — expect choppier swings."
                              :"Momentum is calm — changes are slower and more local.";
    const triggers=[];
    const add=t=>{if(t && !triggers.includes(t) && triggers.length<3)triggers.push(t);}
    const cat=id=> (s.categories&&s.categories[id])?s.categories[id]:{score:0,delta:0};
    const high=id=> (cat(id).score||0)>=60; const rising=id=> (cat(id).delta||0)>=5;
    if (high('ratesCurve')||rising('ratesCurve')) add("front‑anchored curve steepening or renewed inversion");
    if (high('creditStress')||rising('creditStress')) add("a decisive widening in HY spreads and systemic stress gauges");
    if (high('laborHousehold')||rising('laborHousehold')) add("a persistent rise in weekly claims confirming softer labor");
    if (high('usdExternal')||rising('usdExternal')) add("further USD strength tightening global financial conditions");
    if (high('energyShock')||rising('energyShock')) add("another energy‑price spike pressuring margins and demand");
    const watch = triggers.length?`Watch next: ${triggers.map((t,i)=>`${i+1}) ${t}`).join("; ")}.`
                                 :`Watch next: stabilization in spreads and claims would ease risk; the opposite would push WBCI higher.`;
    const stance = (()=> {
      const titleTxt=({Green:"Constructive",Amber:"Cautious",Red:"Defensive"})[b];
      if (b==="Red"||(breadth>=50&&synch>=50)) return `${titleTxt}: emphasize capital preservation, shorten risk, add hedges, trim USD‑sensitive exposure.`;
      if (b==="Amber") return `${titleTxt}: stay invested but selective; prefer quality balance sheets, keep light hedges, and watch the triggers.`;
      return `${titleTxt}: constructive risk, with guardrails — hold dry powder and monitor claims/spreads for early turns.`;
    })();
    const catNotes=ranked.map(x=>{const fn=catOneLiners[x.key]||(()=> "");return {label:x.label,note:fn(x.score)};});
    return {headline:head,drivers:pressTxt,offsets:offsTxt,diagnostics:`${breadthTxt} ${synchTxt} ${shockTxt}`,watch,stance,catNotes};
  }
  function render(targetEl,state){
    const el=(typeof targetEl==="string")?document.getElementById(targetEl):targetEl; if(!el) return;
    const LS_KEY="wbci_last_score"; const lastScore=Number(localStorage.getItem(LS_KEY));
    const out=buildText({...state,lastScore:Number.isFinite(lastScore)?lastScore:null});
    if (Number.isFinite(state.score)) localStorage.setItem(LS_KEY,String(Math.round(state.score)));
    el.innerHTML=[`<p>${out.headline}</p>`,`<p>${out.drivers}</p>`,`<p>${out.offsets}</p>`,
                  `<p>${out.diagnostics}</p>`,`<p><strong>Portfolio stance:</strong> ${out.stance}</p>`,
                  `<p><em>${out.watch}</em></p>`].join("");
    // optional cat one‑liners if noteElId passed
    if (state.categories){
      out.catNotes.forEach(n=>{
        const c=Object.values(state.categories).find(v=>v.label===n.label && v.noteElId);
        if (c){const node=document.getElementById(c.noteElId); if(node) node.textContent=n.note;}
      });
    }
  }
  return {render};
})();
</script>

<script>
/* ========= Demo data + scoring engine ========= */
/* Replace loadLiveData() with your real fetchers; keep the shape. */

const $ = id => document.getElementById(id);
const fmtBand = s => s>=70?'Red':(s>=40?'Amber':'Green');

function lerp(a,b,t){return a+(b-a)*t}
function rnd(seed){ // deterministic-ish small noise by seed/time
  const x = Math.sin(seed*9999 + (Date.now()/3600000|0))*10000; return x - Math.floor(x);
}

// ---- Demo loader (replace with live) ----
async function loadLiveData(){
  // Return last-12 values for each category (0–100 risk scale), newest last.
  // In real code, compute percentiles vs last 10y and invert “good-high” series.
  const t = Date.now()/86400000|0;
  const mk = (base, vol, seed) => {
    const arr=[]; let v=base;
    for(let i=0;i<16;i++){ v=clamp01(v + (rnd(seed+i)-0.5)*vol); arr.push(v); }
    return arr.map(x=>Math.round(x*100));
  };
  const clamp01 = x => Math.max(0, Math.min(1, x));

  return {
    // higher = riskier on all (already inverted where needed)
    ratesCurve:      mk(0.62,0.08, t+1),
    creditStress:    mk(0.30,0.10, t+2),
    liquidity:       mk(0.33,0.07, t+3),
    usdExternal:     mk(0.74,0.08, t+4),
    energyShock:     mk(0.58,0.12, t+5),
    laborHousehold:  mk(0.35,0.10, t+6),
    activitySentiment:mk(0.42,0.07, t+7)
  };
}

// ---- Scoring & diagnostics ----
function computeScore(seriesByCat, mode="advanced"){
  // category score = latest value (0–100). delta = latest - prior (bounded).
  const cats = {};
  Object.entries(seriesByCat).forEach(([key,arr])=>{
    const score = arr[arr.length-1];
    const delta = score - (arr[arr.length-2] ?? score);
    cats[key] = { label:labelFor(key), score, delta, series:arr.slice(-16) };
  });

  // breadth = share of categories with score >= 50
  const vals = Object.values(cats).map(v=>v.score);
  const breadthPct = Math.round(100 * (vals.filter(v=>v>=50).length / vals.length));

  // synchronicity = correlation of last 8 changes across categories (scaled to 0–100)
  const diffs = Object.values(cats).map(v=> v.series.slice(-8).map((x,i,aa)=> i? x-aa[i-1]:0).slice(1));
  let pair = 0, sumCorr = 0;
  for(let i=0;i<diffs.length;i++){
    for(let j=i+1;j<diffs.length;j++){
      const c = corr(diffs[i],diffs[j]); if (!Number.isFinite(c)) continue;
      sumCorr += Math.max(0,c); pair++;
    }
  }
  const synchPct = pair? Math.round(100*(sumCorr/pair)) : 0;

  // shock = average absolute one-step change (last two points) across cats (scaled)
  const shock = Math.round(vals.reduce((a,_,i)=> a + Math.abs((Object.values(cats)[i].delta||0)),0)/vals.length);

  // composite: weighted mean by mode
  const weights = (mode==="advanced")
    ? {ratesCurve:1.3, creditStress:1.4, liquidity:1.0, usdExternal:1.1, energyShock:1.0, laborHousehold:1.2, activitySentiment:1.0}
    : {ratesCurve:1, creditStress:1, liquidity:1, usdExternal:1, energyShock:1, laborHousehold:1, activitySentiment:1};

  const wsum = Object.entries(cats).reduce((a,[k,v])=>a + (weights[k]||1)*v.score, 0);
  const wtot = Object.entries(cats).reduce((a,[k,_])=>a + (weights[k]||1), 0);
  const score = Math.round(wsum / wtot);

  return {score, breadthPct, synchPct, shock, cats};
}

function corr(a,b){
  const n = Math.min(a.length,b.length); if(n===0) return 0;
  let sa=0,sb=0,saa=0,sbb=0,sab=0;
  for(let i=0;i<n;i++){ sa+=a[i]; sb+=b[i]; saa+=a[i]*a[i]; sbb+=b[i]*b[i]; sab+=a[i]*b[i]; }
  const vA=saa - sa*sa/n, vB=sbb - sb*sb/n;
  return (sab - sa*sb/n) / Math.sqrt(Math.max(1e-9,vA*vB));
}
function labelFor(key){
  return ({
    ratesCurve:"Rates / Curve",
    creditStress:"Credit / Stress",
    liquidity:"Liquidity",
    usdExternal:"USD / External",
    energyShock:"Energy Shock",
    laborHousehold:"Labor / Household",
    activitySentiment:"Activity / Sentiment"
  })[key] || key;
}

// ---- UI wiring ----
const charts = {};
async function run(){
  $('runBtn').disabled = true;
  const mode = $('mode').value;

  // 1) Load data (replace with real)
  const series = await loadLiveData();

  // 2) Compute scores
  const {score,breadthPct,synchPct,shock,cats} = computeScore(series, mode);

  // 3) Paint ring
  paintRing(score);

  // 4) KVs
  $('bandChip').textContent = `WBCI: ${score} — ${fmtBand(score)}`;
  $('kvBand').textContent   = `Band: ${fmtBand(score)}`;
  $('kvBreadth').textContent= `Breadth: ${breadthPct}%`;
  $('kvSynch').textContent  = `Synchronicity: ${synchPct}%`;
  $('kvShock').textContent  = `Shock: ${shock}`;
  $('runMeta').textContent  = `Last run: ${new Date().toLocaleString()} • Mode: ${mode}`;

  // 5) Category cards w/ spark charts + baseline text + target for one-liners
  paintCategories(cats);

  // 6) CIO summary
  const catsForSummary = {};
  Object.entries(cats).forEach(([k,v])=>{
    catsForSummary[k] = {label:v.label, score:v.score, delta:v.delta, noteElId:`note-${k}`};
  });
  CIOExec.render("exec-summary", {
    score, breadthPct, synchPct, shock, categories: catsForSummary
  });

  $('runBtn').disabled = false;
}
function paintRing(score){
  const circ = 2*Math.PI*54; // dasharray
  const arc = $('arc');
  const pct = Math.max(0,Math.min(100,score))/100;
  arc.style.strokeDasharray = String(circ);
  arc.style.strokeDashoffset = String(circ*(1-pct));
  arc.style.stroke = score>=70?'#ef4444':(score>=40?'#f59e0b':'#22c55e');
  $('ringNum').textContent = Math.round(score);
}
function paintCategories(cats){
  const host = $('cats'); host.innerHTML = '';
  Object.entries(cats).forEach(([key,v])=>{
    const col = v.score>=70?'#ef4444':(v.score>=40?'#f59e0b':'#22c55e');
    const card = document.createElement('div');
    card.className='cat-card';
    card.innerHTML = `
      <div class="cat-head">
        <div style="font-weight:800">${v.label}</div>
        <div class="score-badge">${Math.round(v.score)}</div>
      </div>
      <canvas id="spark-${key}"></canvas>
      <div class="bar" style="--c:${col}"></div>
      <div class="baseline"><strong>Baseline:</strong> ${baselineText(key)}</div>
      <div class="cat-note" id="note-${key}"></div>
    `;
    host.appendChild(card);
    // chart
    const ctx = card.querySelector(`#spark-${key}`).getContext('2d');
    if (charts[key]) charts[key].destroy();
    charts[key] = new Chart(ctx,{
      type:'line',
      data:{labels:v.series.map((_,i)=>i+1),
            datasets:[{data:v.series,borderColor:col,backgroundColor:'transparent',tension:.35,pointRadius:0,borderWidth:2}]},
      options:{responsive:true,plugins:{legend:{display:false},tooltip:{enabled:false}},
               scales:{x:{display:false},y:{display:false}}}
    });
  });
}
function baselineText(key){
  switch(key){
    case 'ratesCurve': return 'Amber. Tight or inverting curves + high long rates raise crash risk via refinancing and valuation pressure.';
    case 'creditStress': return 'Green. Credit spreads and systemic stress tend to lead equity drawdowns.';
    case 'liquidity': return 'Green. When bond market depth and money conditions falter, sell‑offs accelerate.';
    case 'usdExternal': return 'Red. A strong USD tightens global financial conditions and can trigger funding squeezes.';
    case 'energyShock': return 'Amber. Energy burden spikes often precede recessions and earnings downgrades.';
    case 'laborHousehold': return 'Green. Rising claims and household delinquencies erode the demand buffer.';
    case 'activitySentiment': return 'Amber. Softening real activity and confidence raise vulnerability to shocks.';
    default: return '—';
  }
}

// ---- buttons ----
$('runBtn').addEventListener('click', run);
$('resetBtn').addEventListener('click', ()=>{
  localStorage.removeItem('wbci_last_score');
  $('exec-summary').textContent = 'Cache cleared. Run again to refresh.';
});

// Auto-run on first load
run();
</script>
</body>
</html>

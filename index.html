<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Marshall Stock Market Crash Composite Indicator</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a;        /* slate-900 */
    --panel:#111827;     /* gray-900 */
    --soft:#0b1226;      /* deeper bg */
    --card:#111827;
    --text:#e5e7eb;      /* gray-200 */
    --muted:#9ca3af;     /* gray-400 */
    --accent:#60a5fa;    /* blue-400 */
    --green:#10b981;     /* emerald-500 */
    --amber:#f59e0b;     /* amber-500 */
    --red:#ef4444;       /* red-500 */
    --chip:#1f2937;      /* gray-800 */
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 800px at 80% -200px, #14203b 0%, var(--bg) 50%) fixed;
    color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
    -webkit-font-smoothing:antialiased; line-height:1.4;
  }
  .wrap{max-width:980px;margin:0 auto;padding:24px 16px 60px}
  header{display:flex;gap:16px;align-items:center;margin:6px 0 18px}
  header img{width:56px;height:56px;border-radius:50%;object-fit:cover;box-shadow:var(--shadow)}
  h1{font-size:28px;line-height:1.15;margin:0}
  p.sub{margin:6px 0 0;color:var(--muted)}
  .bar{display:flex;gap:10px;align-items:center;margin:16px 0 10px; flex-wrap:wrap}
  input#key{
    flex:1 1 260px;background:#0b1226;border:1px solid #1e293b;color:var(--text);
    padding:12px 14px;border-radius:12px;min-width:260px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
  }
  select#preset{background:#0b1226;color:var(--text);border:1px solid #1e293b;padding:10px 12px;border-radius:12px}
  button#run{
    background:linear-gradient(180deg,#4f8efc,#2563eb); color:white;border:none;
    padding:12px 16px;border-radius:12px;font-weight:700; box-shadow:var(--shadow);
  }
  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
  .summary{display:flex;align-items:center;gap:14px;background:var(--soft);border:1px solid #1f2937;padding:14px;border-radius:var(--radius)}
  .gauge{width:86px;height:86px;border-radius:50%;position:relative;background:conic-gradient(var(--gcol) var(--gstop), #162033 0);}
  .gauge:after{content:attr(data-val);position:absolute;inset:0;display:grid;place-items:center;font-weight:800}
  .badge{background:var(--chip);padding:6px 10px;border-radius:999px;font-weight:800;min-width:72px;text-align:center}
  .badge.green{background:rgba(16,185,129,.15);color:var(--green)}
  .badge.amber{background:rgba(245,158,11,.15);color:var(--amber)}
  .badge.red{background:rgba(239,68,68,.15);color:var(--red)}
  .note{background:var(--soft);border:1px solid #1f2937;padding:16px;border-radius:var(--radius)}
  .k{display:flex;gap:10px;align-items:center;margin:6px 0;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%}
  .card{
    background:var(--card);border:1px solid #1f2937;border-radius:18px;padding:14px 16px;
    display:flex;justify-content:space-between;gap:10px;box-shadow:var(--shadow)
  }
  .left{min-width:0}
  .title{font-weight:800}
  .id{background:#1f2937;color:#cbd5e1;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .val{font-size:28px;font-weight:800;margin-top:6px}
  .meta{color:var(--muted);font-size:13px;margin-top:2px}
  .score{font-weight:800}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  details.debug{margin-top:16px}
  .log{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0b1226;border:1px solid #1f2937;padding:14px;border-radius:12px;color:#cbd5e1}
  @media(min-width:720px){
    .grid{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="logo.png" alt="Alba crest" onerror="this.style.display='none'">
      <div>
        <h1>The Marshall Stock Market Crash Composite Indicator</h1>
        <p class="sub">U.S. crash-risk dashboard from 20+ economic & market indicators.</p>
      </div>
    </header>

    <div class="bar">
      <input id="key" placeholder="Enter your FRED API key (32 chars)" inputmode="latin" autocomplete="off">
      <select id="preset" title="Proxy">
        <option value="auto" selected>Auto (race)</option>
        <option value="codetabs">Codetabs</option>
        <option value="allorigins">AllOrigins</option>
        <option value="isogit">isomorphic-git CORS</option>
        <option value="thingproxy">ThingProxy</option>
        <option value="direct">Direct FRED</option>
      </select>
      <button id="run">Run / Refresh</button>
    </div>

    <div class="summary">
      <div class="gauge" id="gauge" style="--gcol:#f59e0b;--gstop:0deg" data-val="—"></div>
      <div>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="opacity:.8;font-weight:700">CRC</span>
          <span id="badge" class="badge amber">—</span>
        </div>
        <div style="color:var(--muted);margin-top:4px">Composite = average of indicator percentiles vs last 10y (invert where higher value = higher risk).</div>
      </div>
    </div>

    <div class="note">
      <h3 style="margin:0 0 8px">How to read the CRC (RAG)</h3>
      <div class="k"><span class="dot" style="background:var(--green)"></span><strong>&nbsp;Green &lt; 40</strong>&nbsp;• Most indicators are in the lower half of their 10-year ranges.</div>
      <div class="k"><span class="dot" style="background:var(--amber)"></span><strong>&nbsp;Amber 40–70</strong>&nbsp;• Mixed/deteriorating signals. Tighten risk controls; consider selective hedges.</div>
      <div class="k"><span class="dot" style="background:var(--red)"></span><strong>&nbsp;Red &gt; 70</strong>&nbsp;• Broad elevation vs the last decade; emphasize capital preservation and liquidity.</div>
    </div>

    <div id="cards" class="grid"></div>

    <details class="debug">
      <summary>Show Debug Log</summary>
      <div id="log" class="log"></div>
    </details>
  </div>

<script>
/* ---------------------------- Config ---------------------------------- */
const SERIES = [
  { id:'DGS10',     name:'10Y Treasury yield',          fmt:v=>(+v).toFixed(2)+'%',       invert:false },
  { id:'T10Y2Y',    name:'10Y–2Y spread',               fmt:v=>(+v).toFixed(2)+'%',       invert:true  },
  { id:'T10Y3M',    name:'10Y–3M spread',               fmt:v=>(+v).toFixed(2)+'%',       invert:true  },
  { id:'BAMLH0A0HYM2',name:'ICE BofA HY OAS',           fmt:v=>(+v).toFixed(2),           invert:true  },
  { id:'STLFSI4',   name:'St. Louis Financial Stress',  fmt:v=>(+v).toFixed(4),           invert:true  },
  { id:'SP500',     name:'S&P 500 index',               fmt:v=>(+v).toLocaleString(),     invert:false },
  { id:'VIXCLS',    name:'VIX index',                   fmt:v=>(+v).toFixed(2),           invert:true  },
  { id:'UNRATE',    name:'Unemployment rate',           fmt:v=>(+v).toFixed(1)+'',        invert:true  },
  { id:'UMCSENT',   name:'UMich consumer sentiment',    fmt:v=>(+v).toFixed(1),           invert:false },
  { id:'CPIAUCSL',  name:'CPI (headline)',              fmt:v=>(+v).toFixed(3),           invert:true  },
  { id:'INDPRO',    name:'Industrial production',       fmt:v=>(+v).toFixed(4),           invert:true  },
  { id:'PCEPI',     name:'PCE prices',                  fmt:v=>(+v).toFixed(3),           invert:true  },
  { id:'RSFSXMV',   name:'Retail sales excl. auto',     fmt:v=>(+v).toFixed(3),           invert:true  }, // alt to RSAFS
  { id:'PERMIT',    name:'Building permits',            fmt:v=>(+v).toLocaleString(),     invert:true  },
  { id:'HOUST',     name:'Housing starts',              fmt:v=>(+v).toLocaleString(),     invert:true  },
  { id:'DTWEXBGS',  name:'Trade-weighted USD (broad)',  fmt:v=>(+v).toFixed(4),           invert:true  },
  { id:'NFCI',      name:'Chicago Fed Fin. Conditions', fmt:v=>(+v).toFixed(5),           invert:true  },
];

const ONE_DAY = 86400000;
const TEN_YEARS_MS = 3652 * ONE_DAY; // ~10 years
const CACHE_MS = 30 * 60 * 1000;

/* ------------------------ UI helpers ---------------------------------- */
const el = sel => document.querySelector(sel);
const log = (...a)=>{ const L=el('#log'); L.textContent += a.join(' ')+'\n'; };

function ragColor(score){
  if (score < 40) return {cls:'green', col:'#10b981'};
  if (score < 70) return {cls:'amber', col:'#f59e0b'};
  return {cls:'red', col:'#ef4444'};
}
function setGauge(score){
  const g = el('#gauge');
  if (isNaN(score)){ g.style.setProperty('--gstop','0deg'); g.dataset.val='—'; return; }
  const deg = Math.max(6, Math.min(354, (score/100)*360));
  const {col, cls} = ragColor(score);
  g.style.setProperty('--gcol', col);
  g.style.setProperty('--gstop', deg+'deg');
  g.dataset.val = Math.round(score);
  const badge = el('#badge');
  badge.className = 'badge '+cls;
  badge.textContent = `CRC: ${Math.round(score)} — ${cls.toUpperCase()}`;
}

/* ----------------------- Fetch (proxy race) --------------------------- */
function proxied(url, which){
  const enc = encodeURIComponent(url);
  const routes = {
    codetabs:   `https://api.codetabs.com/v1/proxy?quest=${enc}`,
    allorigins: `https://api.allorigins.win/raw?url=${enc}`,
    isogit:     `https://cors.isomorphic-git.org/${url}`,
    thingproxy: `https://thingproxy.freeboard.io/fetch/${url}`,
    direct:      url
  };
  if (which && which!=='auto') return routes[which];
  return [routes.codetabs, routes.allorigins, routes.isogit, routes.thingproxy, routes.direct];
}

async function fetchFred(series, apiKey, prefer){
  const fred = `https://api.stlouisfed.org/fred/series/observations?series_id=${series}&file_type=json&api_key=${apiKey}`;
  const tried = proxied(fred, prefer);
  if (Array.isArray(tried)){
    // race proxies: first success wins
    const attempts = tried.map(u => fetch(u).then(r => r.ok ? r.json() : Promise.reject(r.status)).catch(e => ({__err:e,u})));
    const results = await Promise.allSettled(attempts);
    for (const r of results){
      if (r.status==='fulfilled' && !r.value.__err){ r.value.__via='race'; return r.value; }
    }
    // if all failed, throw last error
    const last = results[results.length-1];
    throw new Error('All proxies failed: '+(last.value?.__err || last.reason));
  }else{
    const res = await fetch(tried);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json(); j.__via=prefer; return j;
  }
}

/* -------------------- Percentile vs last 10y -------------------------- */
function last10yPercentile(observations, invert=false){
  const now = Date.now();
  const windowStart = now - TEN_YEARS_MS;
  const pts = observations
    .map(o => ({ t: new Date(o.date+'T00:00:00Z').getTime(), v: parseFloat(o.value) }))
    .filter(o => isFinite(o.v));
  // latest
  const latest = pts[pts.length-1];
  if (!latest) return { latestValue:NaN, latestDate:'—', pct:NaN };
  // window
  const ref = pts.filter(p => p.t >= windowStart);
  const refVals = ref.length ? ref : pts.slice(-120); // fallback ~10 years monthly
  const values = refVals.map(p => p.v).sort((a,b)=>a-b);
  const latestV = latest.v;
  let pct = values.length ? (values.findIndex(v => v > latestV) / values.length) * 100 : NaN;
  if (pct===-Infinity || pct===Infinity || isNaN(pct)) pct = NaN;
  if (invert && isFinite(pct)) pct = 100 - pct;
  return { latestValue: latestV, latestDate: new Date(latest.t).toISOString().slice(0,10), pct: Math.max(0, Math.min(100, pct)) };
}

/* ------------------------ Main runner --------------------------------- */
async function run(){
  const apiKey = el('#key').value.trim();
  const prefer = el('#preset').value;
  el('#log').textContent='';
  if (!/^[a-f0-9]{32}$/.test(apiKey)){ alert('Enter a valid 32-char FRED API key'); return; }

  localStorage.setItem('fred_key', apiKey);

  const cards = el('#cards');
  cards.innerHTML = '';
  setGauge(NaN);

  const cacheKey = `crc_${prefer}_${apiKey.slice(0,6)}`;
  const cached = JSON.parse(localStorage.getItem(cacheKey) || 'null');
  if (cached && (Date.now()-cached.ts) < CACHE_MS){
    log('Loaded from cache');
    paint(cached.payload);
    return;
  }

  log(`Fetching ${SERIES.length} indicators (proxy: ${prefer})`);
  const payload = [];
  let done=0;

  await Promise.all(SERIES.map(async s=>{
    try{
      const j = await fetchFred(s.id, apiKey, prefer);
      const { latestValue, latestDate, pct } = last10yPercentile(j.observations, s.invert);
      payload.push({ id:s.id, name:s.name, value:latestValue, date:latestDate, score: Math.round(pct), fmt:s.fmt, invert:s.invert });
      log(`✓ ${s.id} ok`);
    }catch(e){
      payload.push({ id:s.id, name:s.name, error:String(e), score:null });
      log(`✗ ${s.id} failed: ${e}`);
    }finally{ done++; }
  }));

  localStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), payload}));
  paint(payload);
}

function paint(list){
  // compute CRC from available scores
  const nums = list.map(d=>d.score).filter(n=>typeof n==='number' && isFinite(n));
  const crc = nums.length ? nums.reduce((a,b)=>a+b,0)/nums.length : NaN;
  setGauge(crc);

  // sort by score desc for readability
  list.sort((a,b)=> (b.score??-1) - (a.score??-1));

  const cards = el('#cards');
  cards.innerHTML = list.map(d=>{
    const tag = `<span class="id">${d.id}</span>`;
    if (d.error){
      return `<div class="card"><div class="left"><div class="title">${d.name} ${tag}</div>
              <div class="meta" style="color:#ef4444">error: ${escapeHtml(d.error)}</div></div>
              <div class="chips"><span class="badge red">ERR</span></div></div>`;
    }
    const fmt = d.fmt ? d.fmt(d.value) : String(d.value);
    const {cls} = ragColor(d.score ?? 0);
    return `<div class="card">
      <div class="left">
        <div class="title">${d.name} ${tag}</div>
        <div class="val">${fmt}</div>
        <div class="meta">${d.date ? d.date : '—'} &nbsp; • &nbsp; score <span class="score">${d.score}</span></div>
      </div>
      <div class="chips"><span class="badge ${cls}">${d.score ?? '—'}</span></div>
    </div>`;
  }).join('');
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* --------------------- Wire up UI & defaults -------------------------- */
el('#run').addEventListener('click', run);
el('#preset').addEventListener('change', ()=>{ localStorage.setItem('proxy_pref', el('#preset').value); });
(function boot(){
  const saved = localStorage.getItem('fred_key'); if (saved) el('#key').value=saved;
  const pref = localStorage.getItem('proxy_pref'); if (pref) el('#preset').value=pref;
})();
</script>
</body>
</html>

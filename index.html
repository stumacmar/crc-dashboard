<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Marshall Stock Market Crash Composite Indicator</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e1420;--card:#141c2b;--muted:#8aa0bf;--text:#e7eefc;
      --amber:#f3a536;--amber-600:#c97f12;--ring:#24324a;--pill:#22324d;
      --accent:#6aa3ff;--good:#22c55e;--bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:28px 16px 80px}
    h1{font-size:clamp(24px,4.8vw,40px);line-height:1.05;margin:0 0 8px}
    p.lead{color:var(--muted);margin:0 0 18px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    input[type=text]{flex:1;min-width:260px;background:#0b1220;color:var(--text);border:1px solid var(--ring);border-radius:12px;padding:14px 14px}
    button.primary{background:var(--accent);color:#071427;border:0;border-radius:14px;padding:12px 18px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px;margin:16px 0}
    .crc{display:flex;gap:18px;align-items:center}
    .gauge{position:relative;width:124px;height:124px}
    .gauge svg{transform:rotate(-90deg)}
    .gauge .val{position:absolute;inset:0;display:grid;place-items:center;font-size:28px;font-weight:800}
    .badge{background:#2b2014;color:#fff;border:1px solid #3a2a12;border-radius:999px;padding:10px 14px;font-weight:800}
    .badge.amber{background:#2b2014;border-color:#5e4216}
    details.settings{margin:8px 0 4px}
    details.settings summary{cursor:pointer;color:var(--muted)}
    .grid{display:grid;gap:12px}
    .indicator{background:#101827;border:1px solid var(--ring);border-radius:14px;padding:16px}
    .ind-h{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:8px}
    .pill{background:var(--pill);color:#bcd0f1;border-radius:999px;padding:3px 8px;font-size:13px}
    .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .rag{display:grid;gap:8px}
    .rag .row{align-items:baseline}
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.amber{background:var(--amber)}
    .hide{display:none!important}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>The Marshall Stock Market Crash Composite Indicator</h1>
    <p class="lead">U.S. crash-risk dashboard from 20+ economic &amp; market indicators.</p>

    <!-- Hidden proxy selector (removed from UI, always auto) -->

    <div class="row">
      <input id="key" type="text" placeholder="Paste FRED API key" autocomplete="off">
      <button id="run" class="primary">Run / Refresh</button>
    </div>
    <details id="settings" class="settings">
      <summary>Settings</summary>
      <div class="meta">Your key is stored locally in this browser (never uploaded). To truly hide your key, use the serverless proxy option (see code comments).</div>
    </details>

    <div id="crcCard" class="card">
      <div class="crc">
        <div class="gauge">
          <svg width="124" height="124" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" fill="none" stroke="#1a2436" stroke-width="12"/>
            <!-- amber ring only -->
            <circle id="ringAmber" cx="60" cy="60" r="52" fill="none" stroke="#f3a536" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 327"/>
          </svg>
          <div class="val" id="crcVal">—</div>
        </div>
        <div>
          <div id="crcBadge" class="badge amber">CRC: — — AMBER</div>
          <div class="meta">Composite = average of indicator percentiles vs last 10y (using sensible inverts).</div>
        </div>
      </div>
    </div>

    <div id="exec" class="card">
      <h2 style="margin:0 0 8px">Executive Summary</h2>
      <div id="summary" class="meta">Paste your FRED key and tap Run.</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Indicators</h2>
      <div id="list" class="grid"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">How to read the CRC (RAG)</h2>
      <div class="rag meta">
        <div class="row"><span class="dot" style="background:#22c55e"></span>&nbsp;<strong>Green &lt; 40</strong> — indicators mostly in lower half of their last-10y ranges.</div>
        <div class="row"><span class="dot amber"></span>&nbsp;<strong>Amber 40–70</strong> — mixed/deteriorating signals; tighten risk controls; add selective hedges.</div>
        <div class="row"><span class="dot" style="background:#ef4444"></span>&nbsp;<strong>Red &gt; 70</strong> — broad elevation vs last decade; emphasize capital preservation/liquidity.</div>
      </div>
    </div>

    <p class="meta">Educational only; not financial advice.</p>
  </div>

  <script>
    // ------- CONFIG -------
    // Always race the fast public proxies (no UI selector).
    const PROXY_MODE = "auto"; // "auto" only; UI removed
    // Optional: if you later deploy a serverless proxy, set WORKER_URL to your endpoint and the code will prefer it.
    const WORKER_URL = ""; // e.g. "https://fred.yourdomain.workers.dev" (leave blank for client-only)

    // Core indicator set (unchanged)
    const SERIES = [
      { id:"DGS10",     name:"10Y Treasury yield",        invert:false,   type:"pct" },
      { id:"T10Y2Y",    name:"10Y–2Y spread",             invert:true,    type:"pct" },
      { id:"T10Y3M",    name:"10Y–3M spread",             invert:true,    type:"pct" },
      { id:"BAMLH0A0HYM2", name:"ICE BofA HY OAS",        invert:true,    type:"pct" },
      { id:"STLFSI4",   name:"St. Louis Financial Stress (v4)", invert:false, type:"raw" },
      { id:"NFCI",      name:"Chicago Fed Financial Conditions", invert:true, type:"raw" },
      // Keep level S&P (point-in-time context), skip SP500MN scoring
      { id:"SP500",     name:"S&P 500 index",             invert:false,   type:"raw", score:false },
      // { id:"SP500MN", name:"S&P 500 (monthly avg)",     invert:false,   type:"raw", score:false }, // shown if you want, but no score
      { id:"VIXCLS",    name:"VIX index",                 invert:true,    type:"raw" },
      { id:"UNRATE",    name:"Unemployment rate",         invert:true,    type:"pct" },
      { id:"ICSA",      name:"Initial jobless claims (wkly)", invert:true,type:"raw" },
      { id:"CPIAUCSL",  name:"CPI (headline)",            invert:true,    type:"idx" },
      { id:"CPILFESL",  name:"Core CPI",                  invert:true,    type:"idx" },
      { id:"PCEPI",     name:"PCE prices",                invert:true,    type:"idx" },
      { id:"INDPRO",    name:"Industrial production",     invert:false,   type:"idx" },
      { id:"TCU",       name:"Capacity utilization",      invert:true,    type:"pct" },
      { id:"RSAFS",     name:"Retail sales (advance)",    invert:false,   type:"raw" },
      { id:"HOUST",     name:"Housing starts",            invert:false,   type:"raw" },
      { id:"PERMIT",    name:"Building permits",          invert:false,   type:"raw" },
      { id:"UMCSENT",   name:"UMich consumer sentiment",  invert:true,    type:"idx" },
      { id:"DTWEXBGS",  name:"Trade-weighted USD (broad)",invert:true,    type:"idx" },
    ];

    // ------- PROXY HELPERS (hidden, always "auto") -------
    const PROXIES = [
      (u)=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
      (u)=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
      (u)=>u // direct, works for some series CORS-wise
    ];
    function fredURL(id,key){
      return `https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${key}&file_type=json&observation_start=2010-01-01`;
    }
    async function fetchFRED(id,key){
      const base = fredURL(id,key);
      if (WORKER_URL) {
        // Prefer secure worker if configured (no key in URL; worker adds it)
        const url = `${WORKER_URL}/fred?series_id=${encodeURIComponent(id)}&file_type=json&observation_start=2010-01-01`;
        const r = await fetch(url);
        if(!r.ok) throw new Error(`Worker ${r.status}`);
        return r.json();
      }
      // Race proxies (hidden from UI)
      const urls = (PROXY_MODE==="auto") ? PROXIES.map(p=>p(base)) : [PROXIES[0](base)];
      return await Promise.any(urls.map(u=>fetch(u).then(r=>{ if(!r.ok) throw new Error('bad'); return r.json(); })));
    }

    // ------- SCORING -------
    function pctRank(arr, v){
      const xs = arr.filter(n=>isFinite(n)).sort((a,b)=>a-b);
      if (!xs.length) return NaN;
      const i = xs.findIndex(n=>n>v);
      const idx = (i<0?xs.length-1:Math.max(0,i-1));
      return (idx/(xs.length-1))*100;
    }
    function lastValue(obs){ // last non-empty
      for(let i=obs.length-1;i>=0;i--){
        const x = parseFloat(obs[i].value);
        if(isFinite(x)) return {v:x, date:obs[i].date};
      }
      return {v:NaN,date:"—"};
    }

    // ------- UI BINDING -------
    const elKey = document.getElementById('key');
    const elRun = document.getElementById('run');
    const elRingAmber = document.getElementById('ringAmber');
    const elCrcVal = document.getElementById('crcVal');
    const elBadge = document.getElementById('crcBadge');
    const elList = document.getElementById('list');
    const elSummary = document.getElementById('summary');

    // remember key locally
    const saved = localStorage.getItem('FRED_KEY');
    if(saved){ elKey.value = saved; }
    if(saved) run(); // auto run when present

    elRun.addEventListener('click', run);
    elKey.addEventListener('change', ()=>localStorage.setItem('FRED_KEY', elKey.value.trim()));

    async function run(){
      const key = elKey.value.trim();
      if(!key && !WORKER_URL){
        elSummary.textContent = "Enter your FRED key (stored only in this browser) or configure a serverless proxy.";
        return;
      }
      elRun.disabled = true; elRun.textContent = "Running…";
      try{
        const results = [];
        for (const s of SERIES){
          const j = await fetchFRED(s.id, key);
          const {v,date} = lastValue(j.observations||[]);
          const window = (j.observations||[]).slice(-120).map(o=>parseFloat(o.value));
          let score = NaN;
          if (s.score !== false){
            let p = pctRank(window, v);
            if (s.invert) p = 100 - p;
            score = Math.round(p);
          }
          results.push({ ...s, v, date, score });
        }

        // CRC = average of scored series
        const scored = results.filter(r=>isFinite(r.score));
        const crc = Math.round(scored.reduce((a,b)=>a+b.score,0)/scored.length);
        renderCRC(crc);
        renderSummary(results, crc);
        renderList(results);

      }catch(e){
        elSummary.textContent = "Load error. Proxies may be rate-limited; try again.";
        console.error(e);
      }finally{
        elRun.disabled = false; elRun.textContent = "Run / Refresh";
      }
    }

    function renderCRC(crc){
      const circ = 2*Math.PI*52; // circumference of r=52
      const dash = Math.max(0, Math.min(100, crc))/100 * circ;
      elRingAmber.setAttribute('stroke-dasharray', `${dash} ${circ}`);
      elCrcVal.textContent = isFinite(crc)? crc : "—";
      elBadge.textContent = `CRC: ${isFinite(crc)?crc:"—"} — ${crc<40?"GREEN":crc>70?"RED":"AMBER"}`;
    }

    function renderSummary(res, crc){
      // lightweight template — highlight a few drivers
      const get = id => res.find(x=>x.id===id);
      const y10   = get("DGS10")?.score;
      const sp    = get("SP500")?.score;
      const hy    = get("BAMLH0A0HYM2")?.score;
      const claims= get("ICSA")?.score;
      const un    = get("UNRATE")?.score;
      const usd   = get("DTWEXBGS")?.score;

      const parts = [];
      parts.push(`CRC ${crc} — ${crc<40?"GREEN":crc>70?"RED":"AMBER"}. Curve ${ (get("T10Y2Y")?.score??50) > 60 ? "tight/inverted" : "normalizing" }, keeping recession risk ${ (get("T10Y3M")?.score??50) > 60 ? "elevated" : "moderate" }.`);
      if (isFinite(y10) && y10>80) parts.push("10-year yield sits near the top of its decade range.");
      if (isFinite(hy) && hy>70) parts.push("High-yield spreads are elevated; watch credit conditions.");
      if (isFinite(sp) && sp>90) parts.push("S&P 500 level screens extreme vs decade range (frothy sentiment).");
      if (isFinite(claims) && claims>60) parts.push("Labor softening: initial claims leaning higher.");
      if (isFinite(un) && un>60) parts.push("Unemployment drifting up from lows.");
      if (isFinite(usd) && usd>70) parts.push("Stronger USD implies tighter global financial conditions.");

      elSummary.textContent = parts.join(" ");
    }

    function renderList(res){
      elList.innerHTML = "";
      for (const r of res){
        const scoreStr = (r.score===false || !isFinite(r.score))? "—" : `score ${r.score}`;
        const display = (r.type==="pct") ? `${(+r.v).toFixed(2)}%` :
                        (r.type==="idx" || r.type==="raw") ? (isFinite(+r.v)? (+r.v).toLocaleString(): "—") : r.v;
        const card = document.createElement('div');
        card.className = "indicator";
        card.innerHTML = `
          <div class="ind-h">
            <div><strong>${r.name}</strong> <span class="pill">${r.id}</span></div>
            <div class="meta">${r.date}</div>
          </div>
          <div style="font-size:32px;font-weight:800">${display}</div>
          <div class="meta">${scoreStr}</div>
        `;
        elList.appendChild(card);
      }
    }
  </script>
</body>
</html>

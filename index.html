<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Marshall Stock Market Crash Composite Indicator</title>
<link rel="preconnect" href="https://api.stlouisfed.org">
<style>
  :root{
    --bg:#0e1621;--panel:#121b26;--soft:#1a2330;--muted:#98a2b3;
    --text:#e6edf3;--brand:#8fb3ff;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
    --chip:#243142;--card:#0f1823;--ring:#f59e0b; /* single-color ring */
  }
  html,body{background:var(--bg);color:var(--text);font:400 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;margin:0}
  .wrap{max-width:760px;margin:0 auto;padding:22px 16px 80px}
  header{display:flex;gap:14px;align-items:center;margin-bottom:16px}
  header img{width:54px;height:54px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 2px #1f2937}
  h1{font-size:28px;line-height:1.1;margin:0}
  p.lead{margin:6px 0 0;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;margin:14px 0 6px}
  input,select,button{font:600 16px/1 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  input[type=text]{flex:1;min-width:0;background:var(--soft);border:1px solid #233045;color:#bcd2ff;border-radius:12px;padding:14px 12px}
  select{background:var(--soft);border:1px solid #233045;color:#cbd5e1;border-radius:12px;padding:12px}
  button{background:#3b82f6;border:0;color:white;border-radius:12px;padding:14px 18px}
  .card{background:var(--panel);border:1px solid #203045;border-radius:16px;padding:18px;margin-top:14px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .flex{display:flex;gap:16px;align-items:center}
  .crcBadge{background:#3a2f25;border:1px solid #4b3c2d;color:#fbd38d;border-radius:14px;padding:10px 14px;font-weight:700}
  .crcText b{font-weight:800}
  .ring{position:relative;width:110px;height:110px;min-width:110px}
  .ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
  .ring .label{position:absolute;inset:0;display:grid;place-items:center;font-size:28px;font-weight:800}
  .h2{font-size:22px;font-weight:800;margin:0 0 10px}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .ind{background:var(--card);border:1px solid #1d2a3a;border-radius:14px;padding:14px}
  .ind .name{font-weight:800}
  .chip{display:inline-block;background:var(--chip);color:#cbd5e1;border-radius:999px;padding:4px 8px;margin-left:8px;font-size:12px}
  .val{font-size:32px;font-weight:900;margin:6px 0}
  .meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
  .score{font-weight:700}
  .key li{margin:6px 0}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:-1px;margin-right:6px}
  .g{background:var(--ok)} .y{background:var(--warn)} .r{background:var(--bad)}
  @media (min-width:620px){
    .grid{grid-template-columns:1fr 1fr}
    .flexStack{display:flex;gap:16px}
    .flexStack .left{flex:0 0 140px}
    .flexStack .right{flex:1}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="alba-seal.png" alt="Alba crest" onerror="this.style.display='none'">
    <div>
      <h1>The Marshall Stock Market Crash Composite Indicator</h1>
      <p class="lead">U.S. crash-risk dashboard from 20+ economic &amp; market indicators.</p>
    </div>
  </header>

  <div class="row">
    <input id="apiKey" type="text" placeholder="YOUR_FRED_API_KEY" />
    <select id="mode">
      <option value="auto">Auto (race)</option>
      <option value="codetabs">Codetabs</option>
      <option value="allorigins">AllOrigins</option>
      <option value="none">Direct (CORS ok)</option>
    </select>
    <button id="runBtn">Run / Refresh</button>
  </div>

  <!-- CRC / Gauge -->
  <section class="card flexStack">
    <div class="left">
      <div class="ring" aria-label="CRC gauge">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="44" stroke="#233045" stroke-width="12" fill="none"></circle>
          <circle id="crcArc" cx="50" cy="50" r="44" stroke="var(--ring)" stroke-linecap="round" stroke-width="12" fill="none" stroke-dasharray="0 276"></circle>
        </svg>
        <div id="crcValue" class="label">—</div>
      </div>
    </div>
    <div class="right">
      <div class="flex">
        <div style="font-weight:900;letter-spacing:.08em">CRC</div>
        <div id="crcBadge" class="crcBadge">CRC: —</div>
      </div>
      <p id="crcNote" class="crcText muted" style="margin:.4rem 0 0">
        Composite = average of indicator percentiles vs last 10y (using sensible inverts).
      </p>
    </div>
  </section>

  <!-- Executive Summary -->
  <section class="card">
    <h2 class="h2">Executive Summary</h2>
    <p id="exec" class="muted" style="margin:8px 0 0">Paste your FRED API key and tap <b>Run / Refresh</b> to generate a summary.</p>
  </section>

  <!-- Indicators -->
  <section class="card">
    <h2 class="h2">Indicators</h2>
    <div id="indGrid" class="grid"></div>
  </section>

  <!-- RAG key -->
  <section class="card">
    <h2 class="h2">How to read the CRC (RAG)</h2>
    <ul class="key muted">
      <li><span class="dot g"></span><b>Green &lt; 40</b> — Indicators mostly sit in the lower half of their last-10y ranges.</li>
      <li><span class="dot y"></span><b>Amber 40–70</b> — Mixed/deteriorating signals. Tighten risk controls; add selective hedges.</li>
      <li><span class="dot r"></span><b>Red &gt; 70</b> — Broad elevation vs last decade; emphasize capital preservation/liquidity.</li>
    </ul>
    <p class="muted" style="margin-top:10px">CRC is a simple z/percentile blend; it’s a risk thermometer, not a timing signal.</p>
  </section>
</div>

<script>
/* --------------- helpers --------------- */
const $ = s => document.querySelector(s);
const fmtPct = (x,dec=2)=> (x==null||isNaN(x)) ? '—' : (+(x)).toFixed(dec).replace(/^-?0\.00$/,'0.00')+'%';
const fmtNum = x => (x==null||isNaN(x)) ? '—' :
  (+x>=1000 ? Intl.NumberFormat('en-US').format(Math.round(+x)) : (+x).toString());
const ymd = s => s?.slice(0,10) || '—';
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

const proxies = {
  codetabs: u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
  allorigins: u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  none: u => u
};
async function fetchWithRace(url, mode='auto'){
  if(mode!=='auto') return fetch(proxies[mode]?.(url)||url).then(r=>r.ok?r.text():Promise.reject(r.status));
  // race two reliable free proxies
  const urls=[proxies.codetabs(url), proxies.allorigins(url)];
  return await Promise.any(urls.map(u=>fetch(u).then(r=>r.ok?r.text():Promise.reject(r.status))));
}

function percentile(arr, v){
  const xs = arr.filter(x=>isFinite(x)).sort((a,b)=>a-b); if(!xs.length) return null;
  let i = xs.findIndex(x=>x>v); if(i<0) i=xs.length;
  // include equals
  const le = xs.lastIndexOf(v); if(le>=0) i=le+1;
  return Math.round(100*i/xs.length);
}

/* --------------- FRED --------------- */
function fredURL(series, key, params={}){
  const u = new URL('https://api.stlouisfed.org/fred/series/observations');
  u.searchParams.set('series_id', series);
  u.searchParams.set('api_key', key);
  u.searchParams.set('file_type', 'json');
  for(const [k,v] of Object.entries(params)) if(v!=null) u.searchParams.set(k,v);
  return u.toString();
}
async function fredSeries(series, key, {start}={}){
  const url = fredURL(series, key, start?{observation_start:start}: {});
  const txt = await fetchWithRace(url, $('#mode').value);
  const js = JSON.parse(txt);
  const obs = (js.observations||[]).map(o=>({date:o.date,value: +o.value}));
  return obs.filter(o=>isFinite(o.value));
}

/* --------------- Metadata --------------- */
const SERIES = [
  { id:'DGS10',     name:'10Y Treasury yield',          unit:'pct', invert:false, lowerIsRisk:false, recent:true },
  { id:'T10Y2Y',    name:'10Y–2Y spread',               unit:'pct', invert:true,  lowerIsRisk:false, recent:true },
  { id:'T10Y3M',    name:'10Y–3M spread',               unit:'pct', invert:true,  lowerIsRisk:false, recent:true },
  { id:'BAMLH0A0HYM2', name:'ICE BofA HY OAS',          unit:'pct', invert:false, lowerIsRisk:false, recent:true },
  { id:'STLFSI4',   name:'St. Louis Financial Stress (v4)', unit:'', invert:false, lowerIsRisk:false, recent:true },
  { id:'NFCI',      name:'Chicago Fed Financial Conditions', unit:'', invert:false, lowerIsRisk:false, recent:true },
  { id:'SP500',     name:'S&P 500 index',               unit:'',   invert:false, lowerIsRisk:false, recent:true },
  { id:'VIXCLS',    name:'VIX index',                   unit:'',   invert:false, lowerIsRisk:false, recent:true },
  { id:'UNRATE',    name:'Unemployment rate',           unit:'pct', invert:false, lowerIsRisk:false },
  { id:'ICSA',      name:'Initial jobless claims (wkly)', unit:'', invert:false, lowerIsRisk:false },
  { id:'CPIAUCSL',  name:'CPI (headline)',              unit:'',   invert:false, lowerIsRisk:false },
  { id:'CPILFESL',  name:'Core CPI',                    unit:'',   invert:false, lowerIsRisk:false },
  { id:'PCEPI',     name:'PCE prices',                  unit:'',   invert:false, lowerIsRisk:false },
  { id:'INDPRO',    name:'Industrial production',       unit:'',   invert:false, lowerIsRisk:true  },
  { id:'TCU',       name:'Capacity utilization',        unit:'',   invert:false, lowerIsRisk:true  },
  { id:'RSAFS',     name:'Retail sales (advance)',      unit:'',   invert:false, lowerIsRisk:true  },
  { id:'HOUST',     name:'Housing starts',              unit:'',   invert:false, lowerIsRisk:true  },
  { id:'PERMIT',    name:'Building permits',            unit:'',   invert:false, lowerIsRisk:true  },
  { id:'UMCSENT',   name:'UMich consumer sentiment',    unit:'',   invert:false, lowerIsRisk:true  },
  { id:'DTWEXBGS',  name:'Trade-weighted USD (broad)',  unit:'',   invert:false, lowerIsRisk:false },
];
/* Derived: Buffett Indicator (approx) -> WILSHIRE/GDP */
const BUFFETT = { id:'BUFFETT', name:'“Buffett” valuation (Wilshire/GDP, approx.)', unit:'pct', derived:true, invert:false, lowerIsRisk:false };

/* --------------- App --------------- */
const state = { rows:[], crc:null };

window.addEventListener('load', () => {
  const saved = localStorage.getItem('FRED_KEY'); if(saved) $('#apiKey').value = saved;
  $('#runBtn').addEventListener('click', run);
});

function setGauge(score,color){
  const arc = $('#crcArc'); const total = 2*Math.PI*44; // circumference
  const len = clamp(total * (score/100), 0, total);
  arc.setAttribute('stroke-dasharray', `${len} ${total-len}`);
  arc.setAttribute('stroke', color);
  $('#crcValue').textContent = score ?? '—';
}

function ragColor(s){
  if(s==null) return '#64748b';
  if(s<40) return getComputedStyle(document.documentElement).getPropertyValue('--ok').trim();
  if(s<70) return getComputedStyle(document.documentElement).getPropertyValue('--warn').trim();
  return getComputedStyle(document.documentElement).getPropertyValue('--bad').trim();
}

async function run(){
  const key = $('#apiKey').value.trim();
  if(!key){ alert('Paste your FRED API key first.'); return; }
  localStorage.setItem('FRED_KEY', key);

  $('#crcBadge').textContent = 'CRC: …';
  $('#exec').textContent = 'Loading latest data…';
  $('#indGrid').innerHTML = '';
  setGauge(0, 'var(--ring)');

  // fetch in parallel
  const TEN_YEARS_AGO = new Date(); TEN_YEARS_AGO.setFullYear(TEN_YEARS_AGO.getFullYear()-10);
  const start = TEN_YEARS_AGO.toISOString().slice(0,10);

  // base series
  const promises = SERIES.map(async meta=>{
    const obs = await fredSeries(meta.id, key, {start});
    const latest = obs[obs.length-1];
    if(!latest) return {meta, error:true};

    // compute score: percentile of last-10y (with sensible transform)
    const xs = obs.map(o=>o.value);
    let val = latest.value;

    // spread “invert”: lower spread = more risk
    if(meta.invert && !meta.lowerIsRisk){
      // flip sign by using negative values for percentile
      const px = xs.map(v=>-v); const p = percentile(px, -val);
      return {meta, latest, score: p, value: val};
    }
    // for series where LOWER value implies higher risk -> score by inverted percentile
    if(meta.lowerIsRisk){
      const p = percentile(xs, val);
      return {meta, latest, score: 100 - p, value: val};
    }
    // default: higher value => higher risk
    const p = percentile(xs, val);
    return {meta, latest, score: p, value: val};
  });

  // Buffett (approx): Wilshire 5000 / GDP, last 10y ratio
  const buffettPromise = (async ()=>{
    try{
      const wil = await fredSeries('WILL5000INDFC', key, {start}); // Wilshire (index)
      const gdp = await fredSeries('GDP', key, {start}); // quarterly, billions SAAR
      if(!wil.length || !gdp.length) throw new Error('missing');

      // build ratio at GDP points: use Wilshire value on or just before GDP date
      const wByDate = new Map(wil.map(o=>[o.date, o.value]));
      function nearestWil(d){
        // simple backward search
        let dt = new Date(d);
        for(let i=0;i<7;i++){ // up to a week back (GDP dates are quarter-ends)
          const s = dt.toISOString().slice(0,10);
          if(wByDate.has(s)) return wByDate.get(s);
          dt.setDate(dt.getDate()-1);
        }
        // fallback to last Wilshire obs before date
        return wil.filter(o=>o.date<=d).pop()?.value ?? wil[wil.length-1].value;
      }

      const ratios=[];
      for(const o of gdp){
        const w = nearestWil(o.date);
        if(isFinite(w) && isFinite(o.value) && o.value>0){
          const r = (w / o.value) * 100; // scale to “percent like” for readability
          ratios.push({date:o.date, value:r});
        }
      }
      const last = ratios[ratios.length-1];
      const xs = ratios.map(x=>x.value);
      const p = percentile(xs, last.value);

      return { meta: BUFFETT, latest:last, score:p, value:last.value };
    }catch(e){ return { meta: BUFFETT, error:true }; }
  })();

  const rows = await Promise.all([...promises, buffettPromise]);

  // compute CRC
  const valid = rows.filter(r=>!r.error && r.score!=null);
  const crc = valid.length ? Math.round(valid.reduce((a,b)=>a+b.score,0)/valid.length) : null;
  state.rows = rows; state.crc = crc;

  // UI: badge + gauge
  const color = ragColor(crc);
  $('#crcBadge').textContent = (crc==null) ? 'CRC: —' :
    `CRC: ${crc} — ${crc<40?'GREEN':(crc<70?'AMBER':'RED')}`;
  setGauge(crc??0, color);

  // Executive summary (≤500 words, terse)
  $('#exec').textContent = buildExecutiveSummary(crc, valid);

  // Indicators grid
  const grid = $('#indGrid');
  for(const r of rows){
    grid.appendChild(cardFor(r));
  }
}

function cardFor(r){
  const el = document.createElement('div'); el.className = 'ind';
  const name = r.meta.name + (r.meta.id==='SP500MN'?' (monthly avg)':'');
  const chip = `<span class="chip">${r.meta.id}</span>`;
  el.innerHTML = `
    <div class="meta">
      <div class="name">${name} ${chip}</div>
      <div>${r.latest? ymd(r.latest.date):'—'}</div>
    </div>
    <div class="val">${formatValue(r)}</div>
    <div class="meta muted"><span class="score">score ${r.score??'—'}</span></div>
  `;
  return el;
}
function formatValue(r){
  if(r.error || !r.latest) return '—';
  const v = r.latest.value;
  if(r.meta.unit==='pct' || r.meta.id==='DGS10' || r.meta.id==='T10Y2Y' || r.meta.id==='T10Y3M' || r.meta.id==='BUFFETT'){
    return fmtPct(v,2);
  }
  // weekly claims integer
  if(r.meta.id==='ICSA') return Intl.NumberFormat('en-US').format(Math.round(v));
  // otherwise numeric with mild formatting
  return (Math.abs(v)>=1000) ? Intl.NumberFormat('en-US').format(Math.round(v)) : (Math.round(v*1000)/1000).toString();
}

/* --------------- Executive summary generator --------------- */
function buildExecutiveSummary(crc, rows){
  const byId = Object.fromEntries(rows.map(r=>[r.meta.id, r]));
  const pct = id => byId[id]?.score;
  const val = id => byId[id]?.latest?.value;

  const parts = [];

  // headline
  parts.push(`CRC ${crc ?? '—'} — ${crc<40?'GREEN':(crc<70?'AMBER':'RED')}.`);

  // curve / rates
  if(isFinite(pct('T10Y2Y')) && isFinite(pct('T10Y3M'))){
    const inv = (val('T10Y2Y')<0 || val('T10Y3M')<0);
    parts.push(`Curve ${inv?'inverted':''}${!inv?'tight':''}, keeping recession risk ${inv?'elevated':'meaningful'}.`);
  }
  if(isFinite(pct('DGS10'))){
    parts.push(`10-year yield sits near the ${pct('DGS10')}th pctile of its decade range.`);
  }

  // credit / stress
  if(isFinite(pct('BAMLH0A0HYM2'))){
    parts.push(`High-yield spreads at the ${pct('BAMLH0A0HYM2')}th pctile;`);
  }
  if(isFinite(pct('STLFSI4'))||isFinite(pct('NFCI'))){
    parts.push(`stress gauges ${pct('STLFSI4')>50||pct('NFCI')>50?'elevated':'benign'}.`);
  }

  // valuations
  if(isFinite(pct('BUFFETT'))){
    parts.push(`“Buffett” valuation ratio is at the ${pct('BUFFETT')}th pctile.`);
  } else if(isFinite(pct('SP500'))){
    parts.push(`S&P 500 level sits at the ${pct('SP500')}th pctile.`);
  }

  // growth / activity
  const cyc = ['INDPRO','TCU','RSAFS','HOUST','PERMIT'];
  const weak = cyc.filter(id=>pct(id)>60); // remember lowerIsRisk flips score already
  if(weak.length){
    parts.push(`Real-economy momentum uneven: ${weak.length} of 5 activity gauges show late-cycle risk.`);
  }

  // labor / inflation
  if(isFinite(pct('UNRATE'))||isFinite(pct('ICSA'))){
    parts.push(`Labor steady but watch claims/unemployment (scores ${pct('ICSA')}, ${pct('UNRATE')}).`);
  }
  const inf = Math.max(pct('CPIAUCSL')??0, pct('CPILFESL')??0, pct('PCEPI')??0);
  if(isFinite(inf)) parts.push(`Inflation pressures ${inf>60?'lingering':'easing'}.`);

  // USD
  if(isFinite(pct('DTWEXBGS'))) parts.push(`USD strength (score ${pct('DTWEXBGS')}) tightens global financial conditions.`);

  return parts.join(' ');
}
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marshall WBCI — World’s Best Crash Indicator (v1.0)</title>
<style>
:root{
  --bg:#0d1722;--panel:#0f1b27;--card:#102133;--edge:#1b2c3d;
  --text:#eaf0f6;--muted:#a8b6c6;--blue:#3a83ff;
  --green:#2ecc71;--amber:#f4b740;--red:#ff5565;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
h1{font:800 clamp(22px,5vw,36px)/1.15 system-ui;margin:20px 0}
h2{font:700 20px/1.25 system-ui;margin:0 0 10px}
.container{max-width:1000px;margin:0 auto;padding:16px}
.panel{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{padding:12px 14px;border:1px solid var(--edge);border-radius:12px;background:#0b1620;color:var(--text)}
input{flex:1 1 280px}
select{flex:0 0 260px}
button{padding:12px 18px;border:0;border-radius:12px;background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;padding:8px 12px;border-radius:12px;background:#1b2636;border:1px solid var(--edge);font-weight:800}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:999px;background:#152234;border:1px solid #243449;color:#b8c8d8;font-weight:700}

.gauge{width:min(150px,32vw);min-width:120px;aspect-ratio:1/1;border-radius:50%;
  background:conic-gradient(var(--amber) 0 0,#223041 0 360deg);position:relative;flex:0 0 auto}
.gauge>.hole{position:absolute;inset:12px;aspect-ratio:1/1;border-radius:50%;
  background:var(--bg);border:1px solid var(--edge);display:flex;align-items:center;justify-content:center;
  font:800 clamp(22px,6vw,36px)/1 system-ui}
.flex{display:flex;gap:18px;align-items:center}
.muted{color:var(--muted)}
.err{background:#3b1b23;border:1px solid #5a2a37;color:#ffd7de;padding:10px 12px;border-radius:12px;margin-top:10px}

.grid{display:grid;gap:14px}
@media(min-width:680px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
@media(min-width:980px){ .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }

.card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;position:relative;overflow:hidden}
.kv{display:flex;justify-content:space-between;gap:8px;align-items:center}
.series{font:700 18px/1.2 system-ui}
.value{font:800 clamp(22px,6vw,34px)/1.1 system-ui;margin:6px 0}
.sub{display:flex;gap:10px;align-items:center;color:var(--muted)}
.bandbar{height:6px;border-radius:999px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red));opacity:.9}
.explain{margin-top:10px;color:var(--muted)}
.vline{position:absolute;left:0;top:0;bottom:0;width:4px}
.v-green{background:linear-gradient(90deg,#1f8f5f,#2ecc71)}
.v-amber{background:linear-gradient(90deg,#9b7a17,#f4b740)}
.v-red{background:linear-gradient(90deg,#a11c2a,#ff5565)}

/* mini chart */
.spark{width:100%;height:86px;margin:8px 0 2px;border:1px solid var(--edge);border-radius:10px;background:#0b1620}
.axis{stroke:#223041;stroke-width:1}
.path{fill:none;stroke-width:2.2}
.tick{font-size:10px;fill:#7f91a6}

ul.clean{margin:0 0 0 18px;padding:0;display:grid;gap:6px}
footer{margin:20px 0 12px;text-align:center;color:#7f91a6;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h1>Marshall WBCI — World’s Best Crash Indicator</h1>

  <div class="panel">
    <div class="row">
      <input id="apiKey" type="text" placeholder="FRED API key (stored locally)"/>
      <select id="mode">
        <option value="advanced">Advanced (predictive tilt + synchronicity)</option>
        <option value="simple">Simple (equal weights)</option>
      </select>
      <button id="runBtn">Run / Refresh</button>
    </div>
    <div id="topErr" class="err" style="display:none"></div>
  </div>

  <div class="panel">
    <div class="flex">
      <div class="gauge"><div id="wcbiNum" class="hole">--</div></div>
      <div>
        <div class="chips">
          <div id="bandChip" class="chip">Band: —</div>
          <div id="breadthChip" class="chip">Breadth: —</div>
          <div id="syncChip" class="chip">Synchronicity: —</div>
          <div id="shockChip" class="chip">Shock: —</div>
        </div>
        <div id="runMeta" class="muted" style="margin-top:10px">Scores = percentiles vs each series’ last 10 years (with sensible inverts). Enhancers: Breadth, Synchronicity, Shock.</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Executive Summary</h2>
    <div id="execBody" class="muted">Run to generate a live note driven by current category scores and changes.</div>
  </div>

  <div class="panel">
    <h2>Categories</h2>
    <div id="cards" class="grid cols-2 cols-3"></div>
  </div>

  <footer>Marshall WBCI v1.0 • Built on public FRED data</footer>
</div>

<script>
/* ====================== Utils & plumbing ====================== */
const $ = s=>document.querySelector(s);
const startISO = ()=>{const d=new Date();d.setFullYear(d.getFullYear()-10);return d.toISOString().slice(0,10);};
const proxies=[u=>u,u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),u=>'https://api.codetabs.com/v1/proxy/?quest='+encodeURIComponent(u)];
function timeout(ms,p){return Promise.race([p,new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),ms))]);}
async function jsonWithProxies(url){let last;for(const wrap of proxies){try{const r=await timeout(9000,fetch(wrap(url),{mode:'cors',cache:'no-store'}));if(!r.ok) throw new Error('HTTP '+r.status);return await r.json();}catch(e){last=e;}}throw last||new Error('fetch failed');}
function fredURL(path,params){const u=new URL('fred/'+path,'https://api.stlouisfed.org/');for(const[k,v] of Object.entries(params))u.searchParams.set(k,v);u.searchParams.set('_t',Date.now());return u.toString();}
function percentileRank(values, x){const arr=values.filter(v=>Number.isFinite(v)).slice().sort((a,b)=>a-b);if(!arr.length||!Number.isFinite(x))return null;let lo=0,hi=arr.length;while(lo<hi){const m=(lo+hi>>1);if(arr[m]<=x)lo=m+1;else hi=m;}return Math.round(100*lo/arr.length);}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function band(score){if(score==null) return {name:'—',color:'#445',cls:''};if(score<40)return{name:'Green',color:'var(--green)',cls:'v-green'};if(score<=70)return{name:'Amber',color:'var(--amber)',cls:'v-amber'};return{name:'Red',color:'var(--red)',cls:'v-red'};}
function mean(a){return a.length? a.reduce((x,y)=>x+y,0)/a.length : 0;}
function stdev(a){if(a.length<2) return 1;const m=mean(a);return Math.sqrt(mean(a.map(v=>(v-m)*(v-m))))||1;}
const fmt = {
  pct:x=>Number.isFinite(x)?(+x).toFixed(2)+'%':'—',
  num:x=>Number.isFinite(x)?Number(x).toLocaleString():'—',
  lev:x=>Number.isFinite(x)?(Math.abs(x)>=1000?Number(x).toLocaleString():(+x.toFixed(4))).toString():'—'
};

/* ====================== Categories & series ====================== */
/* WBCI v1.0 categories; all FRED-available */
const CATS = [
  { id:'rates',    name:'Rates / Curve',      why:'Tight or inverting curves + high long rates raise crash risk via refinancing and valuation pressure.' },
  { id:'credit',   name:'Credit / Stress',    why:'Credit spreads and systemic stress tend to lead equity drawdowns.' },
  { id:'liquidity',name:'Liquidity',          why:'When bond market depth and central bank liquidity falter, sell-offs accelerate.' },
  { id:'usd',      name:'USD / External',     why:'A strong USD tightens global financial conditions and can trigger funding squeezes.' },
  { id:'energy',   name:'Energy Shock',       why:'Sudden energy burden spikes often precede recessions and earnings downgrades.' },
  { id:'house',    name:'Labor / Household',  why:'Rising claims and household delinquencies erode the demand buffer.' },
  { id:'act',      name:'Activity / Sentiment', why:'Softening real activity and confidence raise vulnerability to shocks.' }
];

const SERIES = [
  // Rates / Curve
  {id:'DGS10',    cat:'rates', name:'10y Treasury yield', code:'DGS10',      fmt:'pct',  invert:false},
  {id:'T10Y2Y',   cat:'rates', name:'10y–2y spread',      code:'T10Y2Y',     fmt:'pct',  invert:true},
  {id:'T10Y3M',   cat:'rates', name:'10y–3m spread',      code:'T10Y3M',     fmt:'pct',  invert:true},

  // Credit / Stress
  {id:'HY_OAS',   cat:'credit',name:'HY OAS',             code:'BAMLH0A0HYM2',fmt:'pct', invert:false},
  {id:'STLFSI4',  cat:'credit',name:'St. Louis FSI v4',   code:'STLFSI4',    fmt:'lev',  invert:false},
  {id:'NFCI',     cat:'credit',name:'Chicago Fed NFCI',   code:'NFCI',       fmt:'lev',  invert:false},

  // Liquidity
  // Synthetic realized bond vol from DGS10 (computed later)
  {id:'UST_RVOL', cat:'liquidity', name:'UST realized vol (proxy)', code:'__SYNTH_RVOL__', fmt:'lev', invert:false},
  {id:'WALCL',    cat:'liquidity', name:'Fed balance sheet (assets)', code:'WALCL',     fmt:'num',  invert:true},

  // USD / External
  {id:'DTWEXBGS', cat:'usd',   name:'Broad trade-weighted USD', code:'DTWEXBGS', fmt:'lev', invert:false},

  // Energy
  {id:'WTI',      cat:'energy',name:'WTI crude oil',       code:'DCOILWTICO', fmt:'lev', invert:false},
  {id:'NATGAS',   cat:'energy',name:'Henry Hub gas',       code:'DHHNGSP',    fmt:'lev', invert:false},

  // Labor / Household
  {id:'ICSA',     cat:'house', name:'Initial jobless claims', code:'ICSA',    fmt:'num',  invert:false},
  {id:'UNRATE',   cat:'house', name:'Unemployment rate',      code:'UNRATE',  fmt:'pct',  invert:false},
  {id:'JTSLDR',   cat:'house', name:'JOLTS layoffs & discharges', code:'JTSLDR', fmt:'num', invert:false},
  {id:'DRCC',     cat:'house', name:'Credit card delinquencies',  code:'DRCCLACBS', fmt:'lev', invert:false},
  {id:'DRAL',     cat:'house', name:'Auto loan delinquencies',    code:'DRALACBS',  fmt:'lev', invert:false},
  {id:'W875RX1',  cat:'house', name:'Real income ex-transfers',   code:'W875RX1',   fmt:'lev', invert:true},

  // Activity / Sentiment
  {id:'INDPRO',   cat:'act',   name:'Industrial production', code:'INDPRO',  fmt:'lev',  invert:true},
  {id:'TCU',      cat:'act',   name:'Capacity utilization',  code:'TCU',     fmt:'lev',  invert:true},
  {id:'RSAFS',    cat:'act',   name:'Retail sales (advance)',code:'RSAFS',   fmt:'num',  invert:true},
  {id:'UMCSENT',  cat:'act',   name:'UMich consumer sentiment', code:'UMCSENT', fmt:'lev', invert:true},
];

/* ====================== Data fetch ====================== */
async function fetchSeries(code, apiKey, start){
  if(code==='__SYNTH_RVOL__') return {latest:null,date:null,history:[]}; // computed later
  const url=fredURL('series/observations',{series_id:code,api_key:apiKey,file_type:'json',observation_start:start});
  const j=await jsonWithProxies(url);
  const obs=(j.observations||[]).filter(o=>o.value!=='.').map(o=>({t:o.date,v:+o.value}));
  const last=obs[obs.length-1]||{};
  return {latest:last.v??null,date:last.t??null,history:obs};
}

/* ====================== Transforms ====================== */
function scoreFromHistory(valsLatest, invert){
  const {values, latest} = valsLatest;
  const pct = percentileRank(values, latest);
  if(pct==null) return null;
  return clamp(invert ? (100-pct) : pct, 0, 100);
}

function resampleMonthly(history){
  // take last obs per YYYY-MM
  const map=new Map();
  for(const o of history){
    const ym=o.t.slice(0,7);
    map.set(ym, o);
  }
  const arr=[...map.entries()].sort((a,b)=>a[0]<b[0]?-1:1).map(e=>e[1]);
  return arr;
}

function makeUSTRealizedVol(dgs10History){
  // 10-day rolling sum of absolute daily changes (percent points)
  if(!dgs10History.length) return [];
  const h=dgs10History.map(x=>({t:x.t,v:x.v}));
  const out=[];
  for(let i=1;i<h.length;i++){
    const delta = Math.abs(h[i].v - h[i-1].v);
    out.push({t:h[i].t, v:delta});
  }
  // 10-day rolling sum
  const roll=[];
  let acc=0;
  const win=10;
  for(let i=0;i<out.length;i++){
    acc += out[i].v;
    if(i>=win) acc -= out[i-win].v;
    if(i>=win-1) roll.push({t:out[i].t, v:acc});
  }
  return roll;
}

/* ====================== WBCI computation ====================== */
function buildCategoryScores(rawById){
  // 1) series scores (percentile within last 10y), with sensible inverts
  const byCat = new Map();
  // synth RVOL from DGS10
  const rvolHist = makeUSTRealizedVol(rawById.DGS10?.history||[]);
  const allSeries = SERIES.map(s=> s.id==='UST_RVOL' ? {...s, __hist:rvolHist} : s);

  const seriesScores = {};
  for(const s of allSeries){
    const hist = s.__hist || (rawById[s.id]?.history||[]);
    const vals = hist.map(o=>o.v).filter(Number.isFinite);
    const latest = vals.length? vals[vals.length-1] : NaN;
    const score = scoreFromHistory({values:vals, latest}, s.invert);
    seriesScores[s.id]={score, latest, date:(rawById[s.id]?.date || (hist[hist.length-1]?.t) || null), history:hist, meta:s};
    if(!byCat.has(s.cat)) byCat.set(s.cat, []);
    byCat.get(s.cat).push(seriesScores[s.id]);
  }

  // 2) category sub-scores = average of available series scores
  const catScores = {};
  for(const c of CATS){
    const arr = (byCat.get(c.id)||[]).map(x=>x.score).filter(s=>s!=null);
    catScores[c.id] = arr.length? Math.round(mean(arr)) : null;
  }

  return {seriesScores, catScores, byCat};
}

function computeBreadth(catScores){
  const vals = Object.values(catScores).filter(v=>v!=null);
  if(!vals.length) return 0;
  const share = vals.filter(v=>v>=70).length / vals.length;
  return share; // 0..1
}

function computeSync(catMonthlySeries, catScores){
  // Build monthly category series for last ~18 months, then average pairwise correlations among categories currently >=60
  const keys = Object.keys(catMonthlySeries);
  const active = keys.filter(k=> (catScores[k]??0) >= 60);
  if(active.length<2) return 0;
  // Align by month keys
  const months = [...new Set(active.flatMap(k=>catMonthlySeries[k].map(p=>p.t)))].sort();
  const mats = active.map(k=>{
    const map = new Map(catMonthlySeries[k].map(p=>[p.t,p.v]));
    return months.map(m=> map.get(m) ?? null);
  });
  // Drop months where any is null (strict align)
  const keepIdx=[]; for(let i=0;i<months.length;i++){ if(mats.every(row=>row[i]!=null)) keepIdx.push(i); }
  if(keepIdx.length<4) return 0;
  const aligned = mats.map(row=> keepIdx.map(i=>row[i]));
  // pairwise Pearson
  const cors=[];
  for(let i=0;i<aligned.length;i++){
    for(let j=i+1;j<aligned.length;j++){
      const a=aligned[i], b=aligned[j];
      const ma=mean(a), mb=mean(b);
      const num = a.reduce((acc,_,k)=> acc + (a[k]-ma)*(b[k]-mb), 0);
      const den = Math.sqrt(a.reduce((acc,_,k)=> acc + (a[k]-ma)**2,0)) * Math.sqrt(b.reduce((acc,_,k)=> acc + (b[k]-mb)**2,0));
      const r = den? num/den : 0;
      cors.push(r);
    }
  }
  return cors.length? clamp(mean(cors), 0, 1) : 0;
}

function computeShock(catMonthlySeries){
  // For each category: Δ (last minus 3m ago); z-score vs past deltas; keep positives only; average and scale 0..100
  const zs=[];
  for(const [_,arr] of Object.entries(catMonthlySeries)){
    if(arr.length<5) continue;
    const vals = arr.map(p=>p.v);
    const deltas = [];
    for(let i=3;i<vals.length;i++) deltas.push(vals[i]-vals[i-3]);
    if(deltas.length<3) continue;
    const mu=mean(deltas), sd=stdev(deltas);
    const lastDelta = vals[vals.length-1] - vals[vals.length-4];
    const z = (lastDelta - mu) / (sd||1);
    if(z>0) zs.push(z);
  }
  const avgZ = zs.length? mean(zs) : 0;
  return clamp((avgZ/2.5)*100, 0, 100); // 0..100 where ~2.5σ ~ 100
}

function buildMonthlyCategorySeries(seriesScores){
  // per category, create monthly series of category score (avg of series monthly percentiles)
  // For each series: convert to monthly by last-of-month, compute monthly percentile score (over rolling 10y window)
  const byCatMonthly = {};
  // Group series by cat
  const byCat = {};
  for(const s of SERIES){
    if(!byCat[s.cat]) byCat[s.cat]=[];
    byCat[s.cat].push(s.id);
  }
  for(const [cat, ids] of Object.entries(byCat)){
    // Gather monthly arrays for each series
    const monthlySeries = ids.map(id=>{
      const sc = seriesScores[id];
      const h = sc?.history || [];
      const m = resampleMonthly(h);
      const vals = m.map(o=>o.v);
      if(vals.length<6) return []; // too short
      // rolling percentile vs 10y window approximated by full-window (simplify)
      const sorted = vals.slice().sort((a,b)=>a-b);
      return m.map(o=>({t:o.t.slice(0,7), v: scoreFromHistory({values:sorted, latest:o.v}, sc.meta.invert)}));
    }).filter(arr=>arr.length);
    // Merge by month (average)
    const months = [...new Set(monthlySeries.flatMap(a=>a.map(p=>p.t)))].sort();
    const out=[];
    for(const m of months){
      const xs = monthlySeries.map(arr=> {
        const f = arr.find(p=>p.t===m);
        return f? f.v : null;
      }).filter(v=>v!=null);
      if(xs.length) out.push({t:m, v: Math.round(mean(xs))});
    }
    byCatMonthly[cat]=out.slice(-24); // last 24 months
  }
  return byCatMonthly;
}

function computeBaseComposite(catScores, mode){
  const cats = CATS.map(c=>c.id);
  const vals = cats.map(k=>catScores[k]).filter(v=>v!=null);
  if(!vals.length) return null;
  if(mode==='simple') return Math.round(mean(vals));
  // predictive tilt
  const wMap={credit:1.4, rates:1.3, liquidity:1.2, usd:1.0, energy:1.0, house:1.1, act:0.9};
  const items = cats.map(k=>({s:catScores[k], w:wMap[k]||1})).filter(x=>x.s!=null);
  const W = items.reduce((a,b)=>a+b.w,0);
  return Math.round(items.reduce((a,b)=>a+b.w*b.s,0)/W);
}

function computeWBCI(base, sync, breadth, shock){
  if(base==null) return null;
  let x = base * (1 + 0.4*sync + 0.25*breadth) + 0.25*shock;
  return clamp(Math.round(x), 0, 100);
}

/* ====================== UI helpers ====================== */
function paintGauge(x){
  $('#wcbiNum').textContent = x==null?'--':x;
  const b = band(x);
  const deg = x==null?0:Math.max(3,Math.min(360,Math.round(x/100*360)));
  document.querySelector('.gauge').style.background = `conic-gradient(${b.color} 0 ${deg}deg,#223041 ${deg}deg 360deg)`;
  $('#bandChip').textContent = `Band: ${b.name}`;
}

function sparklineSVG(history, color){
  if(!history?.length) return '';
  const cut = history.slice(-24); // months
  const xs = cut.map((d,i)=>i), vs = cut.map(d=>d.v);
  const w=360,h=86,pad=8;
  const min=Math.min(...vs), max=Math.max(...vs);
  const y = v => max===min ? h/2 : h - ((v-min)/(max-min))*h;
  const x = i => (i/(xs.length-1||1))*w;
  let d=''; cut.forEach((pt,i)=>{ d += (i?'L':'M') + x(i)+','+y(pt.v)+' '; });
  const col = color||'#8ab6ff';
  return `
  <svg class="spark" viewBox="0 0 ${w+pad*2} ${h+pad*2}" preserveAspectRatio="none">
    <g transform="translate(${pad},${pad})">
      <line class="axis" x1="0" y1="${h}" x2="${w}" y2="${h}"></line>
      <line class="axis" x1="0" y1="0" x2="0" y2="${h}"></line>
      <path class="path" stroke="${col}" d="${d}"></path>
      <text class="tick" x="2" y="${h-4}">${cut[0].t}</text>
      <text class="tick" x="${w-34}" y="${h-4}">${cut[cut.length-1].t}</text>
      <text class="tick" x="2" y="10">${max.toFixed(0)}</text>
      <text class="tick" x="2" y="${h-20}">${min.toFixed(0)}</text>
    </g>
  </svg>`;
}

function renderCards(catScores, catMonthlySeries){
  const wrap = $('#cards'); wrap.innerHTML='';
  for(const c of CATS){
    const s = catScores[c.id];
    const b = band(s);
    const svg = sparklineSVG(catMonthlySeries[c.id]||[], b.color);
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="vline ${b.cls}"></div>
      <div class="kv"><div class="series">${c.name}</div><div class="badge" style="background:#152234;border-color:#223345">${s==null?'—':s}</div></div>
      ${svg}
      <div class="bandbar"></div>
      <div class="explain"><b>Baseline:</b> ${b.name}. <span class="muted">${c.why}</span></div>
    `;
    wrap.appendChild(div);
  }
}

function writeExecNote(base, breadth, sync, shock, catScores){
  const b = band(base||0).name;
  const cats = Object.entries(catScores).filter(([_,v])=>v!=null).sort((a,b)=>b[1]-a[1]);
  const top = cats.slice(0,3).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`).join(', ');
  const low = cats.slice(-2).map(([k,v])=>`${CATS.find(x=>x.id===k).name} ${v} (${band(v).name})`).join(', ');
  const bullets = [];
  bullets.push(`<b>Base risk:</b> ${base==null?'—':base} — ${b}. <b>Breadth:</b> ${(breadth*100).toFixed(0)}%. <b>Synchronicity:</b> ${(sync*100).toFixed(0)}%. <b>Shock:</b> ${shock.toFixed(0)}.`);
  if(top) bullets.push(`<b>Main pressures:</b> ${top}.`);
  if(low) bullets.push(`<b>Offsets:</b> ${low}.`);
  bullets.push(`<b>Why this matters:</b> base shows where risk stands vs the last decade; breadth & synchronicity tell us how <i>many</i> pillars are moving together; shock captures <i>speed</i> of deterioration. Crashes tend to emerge when all three are elevated.`);
  bullets.push(`<b>Watch next:</b> further bear‑steepening of the curve; a decisive widening in HY OAS and systemic stress gauges; a persistent turn higher in weekly claims. A synchronized move likely drives WBCI toward Red; easing OAS and steady claims would drag it back toward Green.`);
  $('#execBody').innerHTML = `<ul class="clean">${bullets.map(x=>`<li>${x}</li>`).join('')}</ul>`;
}

/* ====================== Runner ====================== */
const state={raw:{}, seriesScores:{}, catScores:{}, monthly:{}};

function saveKey(){ const k=$('#apiKey').value.trim(); if(k) localStorage.setItem('fred_key',k); }
function loadKey(){ const k=localStorage.getItem('fred_key'); if(k) $('#apiKey').value=k; }

async function run(){
  $('#topErr').style.display='none'; $('#topErr').textContent='';
  const key=$('#apiKey').value.trim(); if(!key) return alert('Enter FRED API key'); saveKey();
  $('#runBtn').disabled=true; $('#runBtn').textContent='Running…';

  const start = startISO();
  // 1) fetch all series (parallel, resilient)
  const tasks = SERIES.map(s=> fetchSeries(s.code, key, start)
    .then(r=>({ok:true,id:s.id,data:r}))
    .catch(e=>({ok:false,id:s.id,err:e})));
  const settled = await Promise.allSettled(tasks);
  const result = settled.map(x=>x.value || {ok:false,id:'?',err:new Error('unknown')});
  const fails = [];
  state.raw={};
  for(const r of result){
    const meta = SERIES.find(s=>s.id===r.id);
    if(!meta) continue;
    if(!r.ok){ fails.push(meta.name); state.raw[meta.id]={latest:null,date:null,history:[]}; continue; }
    state.raw[meta.id]=r.data;
  }
  // 2) compute category/series scores (adds synthetic RVOL)
  const built = buildCategoryScores(state.raw);
  state.seriesScores = built.seriesScores;
  state.catScores    = built.catScores;

  // 3) build monthly category series (for sync/shock & sparklines)
  state.monthly = buildMonthlyCategorySeries(state.seriesScores);

  // 4) compute enhancers
  const breadth = computeBreadth(state.catScores);                 // 0..1
  const sync    = computeSync(state.monthly, state.catScores);     // 0..1
  const shock   = computeShock(state.monthly);                      // 0..100

  // 5) base & final
  const mode = $('#mode').value;
  const base = computeBaseComposite(state.catScores, mode);
  const WBCI = computeWBCI(base, sync, breadth, shock);

  // 6) paint UI
  paintGauge(WBCI);
  $('#breadthChip').textContent = `Breadth: ${(breadth*100).toFixed(0)}%`;
  $('#syncChip').textContent    = `Synchronicity: ${(sync*100).toFixed(0)}%`;
  $('#shockChip').textContent   = `Shock: ${shock.toFixed(0)}`;
  $('#runMeta').textContent     = `Last run: ${new Date().toLocaleString()} • Mode: ${mode} • Using ${Object.values(state.catScores).filter(x=>x!=null).length} categories`;
  renderCards(state.catScores, state.monthly);
  writeExecNote(base, breadth, sync, shock, state.catScores);

  if(fails.length){
    $('#topErr').style.display='block';
    $('#topErr').textContent = `Loaded with partial data (timed‑out/empty: ${fails.join(', ')}). Run again if needed.`;
  }

  $('#runBtn').disabled=false; $('#runBtn').textContent='Run / Refresh';
}

document.getElementById('runBtn').addEventListener('click', run);
loadKey();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Crash RAG Composite — Turbo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#0b1020;--panel:#121839;--panel2:#101633;--ink:#e8eefb;--muted:#a8b4d8;
    --b:#22283f;--ok:#0d7a46;--warn:#a86700;--bad:#8f1626;--chip:#1c244b;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px 12px;border-bottom:1px solid var(--b);text-align:center}
  h1{margin:0;font-size:22px}
  .wrap{max-width:1100px;margin:0 auto;padding:18px 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  input,select{padding:10px 12px;border-radius:8px;border:1px solid var(--b);background:#0e1733;color:#cfe1ff}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid var(--b);background:#1b2553;color:#fff;cursor:pointer}
  .badge{display:inline-block;padding:16px 24px;border-radius:14px;font-weight:800;letter-spacing:.2px;margin:14px 0}
  .g{background:var(--ok)} .a{background:var(--warn)} .r{background:var(--bad)} .x{background:#444}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{border-bottom:1px solid var(--b);padding:8px 6px;vertical-align:top}
  th{color:#c7d5ff;text-align:left}
  .chip{display:inline-block;background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px;color:#bcd3ff}
  .muted{color:var(--muted)}
  .right{text-align:right}
  .small{font-size:12px}
  .log{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:var(--panel2);border:1px solid var(--b);border-radius:12px;padding:12px;min-height:100px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px}
  .card{background:var(--panel);border:1px solid var(--b);border-radius:12px;padding:12px}
  .card h3{margin:0 0 6px 0;font-size:15px}
</style>
</head>
<body>
<header><h1>Crash RAG Composite — United States (Turbo)</h1></header>

<div class="wrap">
  <div class="row">
    <input id="fredKey" placeholder="FRED API key (32 chars)" style="min-width:320px" />
    <select id="scope">
      <option value="core" selected>Core (fast, reliable)</option>
      <option value="full">Full (~50 indicators)</option>
    </select>
    <button id="run" class="btn">Run / Refresh</button>
  </div>

  <div id="crc" class="badge x">CRC: Loading…</div>

  <div class="grid">
    <div class="card">
      <h3>Notes</h3>
      <div class="small">
        Risk = latest value’s <b>percentile vs last 10y</b> (or available window).  
        <span class="chip">invert</span> means higher value = higher crash risk.  
        Composite = simple average of available series.
      </div>
    </div>
    <div class="card">
      <h3>Speed</h3>
      <div class="small">
        Parallel fetch (8 at a time). Each series races proxies:  
        <code>cors.isomorphic-git.org</code> • <code>api.allorigins.win</code> •
        <code>thingproxy.freeboard.io</code> • <code>api.codetabs.com</code>.
      </div>
    </div>
    <div class="card">
      <h3>Log</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <table id="tbl">
    <thead>
      <tr><th>Series</th><th>ID</th><th class="right">Latest</th><th>Date</th><th class="right">Score</th><th>Proxy</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* =================== CONFIG (fast) =================== */
const DEFAULT_KEY = "b78d7171c0fc257622597099f88fa7f7"; // your key
const YEARS_BACK = 10;
const REQ_TIMEOUT_MS = 5000;     // short timeouts
const CONCURRENCY = 8;           // parallel fetches
const USE_ALL_50 = false;        // default scope on load

// Core set (fast + representative)
const CORE = [
  { id:"UNRATE",     name:"Unemployment rate",                invert:true },
  { id:"ICSA",       name:"Initial jobless claims (wkly)",    invert:true },
  { id:"CPIAUCSL",   name:"CPI (headline)",                   invert:true },
  { id:"CPILFESL",   name:"Core CPI",                         invert:true },
  { id:"PCEPI",      name:"PCE prices",                       invert:true },
  { id:"INDPRO",     name:"Industrial production",            invert:false },
  { id:"TCU",        name:"Capacity utilization",             invert:true },
  { id:"RSAFS",      name:"Retail sales (advance)",           invert:false },
  { id:"HOUST",      name:"Housing starts",                   invert:false },
  { id:"PERMIT",     name:"Building permits",                 invert:false },
  { id:"SP500MN",    name:"S&P 500 (monthly avg)",            invert:false }, // lighter & faster than SP500 daily
  { id:"VIXCLS",     name:"VIX index",                        invert:true },
  { id:"T10Y3M",     name:"10Y-3M spread",                    invert:true },
  { id:"T10Y2Y",     name:"10Y-2Y spread",                    invert:true },
  { id:"DGS10",      name:"10Y Treasury yield",               invert:true },
  { id:"BAMLH0A0HYM2", name:"ICE BofA HY OAS",                invert:true },
  { id:"STLFSI2",    name:"St. Louis Financial Stress",       invert:true },
  { id:"NFCI",       name:"Chicago Fed Fin. Conditions",      invert:true },
  { id:"UMCSENT",    name:"UMich consumer sentiment",         invert:false },
  { id:"DTWEXBGS",   name:"Trade-weighted USD (broad)",       invert:true },
];

// Add more to reach ~50 (kept, but some can be flaky via free proxies)
const FULL_EXTRA = [
  { id:"PAYEMS", name:"Nonfarm payrolls", invert:false },
  { id:"CSUSHPINSA", name:"Case-Shiller HPI", invert:false },
  { id:"MORTGAGE30US", name:"30y mortgage rate", invert:true },
  { id:"DCOILWTICO", name:"WTI crude", invert:true },
  { id:"GOLDAMGBD228NLBM", name:"Gold (London AM USD)", invert:true },
  { id:"NASDAQCOM", name:"NASDAQ Composite", invert:false },
  { id:"WILL5000INDFC", name:"Wilshire 5000", invert:false },
  { id:"AAA", name:"Moody’s AAA yield", invert:true },
  { id:"BAA", name:"Moody’s BAA yield", invert:true },
  { id:"BAA10Y", name:"BAA – 10Y spread", invert:true },
  { id:"TB3MS", name:"3-mo T-Bill", invert:true },
  { id:"DGS2", name:"2Y Treasury", invert:true },
  { id:"CP3M", name:"Commercial paper 3m", invert:true },
  { id:"H8B1058NCBCMG", name:"Bank credit (wkly)", invert:true },
  { id:"TOTALSA", name:"Light vehicle sales", invert:false },
  { id:"PPIACO", name:"PPI all commodities", invert:true },
  { id:"BUSLOANS", name:"C&I loans", invert:true },
  { id:"IC4WSA", name:"Initial claims (4wk avg)", invert:true },
  { id:"CCSA", name:"Continued claims", invert:true },
  { id:"DSPIC96", name:"Real disposable income", invert:false },
  { id:"NAPM", name:"ISM Manufacturing PMI", invert:true },
  { id:"NAPMS", name:"ISM Services PMI", invert:true },
  { id:"T5YIE", name:"5Y TIPS breakeven", invert:true },
  { id:"T10YIE", name:"10Y TIPS breakeven", invert:true },
  { id:"BAMLCC0A0CM", name:"IG OAS", invert:true },
];
const FULL = [...CORE, ...FULL_EXTRA];

/* =================== UTILITIES =================== */
const $ = s => document.querySelector(s);
const log = m => { const el=$("#log"); el.textContent += (el.textContent? "\n":"") + m; el.scrollTop = el.scrollHeight; };
const setCRC = (t,c) => { const el=$("#crc"); el.textContent=t; el.className="badge "+c; };
const fredURL = (id,k)=>`https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${k}&file_type=json`;

function proxyList(url){
  return [
    `https://cors.isomorphic-git.org/${url}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://thingproxy.freeboard.io/fetch/${url}`,
    `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(url)}`,
  ];
}

// race all proxies for the same URL; abort losers when one wins
async function fetchJSONRace(url){
  const controllers = [];
  const mk = (pUrl)=>new Promise(async (resolve, reject)=>{
    const ctl = new AbortController(); controllers.push(ctl);
    try{
      const r = await fetch(pUrl, { signal: ctl.signal, cache:"no-store" });
      if(!r.ok) return reject(new Error(`HTTP ${r.status}`));
      const txt = await r.text();
      try{ resolve({ data: JSON.parse(txt), proxy: new URL(pUrl).host }); }
      catch{ reject(new Error("Bad JSON")); }
    }catch(e){ reject(e); }
  });

  // timeout wrapper
  const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), REQ_TIMEOUT_MS));

  try{
    const res = await Promise.any([timeout, ...proxyList(url).map(mk)]);
    // abort all other in-flight requests
    controllers.forEach(c=>{ try{c.abort();}catch{} });
    return res;
  }catch(e){
    controllers.forEach(c=>{ try{c.abort();}catch{} });
    throw e;
  }
}

function pctRank(sample, x){
  if(sample.length===0) return NaN;
  let below=0, equal=0;
  for(const v of sample){ if(v<x) below++; else if(v===x) equal++; }
  return ((below + 0.5*equal)/sample.length)*100;
}
function last10Y(obs){
  const cut = new Date(); cut.setFullYear(cut.getFullYear()-YEARS_BACK);
  return obs.filter(o => new Date(o.date) >= cut);
}
function fmt(x){ return (x===null||x===undefined) ? "—" : (Math.abs(x)>=1000 ? x.toLocaleString() : x.toString()); }

/* =========== PARALLEL FETCH WITH CONCURRENCY =========== */
async function mapPool(items, limit, worker){
  const out = Array(items.length);
  let i=0, active=0, done=0;
  return await new Promise((resolve)=>{
    const runNext = ()=>{
      if(done===items.length) return resolve(out);
      while(active<limit && i<items.length){
        const idx=i++, item=items[idx]; active++;
        (async()=>{
          try{ out[idx]=await worker(item, idx); }
          catch(e){ out[idx]={error:e.message}; }
          active--; done++; runNext();
        })();
      }
    };
    runNext();
  });
}

/* =================== MAIN =================== */
async function fetchSeriesLatest(series, key){
  const url = fredURL(series.id, key);
  const { data, proxy } = await fetchJSONRace(url);
  // parse & window
  const all = (data.observations||[])
    .map(o => ({ date:o.date, v:o.value==="."? NaN : parseFloat(o.value) }))
    .filter(x => Number.isFinite(x.v));
  const win = (last10Y(all).length>=6 ? last10Y(all) : all);
  if(win.length<6) throw new Error("insufficient data");
  const latest = win[win.length-1];
  const sample = win.slice(0,-1).map(x=>x.v);
  let p = pctRank(sample, latest.v);            // 0..100
  if(!series.invert) p = 100 - p;               // flip if higher=safer
  const score = Math.max(0, Math.min(100, Math.round(p)));
  return { ok:true, id:series.id, name:series.name, val:latest.v, date:latest.date, score, proxy };
}

async function run(){
  const key = ($("#fredKey").value || DEFAULT_KEY).trim();
  $("#fredKey").value = key;
  $("#tbl tbody").innerHTML = "";
  $("#log").textContent = "";
  setCRC("CRC: Loading…","x");

  const SCOPE = ($("#scope").value==="full" || USE_ALL_50) ? FULL : CORE;
  log(`Fetching ${SCOPE.length} indicators (concurrency ${CONCURRENCY})`);

  const results = await mapPool(SCOPE, CONCURRENCY, async (s)=>{
    try{
      const r = await fetchSeriesLatest(s, key);
      log(`✓ ${s.id} via ${r.proxy}`);
      return r;
    }catch(e){
      log(`× ${s.id}: ${e.message}`);
      return { ok:false, id:s.id, name:s.name, val:"—", date:"—", score:"—", proxy:"—", err:e.message };
    }
  });

  // table
  const tb = $("#tbl tbody");
  const scores = [];
  for(const r of results){
    if(r.ok) scores.push(r.score);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}${r.ok?"":` <span class="muted small">(${r.err})</span>`}</td>
      <td><span class="chip">${r.id}</span></td>
      <td class="right">${r.val==="—"?"—":fmt(r.val)}</td>
      <td>${r.date}</td>
      <td class="right">${r.score==="—"?"—":r.score}</td>
      <td>${r.proxy||"—"}</td>
    `;
    tb.appendChild(tr);
  }

  if(!scores.length){
    setCRC("CRC: ERROR (no data)","r");
    log("No usable series (proxy throttling or key issue).");
    return;
  }
  const comp = Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
  const cls = comp<40 ? "g" : (comp<=70 ? "a" : "r");
  setCRC(`CRC: ${comp} — ${cls==="g"?"GREEN":cls==="a"?"AMBER":"RED"}`, cls);
  log("Done.");
}

/* Wire-up */
document.addEventListener("DOMContentLoaded", ()=>{
  $("#fredKey").value = DEFAULT_KEY;
  $("#scope").value = USE_ALL_50 ? "full" : "core";
  run();
});
$("#run").addEventListener("click", run);
</script>
</body>
</html>

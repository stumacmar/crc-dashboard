<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Crash RAG Composite (U.S.)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --green:#1f9d55; --amber:#f59e0b; --red:#e11d48; --bg:#0b1020; --card:#131a33; --fg:#e8eefb; --muted:#9fb0d8;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
  header{padding:20px 24px;border-bottom:1px solid #22283f;display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  header h1{font-size:20px;margin:0}
  .light{border-radius:999px;padding:6px 12px;font-weight:700}
  .green{background:color-mix(in oklab, var(--green) 25%, transparent);border:1px solid var(--green);color:#d7fff0}
  .amber{background:color-mix(in oklab, var(--amber) 25%, transparent);border:1px solid var(--amber);color:#fff4d6}
  .red{background:color-mix(in oklab, var(--red) 25%, transparent);border:1px solid var(--red);color:#ffe4ea}
  .wrap{padding:18px;display:grid;gap:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
  .card{background:var(--card);border:1px solid #1d2442;border-radius:12px;padding:16px}
  .title{font-weight:600;color:#cfe1ff;margin-bottom:10px}
  .note{font-size:12px;color:var(--muted)}
  .meter{height:10px;background:#101632;border-radius:6px;overflow:hidden;margin-top:8px}
  .bar{height:100%}
  .kpi{display:flex;justify-content:space-between;margin-top:6px;font-size:12px;color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  button{cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>Crash RAG Composite — United States</h1>
  <span id="crcBadge" class="light amber">CRC: Loading…</span>
  <span class="small">Powered by FRED API (live). Paste your key below.</span>
</header>

<div class="wrap">
  <div class="card">
    <div class="title">API key</div>
    <input id="fredKey" placeholder="YOUR_FRED_API_KEY" style="width:320px;max-width:100%;padding:8px;border-radius:8px;border:1px solid #2a3560;background:#0d1531;color:#cfe1ff" />
    <button id="go" style="margin-left:8px;padding:8px 12px;border-radius:8px;border:1px solid #2a3560;background:#1d2750;color:#fff">Run / Refresh</button>
    <div class="note" style="margin-top:6px">Get a free key at FRED → My Account → API. Data: FRED/St. Louis Fed, Chicago Fed, ICE BofA, UMich.</div>
  </div>

  <div class="grid" id="pillarGrid"></div>
  <div class="grid" id="tileGrid"></div>

  <div class="card">
    <div class="title">Notes & thresholds</div>
    <div class="note">
      • Risk = latest value’s percentile vs last 10y (z/pctile). Higher percentile = more crash risk (inverted where needed).<br/>
      • RAG: Green &lt;40th, Amber 40–70th, Red &gt;70th.<br/>
      • Override: if (10y–3m inverted) &amp; (HY OAS &gt; median) &amp; (claims trend worsening) ⇒ floor CRC at Amber.
    </div>
  </div>

  <div class="small">Educational only; not financial advice.</div>
</div>

<script>
const INDICATORS = [
  { id:"T10Y3M", name:"10y–3m spread", invert:true, pillar:"Credit & Liquidity", fred:"T10Y3M" },
  { id:"T10Y2Y", name:"10y–2y spread", invert:true, pillar:"Credit & Liquidity", fred:"T10Y2Y" },
  { id:"HY_OAS", name:"HY OAS", invert:true, pillar:"Credit & Liquidity", fred:"BAMLH0A0HYM2" },
  { id:"NFCI", name:"Chicago Fed NFCI", invert:true, pillar:"Credit & Liquidity", fred:"NFCI" },
  { id:"ICSA", name:"Initial Claims", invert:true, pillar:"Labor", fred:"ICSA", transform:"ma13_vs_ma52" },
  { id:"JTSJOL", name:"Job Openings", invert:false, pillar:"Labor", fred:"JTSJOL" },
  { id:"PERMIT", name:"Building Permits", invert:true, pillar:"Housing", fred:"PERMIT", transform:"yoy_neg" },
  { id:"MORT", name:"30y Mortgage rate", invert:true, pillar:"Housing", fred:"MORTGAGE30US" },
  { id:"NEWORDER", name:"Core Capex Orders", invert:true, pillar:"Growth/Capex", fred:"NEWORDER", transform:"yoy_neg" },
  { id:"DGORDER", name:"Durable Goods Orders", invert:true, pillar:"Growth/Capex", fred:"DGORDER", transform:"yoy_neg" },
  { id:"UMCSENT", name:"UMich Sentiment", invert:true, pillar:"Sentiment", fred:"UMCSENT" },
  { id:"VIXCLS", name:"VIX", invert:true, pillar:"Market Stress", fred:"VIXCLS" }
];

const PILLAR_WEIGHTS = {
  "Growth/Capex":0.20,"Labor":0.20,"Housing":0.15,"Credit & Liquidity":0.20,"Market Stress":0.15,"Sentiment":0.10
};
const HISTORY_YEARS=10;
const FRED_BASE="https://api.stlouisfed.org/fred/series/observations";

const $=sel=>document.querySelector(sel);
const tileGrid=$("#tileGrid"),pillarGrid=$("#pillarGrid"),crcBadge=$("#crcBadge");
$("#go").addEventListener("click",run);

async function run(){
  const key=$("#fredKey").value.trim(); if(!key){alert("Enter FRED API key");return;}
  tileGrid.innerHTML=""; pillarGrid.innerHTML=""; crcBadge.textContent="CRC: Loading…"; crcBadge.className="light amber";
  const end=new Date(); const start=new Date(); start.setFullYear(end.getFullYear()-HISTORY_YEARS);
  const params=d=>`?series_id=${d}&api_key=${key}&observation_start=${start.toISOString().slice(0,10)}&file_type=json`;
  const cache=new Map();
  async function fred(series){if(cache.has(series))return cache.get(series);const r=await fetch(`${FRED_BASE}${params(series)}`);const j=await r.json();cache.set(series,j);return j;}
  function parseObs(j){return j.observations.map(o=>({d:o.date,v:(o.value==="."?null:parseFloat(o.value))})).filter(o=>o.v!==null);}
  function mean(a){return a.reduce((s,x)=>s+x,0)/a.length;} function std(a){const m=mean(a);return Math.sqrt(mean(a.map(x=>(x-m)**2)));}
  function pctRank(a,x){const s=a.slice().sort((u,v)=>u-v);let lo=0,hi=s.length;while(lo<hi){const m=(lo+hi>>1);if(s[m]<=x)lo=m+1;else hi=m;}return lo/s.length;}
  function yoy(series){const out=[];for(let i=12;i<series.length;i++){const cur=series[i],prev=series[i-12];if(prev&&prev.v!==0)out.push({d:cur.d,v:(cur.v/prev.v-1)*100});}return out;}
  function ma(arr,k){const out=[];for(let i=0;i<arr.length;i++){const start=Math.max(0,i-k+1);const chunk=arr.slice(start,i+1).map(x=>x.v);out.push({d:arr[i].d,v:mean(chunk)});}return out;}

  const tiles=[];
  for(const ind of INDICATORS){
    let hist=parseObs(await fred(ind.fred));
    if(ind.transform==="yoy_neg") hist=yoy(hist);
    if(ind.transform==="ma13_vs_ma52"){const m13=ma(hist,13),m52=ma(hist,52);const map52=new Map(m52.map(o=>[o.d,o.v]));hist=m13.filter(o=>map52.has(o.d)).map(o=>({d:o.d,v:o.v-map52.get(o.d)}));ind.invert=true;}
    const vals=hist.map(o=>o.v),last=vals.at(-1),base=vals.slice(0,-1);
    let p=pctRank(base,last); if(!ind.invert)p=1-p;
    const rag=p>0.70?"red":p>0.40?"amber":"green"; tiles.push({ind,p,rag,last});
    const el=document.createElement("div"); el.className="card"; el.innerHTML=`
      <div class="title">${ind.name}</div>
      <div class="meter"><div class="bar" style="width:${Math.round(p*100)}%;background:${rag==='red'?'var(--red)':rag==='amber'?'var(--amber)':'var(--green)'}"></div></div>
      <div class="kpi"><span>Risk percentile</span><span>${(p*100).toFixed(0)}%</span></div>
    `; tileGrid.appendChild(el);
  }
  const pillars={}; for(const t of tiles){(pillars[t.ind.pillar]??=[]).push(t.p);}
  let crc=0; for(const [k,arr] of Object.entries(pillars)){const score=mean(arr),w=PILLAR_WEIGHTS[k]||0;crc+=score*w;const rag=score>0.70?"red":score>0.40?"amber":"green";const el=document.createElement("div");el.className="card";el.innerHTML=`
    <div class="title">${k}</div>
    <div class="meter"><div class="bar" style="width:${Math.round(score*100)}%;background:${rag==='red'?'var(--red)':rag==='amber'?'var(--amber)':'var(--green)'}"></div></div>
    <div class="kpi"><span>Avg risk percentile</span><span>${(score*100).toFixed(0)}%</span></div>
  `; pillarGrid.appendChild(el);}
  const rag=crc>0.70?"red":crc>0.40?"amber":"green"; crcBadge.textContent=`CRC: ${rag.toUpperCase()} (${(crc*100|0)}% riskile)`; crcBadge.className=`light ${rag}`;
}
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Crash RAG Composite — Debug</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{margin:0;font-family:system-ui,Arial;background:#0b1020;color:#e8eefb}
  header{padding:16px;border-bottom:1px solid #22283f;text-align:center}
  h1{margin:0;font-size:22px}
  .wrap{max-width:820px;margin:0 auto;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:12px 0}
  input{padding:8px 10px;border-radius:7px;border:1px solid #2a3560;background:#0d1531;color:#cfe1ff;min-width:300px}
  .btn{padding:8px 14px;border-radius:7px;border:1px solid #2a3560;background:#1d2750;color:#fff;cursor:pointer}
  .crc{display:inline-block;padding:16px 28px;border-radius:12px;font-weight:700;margin:10px auto}
  .loading{background:#444;color:#ff0}
  .green{background:#046b3b}.amber{background:#a86700}.red{background:#7d1020}
  #log{background:#131a33;border:1px solid #1d2442;border-radius:10px;padding:12px;min-height:140px;white-space:pre-wrap}
</style>
</head>
<body>
<header><h1>Crash RAG Composite — Debug</h1></header>
<div class="wrap">
  <div class="row">
    <input id="key" placeholder="FRED API key">
    <button id="go" class="btn">Run / Refresh</button>
  </div>
  <div id="crc" class="crc loading">CRC: Waiting…</div>
  <div id="log"></div>
</div>

<script>
/* === CONFIG === */
const DEFAULT_KEY = "b78d7171c0fc257622597099f88fa7f7"; // your key
const SERIES = ["UNRATE","CPIAUCSL","SP500","T10Y2Y"];    // small set for debug
const FRED_URL = (id, key) =>
  `https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${key}&file_type=json`;

// CORS proxy that returns raw response body
const PROXY = "https://api.allorigins.win/raw?url=";

/* === UTIL === */
const $ = s => document.querySelector(s);
const log = msg => { const el=$("#log"); el.textContent += (el.textContent? "\n":"") + msg; el.scrollTop = el.scrollHeight; };
const setCRC = (txt, cls) => { const el=$("#crc"); el.textContent = txt; el.className = "crc " + cls; };

/* === FETCH via proxy === */
async function fetchJSON(url) {
  const proxied = PROXY + encodeURIComponent(url);
  const res = await fetch(proxied, { cache:"no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  try { return JSON.parse(text); } catch(e){ throw new Error("Bad JSON from proxy/FRED"); }
}

/* === MAIN === */
async function runCRC(){
  const key = ($("#key").value || DEFAULT_KEY).trim();
  $("#key").value = key;
  $("#log").textContent = "";
  setCRC("CRC: Loading…","loading");
  log("Starting…");
  log("Using key: " + (key.length===32 ? "[OK 32 chars]" : `[len ${key.length}]`));

  const values = [];
  for (const id of SERIES){
    try{
      const url = FRED_URL(id, key);
      log(`Fetching ${id} …`);
      const data = await fetchJSON(url);
      const obs = data.observations || [];
      const last = obs[obs.length-1];
      if(!last || last.value===".") throw new Error("No numeric last value");
      const val = parseFloat(last.value);
      log(`  ✅ ${id} latest = ${val} (${last.date})`);
      values.push(val);
    }catch(e){
      log(`  ❌ ${id} error: ${e.message}`);
    }
  }

  if(values.length===0){
    setCRC("CRC: Error (no data)","red");
    log("No data available — check proxy reachability or key.");
    return;
  }

  const avg = values.reduce((a,b)=>a+b,0)/values.length;
  if (avg < 50) setCRC("CRC: GREEN","green");
  else if (avg < 150) setCRC("CRC: AMBER","amber");
  else setCRC("CRC: RED","red");

  log("Done.");
}

document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("fred_key");
  $("#key").value = saved || DEFAULT_KEY;
});
$("#go").addEventListener("click", () => {
  const k = ($("#key").value||"").trim();
  if (k) localStorage.setItem("fred_key", k);
  runCRC();
});
</script>
</body>
</html>
